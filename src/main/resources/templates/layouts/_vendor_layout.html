<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title layout:title-pattern="$CONTENT_TITLE | Vendor Portal">UTE GiftShop</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            position: fixed; top: 0; bottom: 0; left: 0; z-index: 100;
            width: 250px; padding: 48px 0 0; box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #fff;
        }
        .sidebar-sticky { padding: 1rem; }
        .sidebar .nav-link {
            font-weight: 500; color: #333; border-radius: 0.375rem; margin-bottom: 0.25rem;
            display: flex; align-items: center;
        }
        .sidebar .nav-link .bi { margin-right: 10px; width: 20px; flex-shrink: 0; }
        .sidebar .nav-link.active { color: #fff; background-color: #0d6efd; }
        .sidebar .nav-link:hover { background-color: #e9ecef; }
        .sidebar .nav-link.active:hover { background-color: #0b5ed7; }
        .vendor-header {
            position: fixed; top: 0; right: 0; left: 250px; z-index: 99; height: 48px;
            background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,.08);
            display: flex; align-items: center; justify-content: flex-end; padding: 0 1.5rem;
        }
        .main-content { margin-left: 250px; padding: 68px 1.5rem 1.5rem; }

        /* Hide vendor links initially - SỬA: Dùng class thay vì !important */
        .vendor-link { display: none; }
        .vendor-link.show { display: block !important; }

        /* CSS Chatbot */
        .chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 1050; }
        .chat-btn { width: 60px; height: 60px; border-radius: 50%; font-size: 28px; box-shadow: 0 4px 8px rgba(0,0,0,.2); }
        .chat-popup { display: none; position: fixed; bottom: 90px; right: 20px; width: 350px; max-height: 500px; background: #fff; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,.3); flex-direction: column; overflow: hidden; }
        .chat-header { background: #0d6efd; color: white; padding: 1rem; font-weight: bold; }
        .chat-body { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-message { padding: 8px 12px; border-radius: 18px; max-width: 80%; word-wrap: break-word; }
        .user-message { background: #e9ecef; align-self: flex-end; }
        .bot-message { background: #0d6efd; color: white; align-self: flex-start; }
        .chat-footer { border-top: 1px solid #eee; padding: 0.5rem; display: flex; }
        .chat-footer input { flex: 1; border: none; outline: none; box-shadow: none; }
    </style>
    <th:block layout:fragment="styles"></th:block>
    <th:block layout:fragment="scripts_head"></th:block>
</head>
<body>

    <header class="vendor-header">
        <div class="dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle fs-5"></i> <span id="userGreeting">Tài khoản</span>
            </a>
            <ul id="user-menu" class="dropdown-menu dropdown-menu-end"></ul>
        </div>
    </header>

    <nav class="sidebar">
        <div class="sidebar-sticky">
            <h5 class="px-3 pt-2 pb-1 mb-2 text-primary border-bottom">
                <i class="bi bi-shop-window"></i> Vendor Portal
            </h5>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/home}">
                       <i class="bi bi-arrow-left-circle"></i> Quay lại Trang chủ
                   </a>
                </li>

                <li class="nav-item vendor-link" id="register-shop-link">
                    <a class="nav-link" th:href="@{/vendor/register}"
                       th:classappend="${activePage == 'register' ? 'active' : ''}">
                        <i class="bi bi-clipboard-plus-fill"></i> Đăng ký Cửa hàng
                    </a>
                </li>

                <li class="nav-item vendor-link" id="dashboard-link">
                    <a class="nav-link" th:href="@{/vendor/dashboard}"
                       th:classappend="${activePage == 'dashboard' ? 'active' : ''}">
                        <i class="bi bi-grid-fill"></i> Tổng quan
                    </a>
                </li>
                <li class="nav-item vendor-link" id="manage-shop-link">
                    <a class="nav-link" th:href="@{/vendor/shop}"
                       th:classappend="${activePage == 'shop' ? 'active' : ''}">
                        <i class="bi bi-gear-fill"></i> Quản lý Cửa hàng
                    </a>
                </li>
                <li class="nav-item vendor-link" id="products-link">
                    <a class="nav-link" th:href="@{/vendor/products}"
                       th:classappend="${activePage == 'products' ? 'active' : ''}">
                        <i class="bi bi-box-seam-fill"></i> Quản lý Sản phẩm
                    </a>
                </li>
                <li class="nav-item vendor-link" id="orders-link">
                    <a class="nav-link" th:href="@{/vendor/orders}"
                       th:classappend="${activePage == 'orders' ? 'active' : ''}">
                        <i class="bi bi-list-task"></i> Quản lý Đơn hàng
                    </a>
                </li>
                 <li class="nav-item vendor-link" id="promotions-link">
                    <a class="nav-link" th:href="@{/vendor/promotions}"
                       th:classappend="${activePage == 'promotions' ? 'active' : ''}">
                        <i class="bi bi-tags-fill"></i> Quản lý Khuyến mãi
                    </a>
                </li>
                <li class="nav-item vendor-link" id="stats-link">
                    <a class="nav-link" th:href="@{/vendor/stats}"
                       th:classappend="${activePage == 'stats' ? 'active' : ''}">
                        <i class="bi bi-graph-up"></i> Thống kê Doanh thu
                    </a>
                </li>
                 <li class="nav-item vendor-link" id="reviews-link">
                    <a class="nav-link" th:href="@{/vendor/reviews}"
                       th:classappend="${activePage == 'reviews' ? 'active' : ''}">
                        <i class="bi bi-star-fill"></i> Quản lý Đánh giá
                    </a>
                </li>
                <li class="nav-item vendor-link" id="messages-link">
                    <a class="nav-link" th:href="@{/vendor/messages}"
                       th:classappend="${activePage == 'messages' ? 'active' : ''}">
                        <i class="bi bi-chat-dots-fill"></i> Tương tác Khách hàng
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <th:block layout:fragment="content"></th:block>
    </main>

    <div class="chat-widget">
        <button class="btn btn-primary chat-btn" id="toggle-chat-btn"> <i class="bi bi-chat-dots-fill"></i> </button>
        <div class="chat-popup" id="chat-popup">
            <div class="chat-header">UTE GiftShop Assistant</div>
            <div class="chat-body" id="chat-body">
                <div class="chat-message bot-message">Chào bạn! Tôi có thể giúp gì?</div>
            </div>
            <div class="chat-footer">
                <input type="text" class="form-control" id="chat-input" placeholder="Nhập tin nhắn...">
                <button class="btn btn-link" id="chat-send-btn"><i class="bi bi-send-fill"></i></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // === HÀM LOGOUT ===
        function logout() {
             localStorage.removeItem('jwtToken');
             Swal.fire({ title: 'Đã đăng xuất', icon: 'success', timer: 1500, showConfirmButton: false })
                 .then(() => { window.location.href = '/login'; });
        }

        // === HÀM KIỂM TRA LOGIN VÀ LẤY THÔNG TIN USER ===
        async function checkVendorLoginStatus() {
             const token = localStorage.getItem('jwtToken');
             const userGreetingElem = document.getElementById('userGreeting');
             const userMenu = document.getElementById('user-menu');

             if (!userGreetingElem || !userMenu) {
                 console.error("Lỗi nghiêm trọng: Không tìm thấy element userGreeting hoặc userMenu.");
                 document.body.innerHTML = '<div class="alert alert-danger m-5">Lỗi giao diện nghiêm trọng. Vui lòng thử lại hoặc liên hệ hỗ trợ.</div>';
                 return;
             }

             if (!token) {
                 console.log("Không có token, chuyển về trang login.");
                 window.location.href = '/login';
                 return;
             }

             try {
                 console.log("Đang xác thực người dùng...");
                 const response = await fetch('/api/users/me', { headers: { 'Authorization': `Bearer ${token}` } });
                 console.log("API /api/users/me response status:", response.status);

                 if (!response.ok) {
                     if (response.status === 401 || response.status === 403) {
                         console.error("Token không hợp lệ hoặc hết hạn. Đang logout...");
                         logout();
                     } else {
                         const errorText = await response.text();
                         console.error(`Lỗi server (${response.status}) khi gọi /api/users/me: ${errorText}`);
                         throw new Error(`Lỗi ${response.status} khi lấy thông tin người dùng.`);
                     }
                     return;
                 }

                 const userInfo = await response.json();
                 console.log("Thông tin user nhận được:", userInfo);

                 if (userInfo && userInfo.authenticated && userInfo.role === 'Vendor') {
                     console.log("User được xác thực là Vendor.");
                     userGreetingElem.textContent = `Chào, ${userInfo.fullName || userInfo.email}`;
                     userMenu.innerHTML = `
                         <li><a class="dropdown-item" href="/profile"><i class="bi bi-person-circle me-2"></i>Thông tin cá nhân</a></li>
                         <li><a class="dropdown-item" href="/home"><i class="bi bi-house-door-fill me-2"></i>Trang chủ UTEGiftShop</a></li>
                         <li><hr class="dropdown-divider"></li>
                         <li><button class="dropdown-item" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</button></li>
                     `;
                     await checkShopStatusAndControlUI();
                 } else {
                     console.error("User không được xác thực hoặc không phải Vendor:", userInfo);
                      Swal.fire('Lỗi', 'Tài khoản không hợp lệ hoặc không có quyền truy cập Vendor Portal.', 'error')
                         .then(() => { logout(); });
                 }
             } catch (error) {
                 console.error("Lỗi trong quá trình checkVendorLoginStatus:", error);
                 Swal.fire('Lỗi', `Đã xảy ra lỗi: ${error.message}. Vui lòng đăng nhập lại.`, 'error')
                    .then(() => { logout(); });
             }
        }

        // === HÀM KIỂM TRA TRẠNG THÁI SHOP (ĐÃ SỬA - DÙNG CLASS) ===
        async function checkShopStatusAndControlUI() {
            const token = localStorage.getItem('jwtToken');
            if (!token) { console.error("checkShopStatus called without token."); return; }

            const vendorLinks = document.querySelectorAll('.vendor-link');
            const currentPath = window.location.pathname;

            // Helper functions - SỬA: Dùng classList thay vì style.display
            const showElementById = (id) => {
                const el = document.getElementById(id);
                if(el) el.classList.add('show');
            }
            const hideElementById = (id) => {
                const el = document.getElementById(id);
                if(el) el.classList.remove('show');
            }

            // Default: Hide all vendor links
            vendorLinks.forEach(link => link.classList.remove('show'));
            console.log("Initial state: All vendor links hidden.");

            try {
                console.log("Checking shop status via API...");
                const response = await fetch('/api/vendor/shop/status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                console.log("API /api/vendor/shop/status responded with status:", response.status);

                if (!response.ok) {
                    let errorMsg = `Lỗi ${response.status} khi kiểm tra trạng thái shop.`;
                    try {
                        const errorData = await response.json();
                        errorMsg += `: ${errorData.message || 'Không rõ nguyên nhân'}`;
                    } catch (e) { errorMsg += '. Phản hồi không hợp lệ.'; }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                const shopStatus = data ? data.status : null;
                console.log("Shop status received:", shopStatus);

                // *** CHUẨN HÓA TRẠNG THÁI ***
                let normalizedStatus = shopStatus;
                if (shopStatus) {
                    const statusUpper = shopStatus.toString().toUpperCase();
                    // Map các trạng thái tiếng Việt sang tiếng Anh
                    if (statusUpper === 'ĐÃ DUYỆT' || statusUpper === 'DA DUYET') {
                        normalizedStatus = 'ACTIVE';
                    } else if (statusUpper === 'CHỜ DUYỆT' || statusUpper === 'CHO DUYET') {
                        normalizedStatus = 'PENDING';
                    } else if (statusUpper === 'TỪ CHỐI' || statusUpper === 'TU CHOI') {
                        normalizedStatus = 'REJECTED';
                    } else {
                        normalizedStatus = statusUpper;
                    }
                }
                console.log("Normalized status:", normalizedStatus);

                // --- Main Logic based on Status ---
                switch (normalizedStatus) {
                    case 'ACTIVE':
                        console.log("Shop is ACTIVE. Showing main vendor links.");
                        // Show all links EXCEPT register link - SỬA: Dùng classList
                        vendorLinks.forEach(link => {
                             if(link.id !== 'register-shop-link') {
                                 link.classList.add('show');
                             } else {
                                 link.classList.remove('show');
                             }
                        });

                        // Redirect if user is on register page but shop is active
                        if (currentPath === '/vendor/register') {
                            console.log("Redirecting active vendor from register page to dashboard.");
                            window.location.replace('/vendor/dashboard');
                        }
                        if (typeof displayShopStatus === 'function') {
                             displayShopStatus(normalizedStatus);
                         }
                        break;

                    case 'PENDING':
                    case 'REJECTED':
                        console.log(`Shop status is ${normalizedStatus}. Redirecting/showing status message.`);
                        hideElementById('register-shop-link');

                         if (typeof displayShopStatus === 'function' && currentPath === '/vendor/register') {
                            displayShopStatus(normalizedStatus);
                         }
                         else if (currentPath !== '/vendor/register') {
                             console.log(`Redirecting to register page to show ${normalizedStatus} status.`);
                             window.location.replace('/vendor/register');
                         }
                        break;

                    case 'NOT_FOUND':
                        console.log("Shop NOT_FOUND. Showing register link.");
                        showElementById('register-shop-link');

                         if (typeof displayShopStatus === 'function' && currentPath === '/vendor/register') {
                             displayShopStatus(normalizedStatus);
                         }
                        else if (currentPath !== '/vendor/register') {
                            console.log("Redirecting to register page for shop registration.");
                            window.location.replace('/vendor/register');
                        }
                        break;

                    default:
                        console.error("Unknown or invalid shop status received:", shopStatus, "normalized to:", normalizedStatus);
                        Swal.fire('Lỗi', `Trạng thái cửa hàng không xác định (${shopStatus || 'null'}).`, 'error');
                        vendorLinks.forEach(link => link.classList.remove('show'));
                        break;
                }

            } catch (error) {
                console.error("Error in checkShopStatusAndControlUI:", error);
                Swal.fire('Lỗi', `Không thể kiểm tra trạng thái cửa hàng: ${error.message}`, 'error');
                vendorLinks.forEach(link => link.classList.remove('show'));
            }
        }

        // === INITIAL CALL ===
        document.addEventListener('DOMContentLoaded', checkVendorLoginStatus);

    </script>

    <th:block layout:fragment="scripts_body"></th:block>

    <script>
        // === CHATBOT CODE ===
        const chatPopup = document.getElementById('chat-popup');
        const toggleChatBtn = document.getElementById('toggle-chat-btn');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatBody = document.getElementById('chat-body');
        let isChatbotInitialized = false;

        if(toggleChatBtn) toggleChatBtn.addEventListener('click', () => {
            if (chatPopup && chatPopup.style.display === 'flex') {
                chatPopup.style.display = 'none';
            } else {
                const token = localStorage.getItem('jwtToken');
                if (!token && !isChatbotInitialized) {
                    Swal.fire('Vui lòng đăng nhập', 'Bạn cần đăng nhập để sử dụng trợ lý ảo.', 'info')
                        .then(() => window.location.href = '/login');
                    return;
                }
                isChatbotInitialized = true;
                if(chatPopup) chatPopup.style.display = 'flex';
            }
        });

        if(chatSendBtn) chatSendBtn.addEventListener('click', sendMessage);
        if(chatInput) chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { sendMessage(); }
        });

        async function sendMessage() {
            if(!chatInput || !chatBody) return;
            const messageText = chatInput.value.trim();
            if (messageText === '') return;
            const token = localStorage.getItem('jwtToken');
            if (!token) { Swal.fire('Lỗi', 'Phiên đăng nhập đã hết hạn.', 'error'); return; }
            addMessageToChat(messageText, 'user');
            chatInput.value = '';
            addMessageToChat('...', 'bot-typing');
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText })
                });
                removeTypingIndicator();
                if (response.ok) {
                    const chatResponse = await response.json();
                    addMessageToChat(chatResponse.reply, 'bot');
                } else { addMessageToChat('Xin lỗi, đã có lỗi xảy ra.', 'bot'); }
            } catch (error) { removeTypingIndicator(); addMessageToChat('Lỗi kết nối.', 'bot'); }
        }

        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(m) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
            });
        }

        function formatBotMessage(text) {
            let escapedText = escapeHTML(text);
            let formattedText = escapedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedText = formattedText.replace(/\\\*\\\*(.*?)\\\*\\\*/g, '<strong>$1</strong>');
            formattedText = formattedText.replace(/\n/g, '<br>');
            return formattedText;
        }

        function addMessageToChat(text, type) {
            const messageDiv = document.createElement('div');
            if(type === 'user') {
                messageDiv.className = 'chat-message user-message';
                messageDiv.textContent = text;
            } else if (type === 'bot') {
                messageDiv.className = 'chat-message bot-message';
                messageDiv.innerHTML = formatBotMessage(text);
            } else if (type === 'bot-typing') {
                messageDiv.className = 'chat-message bot-message';
                messageDiv.id = 'bot-typing-indicator';
                messageDiv.textContent = text;
            }
            if(chatBody) {
                chatBody.appendChild(messageDiv);
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        function removeTypingIndicator() {
            const ind = document.getElementById('bot-typing-indicator');
            if(ind && chatBody) {
                try { chatBody.removeChild(ind); } catch(e) {}
            }
        }
    </script>
</body>
</html>