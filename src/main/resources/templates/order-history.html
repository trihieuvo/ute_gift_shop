<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Lịch sử đơn hàng</title>
    <style>
        /* Thêm CSS này */
        .action-buttons-cell {
            display: flex; /* Sử dụng flexbox */
            flex-wrap: wrap; /* Cho phép xuống hàng nếu cần */
            gap: 0.25rem; /* Khoảng cách nhỏ giữa các nút */
            align-items: center; /* Căn giữa các nút theo chiều dọc */
            min-width: 200px; /* Đặt chiều rộng tối thiểu để tránh bị bóp quá nhiều */
        }
        .action-buttons-cell .btn {
            flex-shrink: 0; /* Ngăn nút bị co lại */
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <h1 class="mb-4">Lịch sử đơn hàng</h1>

    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th scope="col">Mã ĐH</th>
                <th scope="col">Ngày đặt</th>
                <th scope="col">Địa chỉ</th>
                <th scope="col">Tổng tiền</th>
                <th scope="col">Trạng thái</th>
                <th scope="col">Hành động</th>
            </tr>
        </thead>
        <tbody id="orders-table-body">
            <tr><td colspan="6" class="text-center p-5">Đang tải lịch sử đơn hàng...</td></tr>
        </tbody>
    </table>
</div>

<th:block layout:fragment="scripts_body">
    <script>
        // Không cần khởi tạo modal ở đây nữa vì nó nằm trong layout

        document.addEventListener('DOMContentLoaded', function() {
            // Sử dụng setTimeout để đảm bảo DOM (bao gồm cả layout) đã sẵn sàng
            setTimeout(() => {
                console.log("DOM fully loaded for order-history, fetching order history...");
                fetchOrderHistory();
            }, 0);
        });

        async function fetchOrderHistory() {
            const token = localStorage.getItem('jwtToken');
            const tableBody = document.getElementById('orders-table-body');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-5">Đang tải lịch sử đơn hàng...</td></tr>';

            try {
                const response = await fetch('/api/orders/my-history', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const orders = await response.json();
                    tableBody.innerHTML = '';

                    if (orders.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-5">Bạn chưa có đơn hàng nào.</td></tr>';
                        return;
                    }

                    orders.forEach(order => {
                        const row = tableBody.insertRow();
                        let statusText = order.status;
                        let statusBadge = 'bg-secondary'; // Default

                        switch (order.status) {
                            case 'NEW': statusText = 'Mới'; statusBadge = 'bg-info text-dark'; break;
                            case 'PENDING_PAYMENT': statusText = 'Chờ thanh toán QR'; statusBadge = 'bg-warning text-dark'; break;
                            case 'CONFIRMED': statusText = 'Đã xác nhận'; statusBadge = 'bg-primary'; break;
                            case 'PREPARING': statusText = 'Đang chuẩn bị'; statusBadge = 'bg-primary'; break;
                            case 'READY_FOR_SHIPMENT': statusText = 'Sẵn sàng giao'; statusBadge = 'bg-primary'; break;
                            case 'DELIVERING': statusText = 'Đang giao'; statusBadge = 'bg-warning text-dark'; break;
                            case 'DELIVERED': statusText = 'Đã giao thành công'; statusBadge = 'bg-success'; break;
                            case 'CANCELLED': statusText = 'Đã hủy'; statusBadge = 'bg-danger'; break;
                            case 'RETURN_PENDING': statusText = 'Chờ trả hàng'; statusBadge = 'bg-danger'; break;
                            case 'RETURNED': statusText = 'Đã trả hàng'; statusBadge = 'bg-dark'; break;
                        }

                        // === TẠO MẢNG CHỨA CÁC NÚT HÀNH ĐỘNG ===
                        const actionButtons = [];

                        // Nút Xem chi tiết (luôn có)
                        actionButtons.push(`<a href="/orders/${order.id}" class="btn btn-primary btn-sm">Xem chi tiết</a>`);

                        // Nút Đổi PTTT (chỉ khi NEW hoặc PENDING_PAYMENT)
                        const canChangePayment = order.status === 'NEW' || order.status === 'PENDING_PAYMENT';
                        if (canChangePayment) {
                            actionButtons.push(`
                                <button class="btn btn-warning btn-sm" onclick="showChangePaymentModal(${order.id}, '${order.paymentMethod}')">
                                    <i class="bi bi-pencil-square"></i> Đổi PTTT
                                </button>`);
                        }

                        // Nút Thanh toán ngay (chỉ khi PENDING_PAYMENT)
                        if (order.status === 'PENDING_PAYMENT' && order.paymentCode) {
                            actionButtons.push(`
                                <button class="btn btn-success btn-sm" onclick="goToPaymentPage(${order.id}, '${order.paymentCode}', ${order.totalAmount})">
                                    <i class="bi bi-qr-code"></i> Thanh toán ngay
                                </button>`);
                        }

                        // Nút Đánh giá (chỉ khi DELIVERED)
                        if (order.status === 'DELIVERED' && order.orderDetails && order.orderDetails.length > 0) {
                            const firstProductId = order.orderDetails[0].product?.id;
                            if (firstProductId) {
                                actionButtons.push(`
                                    <a href="/products/${firstProductId}" class="btn btn-info btn-sm">
                                        <i class="bi bi-star-fill"></i> Đánh giá
                                    </a>`);
                            } else {
                                console.warn(`Order ${order.id}: Could not get product ID for review button.`);
                            }
                        }
                        // Ghép các nút lại
                        const actionButtonsHtml = actionButtons.join('');
                        // === KẾT THÚC TẠO NÚT ===


                        row.innerHTML = `
                            <td>#${order.id}</td>
                            <td>${new Date(order.orderDate).toLocaleDateString('vi-VN')}</td>
                            <td>${order.shippingAddress}</td>
                            <td>${order.totalAmount.toLocaleString('vi-VN')} đ</td>
                            <td><span class="badge ${statusBadge}">${statusText}</span></td>
                            <td class="action-buttons-cell">${actionButtonsHtml}</td>
                        `;
                    });

                } else if (response.status === 401 || response.status === 403) {
                     Swal.fire('Lỗi', 'Không có quyền truy cập hoặc phiên đăng nhập hết hạn.', 'error').then(() => window.location.href = '/login');
                } else {
                     const errorText = await response.text();
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-5 text-danger">Lỗi tải lịch sử đơn hàng (${response.status}): ${errorText}</td></tr>`;
                }
            } catch (error) {
                 console.error("Lỗi mạng khi tải lịch sử:", error);
                 tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-5 text-danger">Lỗi kết nối mạng.</td></tr>';
            }
        }

        // *** THÊM HÀM MỚI ĐỂ CHUYỂN TRANG THANH TOÁN ***
        function goToPaymentPage(orderId, paymentCode, totalAmount) {
            console.log(`Navigating to payment for Order ${orderId}, Code: ${paymentCode}, Amount: ${totalAmount}`);
            // Lưu thông tin vào sessionStorage giống như khi checkout
            sessionStorage.setItem('paymentInfo', JSON.stringify({
                orderId: orderId,
                paymentCode: paymentCode,
                totalAmount: totalAmount
            }));
            // Chuyển hướng đến trang payment
            window.location.href = `/payment/${orderId}`;
        }
        // *** KẾT THÚC HÀM MỚI ***


        // Hàm hiển thị modal (modal HTML nằm trong layout _app_layout.html)
        // Đảm bảo hàm này là global (không nằm trong DOMContentLoaded)
        window.showChangePaymentModal = function(orderId, currentMethod) {
            console.log(`Attempting to show modal for order ${orderId}, current method ${currentMethod}`);
            const modalEl = document.getElementById('changePaymentModal'); // Modal này từ layout

            if (!modalEl) {
                console.error("CRITICAL ERROR: Modal element #changePaymentModal not found in layout DOM!");
                Swal.fire('Lỗi giao diện nghiêm trọng', 'Không tìm thấy cấu trúc cửa sổ.', 'error');
                return;
            }

            // Sử dụng getOrCreateInstance để đảm bảo an toàn
            const changePaymentModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);

            if (!changePaymentModalInstance) {
                console.error("Failed to get or create Bootstrap Modal instance!");
                 Swal.fire('Lỗi giao diện', 'Không thể khởi tạo cửa sổ.', 'error');
                 return;
            }

            const modalOrderIdSpan = document.getElementById('modalOrderId');
            const modalChangeOrderIdInput = document.getElementById('modalChangeOrderId');
            if(modalOrderIdSpan) modalOrderIdSpan.textContent = orderId;
            if(modalChangeOrderIdInput) modalChangeOrderIdInput.value = orderId;

            const currentMethodUpper = currentMethod.toUpperCase();
            let radioToCheck = document.querySelector(`input[name="newPaymentMethod"][value="${currentMethodUpper}"]`);

             if (!radioToCheck && currentMethodUpper === 'SEPAY_QR') {
                 radioToCheck = document.getElementById('newSepayQr');
             } else if (!radioToCheck && currentMethodUpper === 'COD') {
                 radioToCheck = document.getElementById('newCod');
             }

             // Handle PENDING_PAYMENT status correctly checking QR
             if (currentMethodUpper === 'PENDING_PAYMENT') {
                  radioToCheck = document.getElementById('newSepayQr');
             } else if (!radioToCheck) { // Default to COD if still not found
                 radioToCheck = document.getElementById('newCod');
                 console.warn(`Could not find radio for current method '${currentMethodUpper}', defaulting to COD.`);
             }


             if (radioToCheck) {
                 radioToCheck.checked = true;
             } else {
                 console.error("Could not find any payment method radio buttons!");
             }

            console.log("Showing modal instance from layout...");
            changePaymentModalInstance.show();
        }

        // Hàm xử lý khi nhấn nút Lưu thay đổi trong modal
        // Đảm bảo hàm này là global
        window.handleChangePaymentSubmit = async function() {
            const orderId = document.getElementById('modalChangeOrderId').value;
            const selectedPaymentRadio = document.querySelector('input[name="newPaymentMethod"]:checked');
            const saveButton = document.getElementById('savePaymentChangeBtn');

            const modalEl = document.getElementById('changePaymentModal'); // Modal từ layout
            // Lấy instance đang hiển thị (nếu có)
            const changePaymentModalInstance = modalEl ? bootstrap.Modal.getInstance(modalEl) : null;


            if (!selectedPaymentRadio) {
                Swal.fire('Lỗi', 'Vui lòng chọn phương thức thanh toán mới.', 'warning');
                return;
            }
            const newPaymentMethod = selectedPaymentRadio.value;

            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang lưu...';

            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/orders/${orderId}/change-payment`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPaymentMethod: newPaymentMethod })
                });

                const result = await response.json();

                if (response.ok) {
                    if (changePaymentModalInstance) changePaymentModalInstance.hide(); // Hide modal first

                    if (result.paymentMethod === 'SEPAY_QR' && result.paymentCode) {
                        sessionStorage.setItem('paymentInfo', JSON.stringify({
                            orderId: orderId,
                            paymentCode: result.paymentCode,
                            totalAmount: result.totalAmount
                        }));
                         Swal.fire('Thành công', result.message || 'Đổi PTTT thành công. Bạn sẽ được chuyển đến trang thanh toán QR.', 'success')
                         .then(() => {
                             window.location.href = `/payment/${orderId}`;
                         });

                    } else {
                         Swal.fire('Thành công', result.message || 'Đổi PTTT thành công!', 'success');
                         fetchOrderHistory(); // Reload table
                    }
                } else {
                    throw new Error(result.message || `Lỗi ${response.status}`);
                }
            } catch (error) {
                Swal.fire('Lỗi', `Không thể thay đổi phương thức thanh toán: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'Lưu thay đổi';
            }
        }
    </script>
</th:block>

</body>
</html>