<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Lịch sử đơn hàng</title>
</head>
<body>

<div layout:fragment="content">
    <h1 class="mb-4">Lịch sử đơn hàng</h1>

    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th scope="col">Mã ĐH</th>
                <th scope="col">Ngày đặt</th>
                <th scope="col">Địa chỉ</th>
                <th scope="col">Tổng tiền</th>
                <th scope="col">Trạng thái</th>
                <th scope="col">Hành động</th>
            </tr>
        </thead>
        <tbody id="orders-table-body">
            <tr><td colspan="6" class="text-center p-5">Đang tải lịch sử đơn hàng...</td></tr>
        </tbody>
    </table>
</div>

<th:block layout:fragment="scripts_body">
    <script>
        // No need to initialize modal instance here anymore

        document.addEventListener('DOMContentLoaded', function() {
            // Use setTimeout to ensure the layout DOM (including the modal) is fully ready
            // Although likely not strictly necessary now, it adds robustness
            setTimeout(() => {
                console.log("DOM fully loaded for order-history, fetching order history...");
                fetchOrderHistory();
            }, 0);
        });

        async function fetchOrderHistory() {
            const token = localStorage.getItem('jwtToken');
            const tableBody = document.getElementById('orders-table-body');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-5">Đang tải lịch sử đơn hàng...</td></tr>';

            try {
                const response = await fetch('/api/orders/my-history', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const orders = await response.json();
                    tableBody.innerHTML = '';

                    if (orders.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-5">Bạn chưa có đơn hàng nào.</td></tr>';
                        return;
                    }

                    orders.forEach(order => {
                        const row = tableBody.insertRow();
                        let statusText = order.status;
                        let statusBadge = 'bg-secondary'; // Default

                        switch (order.status) {
                            case 'NEW': statusText = 'Mới'; statusBadge = 'bg-info text-dark'; break;
                            case 'PENDING_PAYMENT': statusText = 'Chờ thanh toán QR'; statusBadge = 'bg-warning text-dark'; break;
                            case 'CONFIRMED': statusText = 'Đã xác nhận'; statusBadge = 'bg-primary'; break;
                            case 'PREPARING': statusText = 'Đang chuẩn bị'; statusBadge = 'bg-primary'; break;
                            case 'READY_FOR_SHIPMENT': statusText = 'Sẵn sàng giao'; statusBadge = 'bg-primary'; break;
                            case 'DELIVERING': statusText = 'Đang giao'; statusBadge = 'bg-warning text-dark'; break;
                            case 'DELIVERED': statusText = 'Đã giao thành công'; statusBadge = 'bg-success'; break;
                            case 'CANCELLED': statusText = 'Đã hủy'; statusBadge = 'bg-danger'; break;
                            case 'RETURN_PENDING': statusText = 'Chờ trả hàng'; statusBadge = 'bg-danger'; break;
                            case 'RETURNED': statusText = 'Đã trả hàng'; statusBadge = 'bg-dark'; break;
                        }

                        const canChangePayment = order.status === 'NEW' || order.status === 'PENDING_PAYMENT';
                        const changePaymentButtonHtml = canChangePayment ?
                            // *** IMPORTANT: Ensure showChangePaymentModal is globally accessible or defined here ***
                            `<button class="btn btn-warning btn-sm ms-1" onclick="showChangePaymentModal(${order.id}, '${order.paymentMethod}')">
                                <i class="bi bi-pencil-square"></i> Đổi PTTT
                            </button>`
                            : '';

                         // Add Review button if DELIVERED
                         let reviewButtonHtml = '';
                         if (order.status === 'DELIVERED' && order.orderDetails && order.orderDetails.length > 0) {
                             const firstProductId = order.orderDetails[0].product?.id;
                             if (firstProductId) {
                                 reviewButtonHtml = `
                                     <a href="/products/${firstProductId}" class="btn btn-info btn-sm ms-1">
                                         <i class="bi bi-star-fill"></i> Đánh giá
                                     </a>`;
                             } else {
                                 console.warn(`Order ${order.id}: Could not get product ID for review button.`);
                             }
                         }


                        row.innerHTML = `
                            <td>#${order.id}</td>
                            <td>${new Date(order.orderDate).toLocaleDateString('vi-VN')}</td>
                            <td>${order.shippingAddress}</td>
                            <td>${order.totalAmount.toLocaleString('vi-VN')} đ</td>
                            <td><span class="badge ${statusBadge}">${statusText}</span></td>
                            <td>
                                <a href="/orders/${order.id}" class="btn btn-primary btn-sm">Xem chi tiết</a>
                                ${changePaymentButtonHtml}
                                ${reviewButtonHtml}
                            </td>
                        `;
                    });

                } else if (response.status === 401 || response.status === 403) {
                     Swal.fire('Lỗi', 'Không có quyền truy cập hoặc phiên đăng nhập hết hạn.', 'error').then(() => window.location.href = '/login');
                } else {
                     const errorText = await response.text();
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-5 text-danger">Lỗi tải lịch sử đơn hàng (${response.status}): ${errorText}</td></tr>`;
                }
            } catch (error) {
                 console.error("Lỗi mạng khi tải lịch sử:", error);
                 tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-5 text-danger">Lỗi kết nối mạng.</td></tr>';
            }
        }

        // Function to show the modal (modal HTML is now in the layout)
        // Ensure this function is accessible globally if called from HTML onclick
        window.showChangePaymentModal = function(orderId, currentMethod) {
            console.log(`Attempting to show modal for order ${orderId}, current method ${currentMethod}`);
            const modalEl = document.getElementById('changePaymentModal'); // Get modal from layout

            if (!modalEl) {
                console.error("CRITICAL ERROR: Modal element #changePaymentModal not found in layout DOM!");
                Swal.fire('Lỗi giao diện nghiêm trọng', 'Không tìm thấy cấu trúc cửa sổ.', 'error');
                return;
            }

            // Use getOrCreateInstance for safety
            const changePaymentModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);

            if (!changePaymentModalInstance) {
                console.error("Failed to get or create Bootstrap Modal instance!");
                 Swal.fire('Lỗi giao diện', 'Không thể khởi tạo cửa sổ.', 'error');
                 return;
            }

            // --- Rest of the function remains the same ---
            const modalOrderIdSpan = document.getElementById('modalOrderId');
            const modalChangeOrderIdInput = document.getElementById('modalChangeOrderId');
            if(modalOrderIdSpan) modalOrderIdSpan.textContent = orderId;
            if(modalChangeOrderIdInput) modalChangeOrderIdInput.value = orderId;

            const currentMethodUpper = currentMethod.toUpperCase();
            let radioToCheck = document.querySelector(`input[name="newPaymentMethod"][value="${currentMethodUpper}"]`);

             if (!radioToCheck && currentMethodUpper === 'SEPAY_QR') {
                 radioToCheck = document.getElementById('newSepayQr');
             } else if (!radioToCheck && currentMethodUpper === 'COD') {
                 radioToCheck = document.getElementById('newCod');
             }

             // Handle PENDING_PAYMENT status correctly checking QR
             if (currentMethodUpper === 'PENDING_PAYMENT') {
                  radioToCheck = document.getElementById('newSepayQr');
             } else if (!radioToCheck) { // Default to COD if still not found
                 radioToCheck = document.getElementById('newCod');
                 console.warn(`Could not find radio for current method '${currentMethodUpper}', defaulting to COD.`);
             }

             if (radioToCheck) {
                 radioToCheck.checked = true;
             } else {
                 console.error("Could not find any payment method radio buttons!");
             }

            console.log("Showing modal instance from layout...");
            changePaymentModalInstance.show();
        }

        // Function to handle the form submission within the modal
        // Ensure this function is accessible globally if called from HTML onclick
        window.handleChangePaymentSubmit = async function() {
            const orderId = document.getElementById('modalChangeOrderId').value;
            const selectedPaymentRadio = document.querySelector('input[name="newPaymentMethod"]:checked');
            const saveButton = document.getElementById('savePaymentChangeBtn');

            const modalEl = document.getElementById('changePaymentModal'); // Get modal from layout
            // Get the currently shown instance (if any)
            const changePaymentModalInstance = modalEl ? bootstrap.Modal.getInstance(modalEl) : null;


            if (!selectedPaymentRadio) {
                Swal.fire('Lỗi', 'Vui lòng chọn phương thức thanh toán mới.', 'warning');
                return;
            }
            const newPaymentMethod = selectedPaymentRadio.value;

            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang lưu...';

            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`/api/orders/${orderId}/change-payment`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPaymentMethod: newPaymentMethod })
                });

                const result = await response.json();

                if (response.ok) {
                    if (changePaymentModalInstance) changePaymentModalInstance.hide(); // Hide modal first

                    if (result.paymentMethod === 'SEPAY_QR' && result.paymentCode) {
                        sessionStorage.setItem('paymentInfo', JSON.stringify({
                            orderId: orderId,
                            paymentCode: result.paymentCode,
                            totalAmount: result.totalAmount
                        }));
                         Swal.fire('Thành công', result.message || 'Đổi PTTT thành công. Bạn sẽ được chuyển đến trang thanh toán QR.', 'success')
                         .then(() => {
                             window.location.href = `/payment/${orderId}`;
                         });

                    } else {
                         Swal.fire('Thành công', result.message || 'Đổi PTTT thành công!', 'success');
                         fetchOrderHistory(); // Reload table
                    }
                } else {
                    throw new Error(result.message || `Lỗi ${response.status}`);
                }
            } catch (error) {
                Swal.fire('Lỗi', `Không thể thay đổi phương thức thanh toán: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'Lưu thay đổi';
            }
        }
    </script>
</th:block>

</body>
</html>