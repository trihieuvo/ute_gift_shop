<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Shipper - Lịch sử đơn hàng</title>
    <style>
        .order-card {
            border: 1px solid #ddd;
            border-left-width: 5px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,.05);
        }
        /* Thẻ thành công */
        .order-card-success {
            border-left-color: #198754; 
        }
         /* Thẻ thất bại */
        .order-card-danger {
            border-left-color: #dc3545;
        }
        .order-card-body {
            padding: 1rem;
        }
        .order-card-footer {
            background-color: #f9f9f9;
            padding: 0.75rem 1rem;
            border-top: 1px solid #eee;
        }
        .phone-link {
            font-weight: 500;
            text-decoration: none;
        }
        .phone-link i {
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
         <h1>Lịch sử đơn hàng</h1>
         <a th:href="@{/shipper/dashboard}" class="btn btn-secondary btn-sm">
             <i class="bi bi-arrow-left-circle"></i> Quay lại
         </a>
    </div>

    <div id="orders-list-container">
        <p class="text-center p-5">Đang tải lịch sử đơn hàng...</p>
    </div>
</div>

<th:block layout:fragment="scripts_body">
    <script>
        // Hàm định dạng tiền tệ
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        });

        async function fetchCompletedOrders() {
            const token = localStorage.getItem('jwtToken');
            const container = document.getElementById('orders-list-container');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                // Gọi API lấy đơn hàng ĐÃ HOÀN THÀNH
                const response = await fetch('/api/shipper/orders/completed', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const orders = await response.json(); 
                    container.innerHTML = ''; // Xóa dòng "Đang tải..."

                    if (orders.length === 0) {
                        container.innerHTML = `
                            <div class="alert alert-info text-center">
                                <i class="bi bi-info-circle-fill fs-3 d-block mb-2"></i>
                                <p class="mb-0">Bạn chưa có đơn hàng nào đã hoàn thành.</p>
                            </div>`;
                        return;
                    }

                    orders.forEach(order => {
                        const orderCard = document.createElement('div');
                        let cardClass = 'order-card';
                        let statusBadge = '';

                        if(order.status === 'DELIVERED') {
                            cardClass += ' order-card-success';
                            statusBadge = `<span class="badge bg-success">Đã giao thành công</span>`;
                        } else {
                            cardClass += ' order-card-danger';
                            statusBadge = `<span class="badge bg-danger">Giao thất bại</span>`;
                        }
                        orderCard.className = cardClass;
                        
                        let totalAmountDisplay = order.totalAmount ? formatter.format(order.totalAmount) : 'N/A';
                        
                        let phoneHtml = order.recipientPhone 
                            ? `<a href="tel:${order.recipientPhone}" class="phone-link"><i class="bi bi-telephone-fill"></i> ${order.recipientPhone}</a>`
                            : `<span class="text-muted">Không có SĐT</span>`;

                        orderCard.innerHTML = `
                            <div class="order-card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-1">Đơn hàng #${order.id}</h5>
                                        ${statusBadge}
                                        <span class="text-muted small ms-2">${new Date(order.orderDate).toLocaleDateString('vi-VN')}</span>
                                    </div>
                                    <strong class_A="fs-5">${totalAmountDisplay}</strong>
                                </div>
                                <hr class="my-2">
                                <p class="mb-1">
                                    <strong><i class="bi bi-person-fill text-muted"></i> Người nhận:</strong> 
                                    ${order.recipientName || 'N/A'} (${phoneHtml})
                                </p>
                                <p class="mb-0">
                                    <strong><i class="bi bi-geo-alt-fill text-muted"></i> Địa chỉ:</strong> 
                                    ${order.shippingAddress || 'N/A'}
                                </p>
                            </div>
                            <div class="order-card-footer text-end">
                                <a href="/shipper/orders/${order.id}" class="btn btn-outline-secondary btn-sm">
                                    Xem lại chi tiết
                                </a>
                            </div>
                        `;
                        container.appendChild(orderCard);
                    });

                } else if (response.status === 401 || response.status === 403) {
                     Swal.fire('Lỗi', 'Không có quyền truy cập hoặc phiên đăng nhập hết hạn.', 'error').then(() => window.location.href = '/login');
                } else {
                    console.error('Lỗi lấy đơn hàng:', response.statusText);
                    container.innerHTML = '<div class="alert alert-danger text-center">Lỗi tải lịch sử đơn hàng.</div>';
                }
            } catch (error) {
                console.error('Lỗi mạng:', error);
                 container.innerHTML = '<div class="alert alert-danger text-center">Lỗi kết nối mạng.</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchCompletedOrders);
    </script>
</th:block>

</body>
</html>