<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Shipper - Bảng điều khiển</title>
</head>
<body>

<div layout:fragment="content">
    <h1 class="mb-4">Bảng điều khiển Shipper</h1>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card text-bg-warning shadow-sm"> <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Đơn đang chờ/giao</h5>
                        <p class="card-text fs-2 fw-bold" id="assigned-count">...</p>
                    </div>
                    <i class="bi bi-box-seam-fill" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-success shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Đã giao thành công</h5>
                        <p class="card-text fs-2 fw-bold" id="delivered-count">...</p>
                    </div>
                    <i class="bi bi-check-circle-fill" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-danger shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Đơn giao thất bại</h5>
                        <p class="card-text fs-2 fw-bold" id="failed-count">...</p>
                    </div>
                    <i class="bi bi-x-circle-fill" style="font-size: 3rem; opacity: 0.5;"></i>
                </div>
            </div>
        </div>
    </div>

    <h4>Tác vụ nhanh</h4>
    <div class="list-group">
        <a th:href="@{/shipper/orders}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1"><i class="bi bi-list-task text-primary"></i> Xem đơn hàng cần giao</h5>
                <p class="mb-0 text-muted">Xem danh sách các đơn hàng mới được gán cho bạn.</p>
            </div>
            <span class="badge bg-primary rounded-pill" id="assigned-badge-count">...</span>
        </a>
        <a th:href="@{/shipper/orders/completed}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1"><i class="bi bi-clock-history text-success"></i> Lịch sử đơn hàng</h5>
                <p class="mb-0 text-muted">Xem lại các đơn hàng đã giao thành công hoặc thất bại.</p>
            </div>
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>

</div>

<th:block layout:fragment="scripts_body">
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            try {
                // Gọi API lấy thống kê
                const response = await fetch('/api/shipper/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('assigned-count').textContent = stats.assigned || 0;
                    document.getElementById('delivered-count').textContent = stats.delivered || 0;
                    document.getElementById('failed-count').textContent = stats.failed || 0;
                    // Cập nhật badge
                    document.getElementById('assigned-badge-count').textContent = stats.assigned || 0;

                } else if (response.status === 401 || response.status === 403) {
                     Swal.fire('Lỗi', 'Không có quyền truy cập hoặc phiên đăng nhập hết hạn.', 'error').then(() => window.location.href = '/login');
                }
                 else {
                    console.error('Lỗi lấy thống kê:', response.statusText);
                    document.getElementById('assigned-count').textContent = 'Lỗi';
                    document.getElementById('delivered-count').textContent = 'Lỗi';
                    document.getElementById('failed-count').textContent = 'Lỗi';
                }
            } catch (error) {
                console.error('Lỗi mạng:', error);
                Swal.fire('Lỗi', 'Lỗi kết nối mạng.', 'error');
            }
        });
    </script>
</th:block>

</body>
</html>