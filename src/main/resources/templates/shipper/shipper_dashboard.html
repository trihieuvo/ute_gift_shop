<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Shipper - Bảng điều khiển</title>
</head>
<body>

<div layout:fragment="content">
    <h1 class="mb-4">Bảng điều khiển Shipper</h1>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card text-bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Đơn đang chờ giao</h5>
                    <p class="card-text fs-3" id="assigned-count">...</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-success">
                <div class="card-body">
                    <h5 class="card-title">Đơn đã giao thành công</h5>
                    <p class="card-text fs-3" id="delivered-count">...</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Đơn giao thất bại</h5>
                    <p class="card-text fs-3" id="failed-count">...</p>
                </div>
            </div>
        </div>
    </div>

    <p><a th:href="@{/shipper/orders}" class="btn btn-info">Xem danh sách đơn hàng cần giao</a></p>

    </div>

<th:block layout:fragment="scripts_body">
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // === SỬA LỖI: GỌI API THẬT ===
            try {
                // Gọi API lấy thống kê
                const response = await fetch('/api/shipper/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    // API trả về JSON dạng { assigned: 10, delivered: 50, failed: 5 }
                    const stats = await response.json();
                    document.getElementById('assigned-count').textContent = stats.assigned || 0;
                    document.getElementById('delivered-count').textContent = stats.delivered || 0;
                    document.getElementById('failed-count').textContent = stats.failed || 0;

                } else if (response.status === 401 || response.status === 403) {
                     Swal.fire('Lỗi', 'Không có quyền truy cập hoặc phiên đăng nhập hết hạn.', 'error').then(() => window.location.href = '/login');
                }
                 else {
                    console.error('Lỗi lấy thống kê:', response.statusText);
                    document.getElementById('assigned-count').textContent = 'Lỗi';
                    document.getElementById('delivered-count').textContent = 'Lỗi';
                    document.getElementById('failed-count').textContent = 'Lỗi';
                }
            } catch (error) {
                console.error('Lỗi mạng:', error);
                Swal.fire('Lỗi', 'Lỗi kết nối mạng.', 'error');
            }
            // === KẾT THÚC SỬA LỖI ===
        });
    </script>
</th:block>

</body>
</html>