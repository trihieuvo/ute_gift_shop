<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Shipper - Chi tiết Đơn hàng</title>
</head>
<body>

<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
         <h1 id="order-title">Chi tiết Đơn hàng #...</h1>
         <a th:href="@{/shipper/orders}" class="btn btn-secondary btn-sm">Quay lại danh sách</a>
    </div>

    <div id="order-details-loading" class="text-center p-5">Đang tải thông tin đơn hàng...</div>

    <div id="order-details-content" class="d-none">
        <div class="row g-4">
            <div class="col-md-6">
                <h5>Thông tin người nhận</h5>
                <ul class="list-group list-group-flush mb-3">
                    <li class="list-group-item"><strong>Tên:</strong> <span id="recipient-name"></span></li>
                    <li class="list-group-item"><strong>Số điện thoại:</strong> <span id="recipient-phone"></span></li>
                    <li class="list-group-item"><strong>Địa chỉ:</strong> <span id="recipient-address"></span></li>
                </ul>

                <h5>Thông tin đơn hàng</h5>
                <ul class="list-group list-group-flush mb-3">
                    <li class="list-group-item"><strong>Ngày đặt:</strong> <span id="order-date"></span></li>
                    <li class="list-group-item"><strong>Tổng tiền:</strong> <span id="order-total"></span></li>
                    <li class="list-group-item"><strong>Phương thức TT:</strong> <span id="order-payment"></span></li>
                    <li class="list-group-item"><strong>Trạng thái hiện tại:</strong> <span id="order-current-status" class="fw-bold"></span></li>
                </ul>
            </div>

            <div class="col-md-6">
                <h5>Cập nhật trạng thái</h5>
                <div class="mb-3">
                    <label for="newStatus" class="form-label">Chọn trạng thái mới:</label>
                    <select class="form-select" id="newStatus" name="newStatus">
                        <option value="DELIVERING">Đang giao hàng</option>
                        <option value="DELIVERED">Đã giao thành công</option>
                        <option value="FAILED_DELIVERY">Giao hàng thất bại</option>
                    </select>
                </div>
                <button id="update-status-btn" class="btn btn-success">Cập nhật</button>
            </div>
        </div>

        </div>
</div>

<th:block layout:fragment="scripts_body">
    <script th:inline="javascript">
        /*<![CDATA[*/
        const orderId = /*[[${orderId}]]*/ null; // Lấy orderId từ Model
        /*]]>*/

        const loadingDiv = document.getElementById('order-details-loading');
        const contentDiv = document.getElementById('order-details-content');
        const updateBtn = document.getElementById('update-status-btn');
        const newStatusSelect = document.getElementById('newStatus');

        async function fetchOrderDetails() {
            const token = localStorage.getItem('jwtToken');
            if (!token || !orderId) {
                window.location.href = '/login';
                return;
            }

            document.getElementById('order-title').textContent = `Chi tiết Đơn hàng #${orderId}`;

            try {
                const response = await fetch(`/api/shipper/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                loadingDiv.classList.add('d-none'); // Ẩn loading

                if (response.ok) {
                    const order = await response.json();
                    contentDiv.classList.remove('d-none'); // Hiện content

                    document.getElementById('recipient-name').textContent = order.user?.fullName || 'N/A';
                    document.getElementById('recipient-phone').textContent = order.user?.phoneNumber || 'N/A'; // Cần API trả về SĐT user hoặc lưu SĐT trên địa chỉ đơn hàng
                    document.getElementById('recipient-address').textContent = order.shippingAddress || 'N/A';
                    document.getElementById('order-date').textContent = new Date(order.orderDate).toLocaleString('vi-VN');
                    document.getElementById('order-total').textContent = order.totalAmount ? order.totalAmount.toLocaleString('vi-VN') + ' đ' : 'N/A';
                    document.getElementById('order-payment').textContent = order.paymentMethod || 'N/A';
                    document.getElementById('order-current-status').textContent = order.status || 'N/A';

                    // Cập nhật trạng thái select dựa trên trạng thái hiện tại (ví dụ: nếu đã giao thì disable nút)
                    if (order.status === 'DELIVERED' || order.status === 'FAILED_DELIVERY' || order.status === 'CANCELLED') {
                         newStatusSelect.disabled = true;
                         updateBtn.disabled = true;
                         updateBtn.textContent = 'Đã hoàn thành';
                    }


                } else if (response.status === 401 || response.status === 403) {
                     Swal.fire('Lỗi', 'Không có quyền truy cập hoặc phiên đăng nhập hết hạn.', 'error').then(() => window.location.href = '/login');
                } else if (response.status === 404) {
                    contentDiv.innerHTML = '<p class="text-danger text-center">Không tìm thấy đơn hàng.</p>';
                    contentDiv.classList.remove('d-none');
                }
                else {
                    console.error('Lỗi lấy chi tiết đơn hàng:', response.statusText);
                     contentDiv.innerHTML = '<p class="text-danger text-center">Lỗi tải thông tin đơn hàng.</p>';
                     contentDiv.classList.remove('d-none');
                }
            } catch (error) {
                 loadingDiv.classList.add('d-none'); // Ẩn loading
                console.error('Lỗi mạng:', error);
                 contentDiv.innerHTML = '<p class="text-danger text-center">Lỗi kết nối mạng.</p>';
                 contentDiv.classList.remove('d-none');
            }
        }

        async function updateOrderStatus() {
             const token = localStorage.getItem('jwtToken');
            if (!token || !orderId) {
                window.location.href = '/login';
                return;
            }
            const newStatus = newStatusSelect.value;
            // const note = document.getElementById('note')?.value; // Lấy ghi chú nếu có

             updateBtn.disabled = true;
             updateBtn.textContent = 'Đang cập nhật...';

             try {
                 const response = await fetch(`/api/shipper/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                     },
                    body: JSON.stringify({ newStatus: newStatus /*, note: note */ })
                 });

                 const responseText = await response.text();

                 if (response.ok) {
                     Swal.fire({
                         title: 'Thành công!',
                         text: responseText,
                         icon: 'success',
                         timer: 2000,
                         showConfirmButton: false
                     }).then(() => {
                         // Tải lại chi tiết để cập nhật trạng thái hiển thị
                         contentDiv.classList.add('d-none');
                         loadingDiv.classList.remove('d-none');
                         fetchOrderDetails();
                     });
                 } else {
                     Swal.fire('Lỗi!', responseText || 'Cập nhật trạng thái thất bại.', 'error');
                 }

             } catch(error) {
                 console.error('Lỗi cập nhật:', error);
                 Swal.fire('Lỗi!', 'Lỗi mạng khi cập nhật.', 'error');
             } finally {
                 // Chỉ bật lại nếu trạng thái chưa phải cuối cùng
                 const currentStatus = document.getElementById('order-current-status').textContent;
                  if (currentStatus !== 'DELIVERED' && currentStatus !== 'FAILED_DELIVERY' && currentStatus !== 'CANCELLED') {
                       updateBtn.disabled = false;
                       updateBtn.textContent = 'Cập nhật';
                  }
             }
        }

        document.addEventListener('DOMContentLoaded', fetchOrderDetails);
        updateBtn.addEventListener('click', updateOrderStatus);
    </script>
</th:block>

</body>
</html>