<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Shipper - Chi tiết Đơn hàng</title>
    <style>
        .product-list-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        .product-list-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 1rem;
        }
        .product-info {
            flex-grow: 1;
        }
        .product-info p {
            margin-bottom: 0;
        }
        .product-price {
            text-align: right;
            min-width: 100px;
        }
        /* Ẩn các trường không cần thiết ban đầu */
        #delivery-note-group, #pod-upload-group {
            display: none;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Chi tiết Đơn hàng #<span th:text="${orderId}">...</span></h1>
        <a th:href="@{/shipper/orders}" class="btn btn-secondary btn-sm">
             <i class="bi bi-arrow-left-circle"></i> Quay lại
         </a>
    </div>

    <div id="loading-container" class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Đang tải chi tiết đơn hàng...</p>
    </div>

    <div id="details-container" class="d-none">
        <div class="row g-4">
            <div class="col-lg-5">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-person-fill text-muted"></i> Thông tin người nhận</h5>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Tên:</strong> <span id="recipient-name">...</span></li>
                        <li class="list-group-item"><strong>SĐT:</strong> <span id="recipient-phone">...</span></li>
                        <li class="list-group-item"><strong>Địa chỉ:</strong> <span id="recipient-address">...</span></li>
                    </ul>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-text-fill text-muted"></i> Thông tin đơn hàng</h5>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Trạng thái:</strong> <span id="order-status" class="badge bg-primary fs-6">...</span></li>
                        <li class="list-group-item"><strong>Phương thức TT:</strong> <span id="payment-method">...</span></li>
                        <li class="list-group-item"><strong>Tổng tiền:</strong> <strong id="total-amount" class="text-danger fs-5">...</strong></li>
                    </ul>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-box-seam-fill text-muted"></i> Danh sách sản phẩm</h5>
                    </div>
                    <div class="card-body">
                        <div id="product-list-container">
                            </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-arrow-repeat text-muted"></i> Cập nhật trạng thái</h5>
                    </div>
                    <div class="card-body">
                        <form id="update-status-form">
                            <div id="action-buttons" class="d-grid gap-2 mb-3">
                                <button type="button" id="btn-start-delivery" class="btn btn-primary btn-lg d-none" onclick="handleUpdateStatus('DELIVERING')">
                                    <i class="bi bi-truck"></i> Bắt đầu giao hàng
                                </button>
                                
                                <button type="button" id="btn-delivered" class="btn btn-success btn-lg d-none" onclick="showUpdateOptions('DELIVERED')">
                                    <i class="bi bi-check-circle-fill"></i> Giao hàng thành công
                                </button>
                                
                                <button type="button" id="btn-failed" class="btn btn-danger btn-lg d-none" onclick="showUpdateOptions('RETURN_PENDING')">
                                    <i class="bi bi-x-circle-fill"></i> Báo giao hàng thất bại
                                </button>
                                
                                <p id="final-status-msg" class="text-muted text-center d-none">Đơn hàng này đã kết thúc.</p>
                            </div>
                            
                            <div class="mb-3" id="delivery-note-group">
                                <label for="delivery-note" class="form-label">Lý do thất bại / Ghi chú:</label>
                                <textarea class="form-control" id="delivery-note" rows="3" placeholder="VD: Khách hẹn giao lại, Khách không nghe máy..."></textarea>
                            </div>
                            
                            <div class="mb-3" id="pod-upload-group">
                                <label for="pod-url" class="form-label">URL Ảnh bằng chứng giao hàng (POD):</label>
                                <input type="text" class="form-control" id="pod-url" placeholder="Dán link ảnh đã upload (VD: imgur.com/...)">
                            </div>

                            <div id="confirm-action-group" class="d-none d-grid gap-2">
                                <button type="button" id="btn-confirm-update" class="btn btn-success">Xác nhận</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelUpdateOptions()">Hủy bỏ</button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts_body">
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Lấy orderId từ Model mà ShipperViewController đã truyền sang
        const orderId = /*[[${orderId}]]*/ '0';
        /*]]>*/

        const token = localStorage.getItem('jwtToken');
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        });
        
        // Các DOM element
        const loadingContainer = document.getElementById('loading-container');
        const detailsContainer = document.getElementById('details-container');
        const productListContainer = document.getElementById('product-list-container');
        const btnStartDelivery = document.getElementById('btn-start-delivery');
        const btnDelivered = document.getElementById('btn-delivered');
        const btnFailed = document.getElementById('btn-failed');
        const finalStatusMsg = document.getElementById('final-status-msg');
        const noteGroup = document.getElementById('delivery-note-group');
        const podGroup = document.getElementById('pod-upload-group');
        const confirmGroup = document.getElementById('confirm-action-group');
        const btnConfirmUpdate = document.getElementById('btn-confirm-update');
        const actionButtons = document.getElementById('action-buttons');
        
        let currentStatus = ''; // Lưu trạng thái hiện tại

        async function fetchOrderDetail() {
            if (!token || !orderId) {
                window.location.href = '/login';
                return;
            }
            
            loadingContainer.classList.remove('d-none');
            detailsContainer.classList.add('d-none');
            
            try {
                // Gọi API chi tiết đơn hàng
                const response = await fetch(`/api/shipper/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const order = await response.json();
                    
                    // Đổ dữ liệu vào các thẻ span
                    document.getElementById('recipient-name').textContent = order.recipientName || 'N/A';
                    document.getElementById('recipient-phone').innerHTML = order.recipientPhone 
                        ? `<a href="tel:${order.recipientPhone}">${order.recipientPhone}</a>` : 'N/A';
                    document.getElementById('recipient-address').textContent = order.shippingAddress || 'N/A';
                    
                    const statusElem = document.getElementById('order-status');
                    statusElem.textContent = order.status;
                    statusElem.className = 'badge fs-6 ' + getStatusBadgeClass(order.status);
                    
                    const paymentElem = document.getElementById('payment-method');
                    paymentElem.textContent = order.paymentMethod;
                    if(order.paymentMethod === 'COD') {
                        paymentElem.innerHTML += ' <span class="badge bg-danger">Thu hộ</span>';
                    } else {
                         paymentElem.innerHTML += ' <span class="badge bg-success">Đã thanh toán</span>';
                    }
                    
                    document.getElementById('total-amount').textContent = formatter.format(order.totalAmount || 0);
                    
                    // Hiển thị danh sách sản phẩm
                    productListContainer.innerHTML = '';
                    if (order.products && order.products.length > 0) {
                        order.products.forEach(item => {
                            productListContainer.innerHTML += `
                                <div class="product-list-item">
                                    <img src="https://via.placeholder.com/100" alt="${item.productName}">
                                    <div class="product-info">
                                        <p class="fw-bold">${item.productName}</p>
                                        <p class="text-muted small">SL: ${item.quantity}</p>
                                    </div>
                                    <div class="product-price">
                                        <p class="fw-bold">${formatter.format(item.totalPrice)}</p>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        productListContainer.innerHTML = '<p class="text-muted">Không có chi tiết sản phẩm.</p>';
                    }
                    
                    // Cập nhật trạng thái và hiển thị nút hành động
                    currentStatus = order.status;
                    updateActionButtons(currentStatus);
                    
                    // Hiển thị nội dung
                    loadingContainer.classList.add('d-none');
                    detailsContainer.classList.remove('d-none');

                } else if (response.status === 401 || response.status === 403) {
                     Swal.fire('Lỗi', 'Không có quyền truy cập hoặc phiên đăng nhập hết hạn.', 'error').then(() => window.location.href = '/shipper/dashboard');
                } else {
                     loadingContainer.innerHTML = '<p class="text-danger p-5">Không tìm thấy hoặc lỗi tải đơn hàng.</p>';
                }
            } catch (error) {
                 console.error('Lỗi mạng:', error);
                 loadingContainer.innerHTML = '<p class="text-danger p-5">Lỗi kết nối mạng.</p>';
            }
        }
        
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'NEW':
                case 'CONFIRMED':
                case 'PREPARING': return 'bg-warning text-dark';
                case 'DELIVERING': return 'bg-primary';
                case 'DELIVERED': return 'bg-success';
                case 'RETURN_PENDING': return 'bg-danger';
                case 'RETURNED': return 'bg-dark';
                case 'CANCELLED': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function updateActionButtons(status) {
            // Ẩn tất cả các nút
            [btnStartDelivery, btnDelivered, btnFailed, finalStatusMsg].forEach(btn => btn.classList.add('d-none'));
            
            // Hiển thị nút dựa trên trạng thái
            if (['CONFIRMED', 'PREPARING'].includes(status)) {
                btnStartDelivery.classList.remove('d-none');
            } else if (status === 'DELIVERING') {
                btnDelivered.classList.remove('d-none');
                btnFailed.classList.remove('d-none');
            } else {
                // Các trạng thái cuối (DELIVERED, RETURNED, CANCELLED)
                finalStatusMsg.classList.remove('d-none');
            }
        }

        // Hiển thị các trường nhập liệu tương ứng
        function showUpdateOptions(newStatus) {
            actionButtons.classList.add('d-none'); // Ẩn các nút hành động
            
            if (newStatus === 'DELIVERED') {
                podGroup.style.display = 'block'; // Hiện trường POD
                noteGroup.style.display = 'none'; // Ẩn ghi chú
            } else if (newStatus === 'RETURN_PENDING') {
                podGroup.style.display = 'none'; // Ẩn POD
                noteGroup.style.display = 'block'; // Hiện trường Ghi chú
            }
            
            confirmGroup.classList.remove('d-none'); // Hiện nút "Xác nhận"
            
            // Gán hành động cho nút "Xác nhận"
            btnConfirmUpdate.onclick = () => handleUpdateStatus(newStatus); 
        }

        // Hủy bỏ việc cập nhật, quay lại
        function cancelUpdateOptions() {
            actionButtons.classList.remove('d-none');
            confirmGroup.classList.add('d-none');
            podGroup.style.display = 'none';
            noteGroup.style.display = 'none';
            document.getElementById('delivery-note').value = '';
            document.getElementById('pod-url').value = '';
        }

        // Hàm gọi API cập nhật trạng thái
        async function handleUpdateStatus(newStatus) {
            const note = document.getElementById('delivery-note').value;
            const podUrl = document.getElementById('pod-url').value;
            
            // Kiểm tra ràng buộc
            if (newStatus === 'RETURN_PENDING' && !note) {
                Swal.fire('Thiếu thông tin', 'Vui lòng nhập lý do giao hàng thất bại.', 'warning');
                return;
            }
            if (newStatus === 'DELIVERED' && !podUrl) {
                Swal.fire('Thiếu thông tin', 'Vui lòng cung cấp URL bằng chứng giao hàng (POD).', 'warning');
                return;
            }
            
            const body = {
                newStatus: newStatus,
                note: note,
                proofOfDeliveryImageUrl: podUrl
            };
            
            btnConfirmUpdate.disabled = true;
            btnConfirmUpdate.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang xử lý...';

            try {
                const response = await fetch(`/api/shipper/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                const responseText = await response.text();

                if (response.ok) {
                    Swal.fire('Thành công!', responseText, 'success');
                    cancelUpdateOptions(); // Ẩn form xác nhận
                    fetchOrderDetail(); // Tải lại chi tiết đơn hàng
                } else {
                    Swal.fire('Lỗi!', responseText, 'error');
                }
            } catch (error) {
                Swal.fire('Lỗi!', 'Lỗi mạng, không thể cập nhật.', 'error');
            } finally {
                 btnConfirmUpdate.disabled = false;
                 btnConfirmUpdate.innerHTML = 'Xác nhận';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchOrderDetail);
    </script>
</th:block>

</body>
</html>