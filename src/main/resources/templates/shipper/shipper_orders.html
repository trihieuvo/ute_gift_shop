<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Shipper - Đơn hàng đang xử lý</title>
    <style>
        .order-card {
            border: 1px solid #ddd;
            border-left-width: 5px;
            /* border-left-color: #ffc107; (Màu vàng) Sẽ đổi theo trạng thái */
            border-radius: 5px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,.05);
            transition: box-shadow 0.2s ease;
        }
        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }
        /* Màu cho đơn đang giao */
        .order-card-delivering {
            border-left-color: #0d6efd; /* Màu xanh dương */
        }
        .order-card-new {
             border-left-color: #ffc107; /* Màu vàng */
        }

        .order-card-body {
            padding: 1rem;
        }
        .order-card-footer {
            background-color: #f9f9f9;
            padding: 0.75rem 1rem;
            border-top: 1px solid #eee;
        }
        .phone-link {
            font-weight: 500;
            text-decoration: none;
        }
        .phone-link i {
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
         <h1>Đơn hàng đang xử lý</h1>
         <a th:href="@{/shipper/dashboard}" class="btn btn-secondary btn-sm">
             <i class="bi bi-arrow-left-circle"></i> Quay lại
         </a>
    </div>

    <div id="orders-list-container">
        <p class="text-center p-5">Đang tải danh sách đơn hàng...</p>
    </div>
</div>

<th:block layout:fragment="scripts_body">
    <script>
        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        });

        async function fetchActiveOrders() {
            const token = localStorage.getItem('jwtToken');
            const container = document.getElementById('orders-list-container');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/api/shipper/orders/active', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const orders = await response.json();
                    container.innerHTML = ''; // Xóa dòng "Đang tải..."

                    if (orders.length === 0) {
                        container.innerHTML = `
                            <div class="alert alert-success text-center">
                                <i class="bi bi-check-circle-fill fs-3 d-block mb-2"></i>
                                <h5>Tuyệt vời!</h5>
                                <p class="mb-0">Bạn không có đơn hàng nào cần xử lý.</p>
                            </div>`;
                        return;
                    }

                    orders.forEach(order => {
                        const orderCard = document.createElement('div');

                        // Phân loại màu thẻ
                        let cardClass = 'order-card';
                        let statusBadge = '';
                        if(order.status === 'DELIVERING') {
                            cardClass += ' order-card-delivering';
                            statusBadge = `<span class="badge bg-primary">${order.status}</span>`;
                        } else {
                            cardClass += ' order-card-new';
                            statusBadge = `<span class="badge bg-warning text-dark">${order.status}</span>`;
                        }
                        orderCard.className = cardClass;


                        let totalAmountDisplay = order.totalAmount ? formatter.format(order.totalAmount) : 'N/A';

                        let paymentTag = '';
                        if (order.paymentMethod === 'COD') {
                            paymentTag = `<span class="badge bg-danger">Thu hộ</span>`;
                        } else {
                            paymentTag = `<span class="badge bg-success">Đã thanh toán</span>`;
                        }

                        let phoneHtml = order.recipientPhone
                            ? `<a href="tel:${order.recipientPhone}" class="phone-link"><i class="bi bi-telephone-fill"></i> ${order.recipientPhone}</a>`
                            : `<span class="text-muted">Không có SĐT</span>`;

                        // Tạo URL chính xác
                        const detailUrl = `/shipper/orders/${order.id}`;
                        // console.log(`URL được tạo cho order ${order.id}: ${detailUrl}`); // Log cũ

                        // Tạo chuỗi HTML
                        const cardHTML = `
                            <div class="order-card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-1">Đơn hàng #${order.id}</h5>
                                        ${statusBadge}
                                        <span class="text-muted small ms-2">${new Date(order.orderDate).toLocaleDateString('vi-VN')}</span>
                                    </div>
                                    <strong class="text-danger fs-5">${totalAmountDisplay} ${paymentTag}</strong>
                                </div>
                                <hr class="my-2">
                                <p class="mb-1">
                                    <strong><i class="bi bi-person-fill text-muted"></i> Người nhận:</strong>
                                    ${order.recipientName || 'N/A'} (${phoneHtml})
                                </p>
                                <p class="mb-0">
                                    <strong><i class="bi bi-geo-alt-fill text-muted"></i> Địa chỉ:</strong>
                                    ${order.shippingAddress || 'N/A'}
                                </p>
                            </div>
                            <div class="order-card-footer text-end">
                                <a href="${detailUrl}" class="btn btn-primary">
                                    Chi tiết & Cập nhật <i class="bi bi-arrow-right-short"></i>
                                </a>
                            </div>
                        `;

                        // === THÊM LOG MỚI ĐỂ KIỂM TRA HTML ===
                        console.log(`HTML cho order ${order.id}:`, cardHTML);
                        // === KẾT THÚC THÊM LOG ===

                        orderCard.innerHTML = cardHTML;
                        container.appendChild(orderCard);
                    });

                } else if (response.status === 401 || response.status === 403) {
                     Swal.fire('Lỗi', 'Không có quyền truy cập hoặc phiên đăng nhập hết hạn.', 'error').then(() => window.location.href = '/login');
                } else {
                    console.error('Lỗi lấy đơn hàng:', response.statusText);
                    container.innerHTML = '<div class="alert alert-danger text-center">Lỗi tải danh sách đơn hàng.</div>';
                }
            } catch (error) {
                console.error('Lỗi mạng:', error);
                 container.innerHTML = '<div class="alert alert-danger text-center">Lỗi kết nối mạng.</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchActiveOrders);
    </script>
</th:block>

</body>
</html>