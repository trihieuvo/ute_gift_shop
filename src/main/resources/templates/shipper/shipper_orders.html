<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Shipper - Đơn hàng cần giao</title>
</head>
<body>

<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
         <h1 >Đơn hàng cần giao</h1>
         <a th:href="@{/shipper/dashboard}" class="btn btn-secondary btn-sm">Quay lại Dashboard</a>
    </div>


    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th scope="col">Mã ĐH</th>
                <th scope="col">Ngày đặt</th>
                <th scope="col">Người nhận</th>
                <th scope="col">Địa chỉ</th>
                <th scope="col">Tổng tiền</th>
                <th scope="col">Trạng thái</th>
                <th scope="col">Hành động</th>
            </tr>
        </thead>
        <tbody id="orders-table-body">
            <tr><td colspan="7" class="text-center p-5">Đang tải danh sách đơn hàng...</td></tr>
        </tbody>
    </table>
</div>

<th:block layout:fragment="scripts_body">
    <script>
        async function fetchAssignedOrders() {
            const token = localStorage.getItem('jwtToken');
            const tableBody = document.getElementById('orders-table-body');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/api/shipper/orders/assigned', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const orders = await response.json();
                    tableBody.innerHTML = ''; // Xóa dòng "Đang tải..."

                    if (orders.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-5">Không có đơn hàng nào cần giao.</td></tr>';
                        return;
                    }

                    orders.forEach(order => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>#${order.id}</td>
                            <td>${new Date(order.orderDate).toLocaleDateString('vi-VN')}</td>
                            <td>${order.user?.fullName || 'N/A'}</td> <td>${order.shippingAddress || 'N/A'}</td>
                            <td>${order.totalAmount ? order.totalAmount.toLocaleString('vi-VN') + ' đ' : 'N/A'}</td>
                            <td><span class="badge bg-warning text-dark">${order.status || 'N/A'}</span></td>
                            <td>
                                <a href="/shipper/orders/${order.id}" class="btn btn-primary btn-sm">Xem chi tiết</a>
                            </td>
                        `;
                    });

                } else if (response.status === 401 || response.status === 403) {
                     Swal.fire('Lỗi', 'Không có quyền truy cập hoặc phiên đăng nhập hết hạn.', 'error').then(() => window.location.href = '/login');
                } else {
                    console.error('Lỗi lấy đơn hàng:', response.statusText);
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-danger">Lỗi tải danh sách đơn hàng.</td></tr>';
                }
            } catch (error) {
                console.error('Lỗi mạng:', error);
                 tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-danger">Lỗi kết nối mạng.</td></tr>';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchAssignedOrders);
    </script>
</th:block>

</body>
</html>