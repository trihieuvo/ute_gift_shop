<!DOCTYPE html>
<html
  lang="vi"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/_admin_layout}"
>
  <head>
    <title>Quản lý Cửa hàng</title>
  </head>
  <body>
    <div layout:fragment="content">
      <h1 class="h2 pt-3 pb-2 mb-3 border-bottom">Yêu cầu Đăng ký Cửa hàng</h1>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Tên Shop</th>
              <th>Chủ sở hữu (Email)</th>
              <th>Ngày đăng ký</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="shop-table-body">
            <tr>
              <td colspan="4" class="text-center">Đang tải...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <th:block layout:fragment="scripts_body">
      <script>
        const token = localStorage.getItem("jwtToken"); // Lấy token

        // 1. Tải danh sách khi trang được mở
        document.addEventListener("DOMContentLoaded", fetchPendingShops);

        async function fetchPendingShops() {
          const tbody = document.getElementById("shop-table-body");

          try {
            const response = await fetch("/api/v1/admin/shops/pending", {
              headers: { Authorization: `Bearer ${token}` },
            });

            const shops = await response.json();
            tbody.innerHTML = ""; // Xóa "Đang tải..."

            if (shops.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="4" class="text-center">Không có yêu cầu nào.</td></tr>';
            }

            shops.forEach((shop) => {
              const userEmail = shop.user ? shop.user.email : "N/A";
              tbody.innerHTML += `
                            <tr>
                                <td>${shop.name}</td>
                                <td>${userEmail}</td>
                                <td>${new Date(
                                  shop.createdAt
                                ).toLocaleDateString("vi-VN")}</td>
                                <td>
                                    <button class="btn btn-success btn-sm" onclick="handleApprove(${
                                      shop.id
                                    })">
                                        <i class="bi bi-check-lg"></i> Duyệt
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="handleReject(${
                                      shop.id
                                    })">
                                        <i class="bi bi-x-lg"></i> Từ chối
                                    </button>
                                </td>
                            </tr>
                        `;
            });
          } catch (err) {
            tbody.innerHTML =
              '<tr><td colspan="4" class="text-center text-danger">Lỗi tải dữ liệu.</td></tr>';
          }
        }

        // 2. Hàm xử lý nút "Duyệt"
        async function handleApprove(shopId) {
          Swal.fire({
            title: "Bạn chắc chắn?",
            text: "Bạn muốn PHÊ DUYỆT cửa hàng này?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#28a745",
            cancelButtonText: "Hủy",
            confirmButtonText: "Vâng, phê duyệt!",
          }).then(async (result) => {
            if (result.isConfirmed) {
              await fetch(`/api/v1/admin/shops/${shopId}/approve`, {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
              });

              Swal.fire("Thành công!", "Đã phê duyệt cửa hàng.", "success");
              fetchPendingShops(); // Tải lại danh sách
            }
          });
        }

        // 3. Hàm xử lý nút "Từ chối"
        async function handleReject(shopId) {
          Swal.fire({
            title: "Bạn chắc chắn?",
            text: "Bạn muốn TỪ CHỐI cửa hàng này?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#dc3545",
            cancelButtonText: "Hủy",
            confirmButtonText: "Vâng, từ chối!",
          }).then(async (result) => {
            if (result.isConfirmed) {
              await fetch(`/api/v1/admin/shops/${shopId}/reject`, {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
              });

              Swal.fire("Đã từ chối", "Đã từ chối yêu cầu.", "info");
              fetchPendingShops(); // Tải lại danh sách
            }
          });
        }
      </script>
    </th:block>
  </body>
</html>
