<!DOCTYPE html>
<html
  lang="vi"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/_admin_layout}"
>
  <head>
    <title>Yêu cầu Đăng ký Cửa hàng</title>
  </head>
  <body>
    <div layout:fragment="content">
      <h1 class="h2 pt-3 pb-2 mb-3 border-bottom">Yêu cầu Đăng ký Cửa hàng</h1>

      <a th:href="@{/admin/manage-commissions}" class="btn btn-primary mb-3">
        <i class="bi bi-tags-fill"></i> Quản lý Chiết khấu/Shop đang hoạt động
      </a>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Tên Shop</th>
              <th>Chủ sở hữu (Email)</th>
              <th>Ngày đăng ký</th>
              <th>Mô tả</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="shop-table-body"></tbody>
        </table>
      </div>
    </div>

    <th:block layout:fragment="scripts_body">
      <script>
        const token = localStorage.getItem("jwtToken");
        // Sửa API URL ở đây
        const API_URL = "/api/admin/applications"; 

        document.addEventListener("DOMContentLoaded", fetchPendingApplications);

        async function fetchPendingApplications() { // Đổi tên hàm cho rõ nghĩa
          const tbody = document.getElementById("shop-table-body");
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center">Đang tải yêu cầu...</td></tr>';

          try {
            // Gọi API mới: lấy các đơn có status=PENDING và requestedRole=Vendor
            const response = await fetch(`${API_URL}?status=PENDING&requestedRole=Vendor`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            if (!response.ok) throw new Error("Lỗi tải dữ liệu.");

            const applications = await response.json();
            tbody.innerHTML = "";

            if (applications.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="5" class="text-center">Không có yêu cầu đăng ký Vendor nào.</td></tr>';
            }

            applications.forEach((app) => {
              // Sử dụng các trường từ RoleApplicationDto
              const registrationDate = new Date(app.createdAt).toLocaleDateString("vi-VN");

              tbody.innerHTML += `
                <tr>
                    <td>${app.userFullName}'s Shop (Yêu cầu)</td>
                    <td>${app.userEmail}</td>
                    <td>${registrationDate}</td>
                    <td>${app.message || "Không có lời nhắn"}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="handleApprove(${app.id})">
                            <i class="bi bi-check-lg"></i> Duyệt
                        </button>
                        <button class="btn btn-danger btn-sm ms-1" onclick="handleReject(${app.id})">
                            <i class="bi bi-x-lg"></i> Từ chối
                        </button>
                    </td>
                </tr>
              `;
            });
          } catch (err) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="text-center text-danger">Lỗi tải dữ liệu.</td></tr>';
          }
        }

        // Sửa lại hàm Duyệt và Từ chối để gọi đúng API
        async function handleApprove(applicationId) { // Đổi tên tham số
          Swal.fire({
            title: "Bạn chắc chắn?",
            text: "Bạn muốn PHÊ DUYỆT yêu cầu này?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#28a745",
            cancelButtonText: "Hủy",
            confirmButtonText: "Vâng, phê duyệt!",
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                // Gọi API phê duyệt của AdminApplicationController
                const response = await fetch(`${API_URL}/${applicationId}/approve`, {
                  method: "POST",
                  headers: { Authorization: `Bearer ${token}` },
                });
                if (!response.ok) throw new Error("Lỗi khi phê duyệt");
                Swal.fire("Thành công!", "Đã phê duyệt yêu cầu và tạo cửa hàng.", "success");
                fetchPendingApplications(); // Tải lại danh sách
              } catch (err) {
                Swal.fire("Lỗi!", "Không thể phê duyệt. Vui lòng thử lại.", "error");
              }
            }
          });
        }

        async function handleReject(applicationId) { // Đổi tên tham số
          Swal.fire({
            title: "Bạn chắc chắn?",
            text: "Bạn muốn TỪ CHỐI yêu cầu này?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#dc3545",
            cancelButtonText: "Hủy",
            confirmButtonText: "Vâng, từ chối!",
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                // Gọi API từ chối của AdminApplicationController
                const response = await fetch(`${API_URL}/${applicationId}/reject`, {
                  method: "POST",
                  headers: { Authorization: `Bearer ${token}` },
                });
                if (!response.ok) throw new Error("Lỗi khi từ chối");
                Swal.fire("Đã từ chối", "Đã từ chối yêu cầu.", "info");
                fetchPendingApplications(); // Tải lại danh sách
              } catch (err) {
                Swal.fire("Lỗi!", "Không thể từ chối. Vui lòng thử lại.", "error");
              }
            }
          });
        }
      </script>
    </th:block>
  </body>
</html>
