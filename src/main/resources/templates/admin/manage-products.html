<!DOCTYPE html>
<html
  lang="vi"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/_admin_layout}"
>
  <head>
    <title>Quản lý Sản phẩm</title>
    <style>
      .table > tbody > tr > td {
        vertical-align: middle; /* Căn giữa các ô */
      }
      .product-thumbnail {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 0.25rem;
      }
    </style>
  </head>
  <body>
    <div layout:fragment="content">
      <div
        class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom"
      >
        <h1 class="h2">
          <i class="bi bi-box-seam me-2"></i> Kiểm duyệt & Quản lý Sản phẩm
        </h1>
        <a
          th:href="@{/admin/dashboard}"
          class="btn btn-outline-secondary btn-sm"
        >
          <i class="bi bi-arrow-left"></i> Quay lại Dashboard
        </a>
      </div>

      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light border-0">
          <h5 class="mb-0"><i class="bi bi-funnel-fill me-2"></i> Bộ lọc</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label for="filter-name" class="form-label">Tên Sản phẩm</label>
              <input
                type="text"
                class="form-control"
                id="filter-name"
                placeholder="Nhập tên sản phẩm..."
              />
            </div>
            <div class="col-md-3">
              <label for="filter-shop" class="form-label">Tên Cửa hàng</label>
              <input
                type="text"
                class="form-control"
                id="filter-shop"
                placeholder="Nhập tên shop..."
              />
            </div>
            <div class="col-md-3">
              <label for="filter-status" class="form-label">Trạng thái</label>
              <select id="filter-status" class="form-select">
                <option value="">Tất cả</option>
                <option value="true">Hiển thị</option>
                <option value="false">Đã ẩn</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button
                class="btn btn-primary w-100"
                onclick="fetchAllProducts()"
              >
                <i class="bi bi-search"></i> Lọc
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle table-striped mb-0">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th style="width: 50px">Ảnh</th>
                  <th>Tên Sản phẩm</th>
                  <th>Giá</th>
                  <th class="text-center">Tồn kho</th>
                  <th>Cửa hàng</th>
                  <th class="text-center">Trạng thái</th>
                  <th class="text-end">Hành động</th>
                </tr>
              </thead>
              <tbody id="product-table-body">
                <tr>
                  <td colspan="8" class="text-center p-4">Đang tải...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <th:block layout:fragment="scripts_body">
      <script>
        const token = localStorage.getItem("jwtToken");
        const API_URL = "/api/v1/admin/products";
        const tbody = document.getElementById("product-table-body");

        // (MỚI) Lấy các ô lọc
        const filterName = document.getElementById("filter-name");
        const filterShop = document.getElementById("filter-shop");
        const filterStatus = document.getElementById("filter-status");

        document.addEventListener("DOMContentLoaded", fetchAllProducts);

        // (SỬA) Nâng cấp hàm fetch để gửi tham số lọc
        async function fetchAllProducts() {
          tbody.innerHTML =
            '<tr><td colspan="8" class="text-center p-4"><div class="spinner-border spinner-border-sm"></div> Đang tải...</td></tr>';

          // (MỚI) Xây dựng query params
          const params = new URLSearchParams();
          if (filterName.value) params.append("name", filterName.value);
          if (filterShop.value) params.append("shopName", filterShop.value);
          if (filterStatus.value) params.append("isActive", filterStatus.value);

          const url = `${API_URL}?${params.toString()}`;

          try {
            const response = await fetch(url, {
              headers: { Authorization: `Bearer ${token}` },
            });

            if (!response.ok) throw new Error("Lỗi tải dữ liệu sản phẩm.");

            const products = await response.json();

            tbody.innerHTML = "";

            if (products.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="8" class="text-center p-4">Không tìm thấy sản phẩm nào.</td></tr>';
            }

            products.forEach((product) => {
              const isActive = product.active || product.isActive;

              let statusBadge, actionButton;
              if (isActive) {
                statusBadge = `<span class="badge bg-success">Hiển thị</span>`;
                actionButton = `<button class="btn btn-outline-danger btn-sm" onclick="handleToggleStatus(${product.id})">
                                  <i class="bi bi-eye-slash-fill"></i> Ẩn
                                </button>`;
              } else {
                statusBadge = `<span class="badge bg-secondary">Đã ẩn</span>`;
                actionButton = `<button class="btn btn-outline-success btn-sm" onclick="handleToggleStatus(${product.id})">
                                  <i class="bi bi-eye-fill"></i> Hiện
                                </button>`;
              }

              const deleteButton = `<button class="btn btn-outline-dark btn-sm ms-2" onclick="handleDelete(${product.id})">
                                      <i class="bi bi-x-circle-fill"></i> Xóa
                                    </button>`;

              // (MỚI) Xử lý ảnh
              const imageUrl =
                product.images && product.images.length > 0
                  ? product.images[0].imageUrl
                  : "https://via.placeholder.com/50?text=N/A";

              // (SỬA) Thêm cột ảnh, căn lề
              tbody.innerHTML += `
                <tr id="product-row-${product.id}">
                  <td>${product.id}</td>
                  <td>
                    <img src="${imageUrl}" class="product-thumbnail" alt="${
                product.name
              }" onerror="this.src='https://via.placeholder.com/50?text=N/A'">
                  </td>
                  <td>${product.name}</td>
                  <td>${new Intl.NumberFormat("vi-VN").format(
                    product.price
                  )} đ</td>
                  <td class="text-center">${product.stockQuantity}</td>
                  <td>${product.shop ? product.shop.name : "N/A"}</td> 
                  <td class="text-center">${statusBadge}</td>
                  <td class="text-end">${actionButton} ${deleteButton}</td>
                </tr>
              `;
            });
          } catch (err) {
            tbody.innerHTML =
              '<tr><td colspan="8" class="text-center text-danger p-4">Lỗi tải dữ liệu sản phẩm. Vui lòng kiểm tra console.</td></tr>';
          }
        }

        // Hàm xử lý nút Ẩn/Hiện (Giữ nguyên)
        async function handleToggleStatus(productId) {
          try {
            const response = await fetch(
              `${API_URL}/${productId}/toggle-active`,
              {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
              }
            );

            if (response.ok) {
              Swal.fire(
                "Thành công!",
                "Đã cập nhật trạng thái sản phẩm.",
                "success"
              );
              fetchAllProducts(); // Tải lại bảng
            }
          } catch (err) {
            Swal.fire("Lỗi!", "Không thể cập nhật trạng thái.", "error");
          }
        }

        // Hàm xử lý nút Xóa (Giữ nguyên)
        async function handleDelete(productId) {
          Swal.fire({
            title: "Xóa vĩnh viễn?",
            text: "Bạn muốn XÓA VĨNH VIỄN sản phẩm này khỏi hệ thống?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#dc3545",
            cancelButtonText: "Hủy",
            confirmButtonText: "Vâng, xóa!",
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                const response = await fetch(`${API_URL}/${productId}`, {
                  method: "DELETE",
                  headers: { Authorization: `Bearer ${token}` },
                });

                if (!response.ok) throw new Error("Lỗi khi xóa");

                Swal.fire("Đã xóa!", "Sản phẩm đã bị xóa.", "success");
                fetchAllProducts(); // Tải lại bảng
              } catch (err) {
                Swal.fire(
                  "Lỗi",
                  "Không thể xóa. Sản phẩm có thể đã có trong đơn hàng.",
                  "error"
                );
              }
            }
          });
        }
      </script>
    </th:block>
  </body>
</html>
