<!DOCTYPE html>
<html
  lang="vi"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/_admin_layout}"
>
  <head>
    <title>Quản lý Đơn hàng</title>
  </head>
  <body>
    <div layout:fragment="content">
      <h1 class="h2 pt-3 pb-2 mb-3 border-bottom">Quản lý Đơn hàng</h1>

      <div class="card mb-4">
          <div class="card-header">Lọc Đơn hàng</div>
          <div class="card-body">
              <div class="row align-items-end">
                  <div class="col-md-3 mb-3">
                      <label for="start-date" class="form-label">Từ ngày</label>
                      <input type="date" class="form-control" id="start-date">
                  </div>
                  <div class="col-md-3 mb-3">
                      <label for="end-date" class="form-label">Đến ngày</label>
                      <input type="date" class="form-control" id="end-date">
                  </div>
                  <div class="col-md-3 mb-3">
                      <label for="status-filter" class="form-label">Trạng thái</label>
                      <select class="form-select" id="status-filter">
                          <option value="">Tất cả</option>
                          <option value="NEW">Đơn mới</option>
                          <option value="CONFIRMED">Đã xác nhận</option>
                          <option value="READY_FOR_SHIPMENT">Sẵn sàng giao</option>
                          <option value="DELIVERING">Đang giao</option>
                          <option value="DELIVERED">Đã giao</option>
                          <option value="CANCELLED">Đã hủy</option>
                      </select>
                  </div>
                  <div class="col-md-3 mb-3">
                      <button class="btn btn-primary w-100" onclick="fetchAllOrders()">
                          <i class="bi bi-funnel-fill"></i> Lọc
                      </button>
                  </div>
              </div>
          </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Khách hàng</th>
              <th>Tổng tiền</th>
              <th>Trạng thái</th>
              <th>Shipper</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="order-table-body">
            <tr>
              <td colspan="6" class="text-center">Đang tải...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <th:block layout:fragment="scripts_body">
      <script>
        const token = localStorage.getItem("jwtToken");
        const API_URL = "/api/v1/admin/orders";

        document.addEventListener("DOMContentLoaded", initOrderManagement);

        let allShippers = []; // Lưu trữ danh sách shipper

        async function initOrderManagement() {
            await fetchShippers();
            await fetchAllOrders();
        }

        // 1. Lấy danh sách Shipper
        async function fetchShippers() {
            try {
                const response = await fetch(`${API_URL}/shippers`, {
                    headers: { Authorization: `Bearer ${token}` },
                });
                if (response.ok) {
                    allShippers = await response.json();
                }
            } catch (err) {
                console.error("Lỗi tải danh sách shipper:", err);
            }
        }

        // 2. Lấy danh sách Đơn hàng (CÓ LỌC)
        async function fetchAllOrders() {
            const tbody = document.getElementById("order-table-body");
            
            // Lấy giá trị từ các bộ lọc
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const status = document.getElementById('status-filter').value;
            
            // Xây dựng Query Params
            const params = new URLSearchParams();
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            if (status) params.append('status', status);
            
            const url = API_URL + '?' + params.toString(); // Gắn tham số vào URL

            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Đang tải đơn hàng...</td></tr>';

            try {
                const response = await fetch(url, { // Dùng URL đã có tham số
                    headers: { Authorization: `Bearer ${token}` },
                });
                if (!response.ok) throw new Error("Lỗi tải đơn hàng");

                const orders = await response.json();
                tbody.innerHTML = "";

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Không có đơn hàng nào.</td></tr>';
                }

                orders.forEach((order) => {
                    tbody.innerHTML += createOrderRow(order);
                });

            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Lỗi tải dữ liệu đơn hàng.</td></tr>';
            }
        }

        // 3. Hàm tạo HTML cho mỗi dòng đơn hàng (Giữ nguyên)
        function createOrderRow(order) {
            const formatVND = (amount) => {
                return new Intl.NumberFormat('vi-VN', { 
                    style: 'currency', 
                    currency: 'VND',
                    minimumFractionDigits: 0
                }).format(amount);
            };

            const totalAmount = formatVND(order.totalAmount);
            const customerName = order.user ? order.user.fullName : 'Khách vãng lai';
            
            const statusMap = {
                'NEW': { text: 'Đơn mới', class: 'bg-info' },
                'CONFIRMED': { text: 'Đã xác nhận', class: 'bg-primary' },
                'DELIVERING': { text: 'Đang giao', class: 'bg-warning' },
                'DELIVERED': { text: 'Đã giao', class: 'bg-success' },
                'CANCELLED': { text: 'Đã hủy', class: 'bg-danger' },
            };
            const statusInfo = statusMap[order.status] || { text: order.status, class: 'bg-secondary' };

            // Tạo Dropdown chọn Shipper
            let shipperOptions = allShippers.map(shipper => 
                `<option value="${shipper.id}" ${order.shipper && order.shipper.id === shipper.id ? 'selected' : ''}>${shipper.fullName}</option>`
            ).join('');
            
            let shipperSelect = `
                <select class="form-select form-select-sm" id="shipper-select-${order.id}">
                    <option value="">-- Chọn Shipper --</option>
                    ${shipperOptions}
                </select>`;

            let assignButton = '';
            // CHỈ cho phép gán shipper nếu đơn hàng ở trạng thái "READY_FOR_SHIPMENT"
            if (order.status === 'READY_FOR_SHIPMENT') {
                assignButton = `
                    <button class="btn btn-sm btn-primary mt-1" onclick="handleAssignShipper(${order.id})">
                        <i class="bi bi-person-fill-add"></i> Gán
                    </button>`;
            } else {
                // Với các trạng thái khác, chỉ hiển thị tên shipper đã gán (nếu có)
                shipperSelect = `<span class="fw-bold">${order.shipper ? order.shipper.fullName : 'Chưa gán'}</span>`;
            }
            

            return `
                <tr>
                    <td>${order.id}</td>
                    <td>${customerName}</td>
                    <td>${totalAmount}</td>
                    <td><span class="badge ${statusInfo.class}">${statusInfo.text}</span></td>
                    <td>
                        ${shipperSelect}
                    </td>
                    <td>
                        ${assignButton}
                        <a href="/admin/order-detail/${order.id}" class="btn btn-sm btn-info mt-1">Chi tiết</a>
                    </td>
                </tr>
            `;
        }

        // 4. Xử lý Gán Shipper (Giữ nguyên)
        async function handleAssignShipper(orderId) {
            const selectElement = document.getElementById(`shipper-select-${orderId}`);
            const shipperId = selectElement.value;

            if (!shipperId) {
                Swal.fire('Lỗi', 'Vui lòng chọn Shipper để gán.', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/${orderId}/assign-shipper/${shipperId}`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${token}` },
                });

                if (!response.ok) throw new Error("Lỗi khi gán Shipper");

                Swal.fire('Thành công!', 'Đơn hàng đã được gán cho Shipper.', 'success');
                fetchAllOrders(); // Tải lại danh sách
            } catch (err) {
                Swal.fire('Lỗi', 'Không thể gán Shipper. Vui lòng thử lại.', 'error');
            }
        }
      </script>
    </th:block>
  </body>
</html>