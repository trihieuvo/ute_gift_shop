<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Chi tiết sản phẩm</title>
    <style>
        /* CSS cho gallery ảnh */
        .product-gallery-main { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; margin-bottom: 1rem; }
        .product-gallery-thumbnails { display: flex; gap: 10px; }
        .thumbnail-img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.3s; }
        .thumbnail-img.active { border-color: #0d6efd; }

        /* CSS cho sidebar danh mục */
        .category-sidebar { background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,.1); position: sticky; top: 90px; }
        .category-sidebar .nav-link, .category-sidebar .dropdown-item { color: #333; cursor: pointer; font-weight: 500; }
        .category-sidebar .nav-item .nav-link:hover, .category-sidebar .dropdown-item:hover { color: #0d6efd; }
        .category-sidebar .nav-link.active, .category-sidebar .dropdown-item.active { color: #fff; background-color: #0d6efd; border-radius: 0.25rem; }
        .category-sidebar .dropdown-menu { border: none; box-shadow: 0 4px 6px rgba(0,0,0,.1); }
        
        /* CSS cho đánh giá */
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
        .star-rating input[type="radio"] { display: none; }
        .star-rating label { font-size: 2rem; color: #ddd; cursor: pointer; transition: color 0.2s; }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label { color: #ffc107; }

        .review-item { border-bottom: 1px solid #eee; padding-bottom: 1rem; margin-bottom: 1rem; }
        .review-item:last-child { border-bottom: none; }
        .review-stars .bi-star-fill { color: #ffc107; }
        .review-stars .bi-star { color: #ddd; }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="mb-4">
        <a th:href="@{/home}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Quay lại trang chủ</a>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="category-sidebar">
                <h4 class="mb-3">Danh mục</h4>
                <nav id="category-menu" class="nav flex-column"><p>Đang tải...</p></nav>
            </div>
        </div>

        <div class="col-md-9">
            <div id="product-detail-container">
                <div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Đang tải...</p></div>
            </div>

            <hr class="my-5">
            <div class="row">
                <div class="col-12">
                    <h3 class="mb-4">Đánh giá sản phẩm</h3>

                    <div id="review-form-container" class="card card-body mb-4 d-none">
                        <h5>Viết đánh giá của bạn</h5>
                        <form id="review-form">
                            <input type="hidden" id="review-order-detail-id">
                            <div class="mb-3">
                                <label class="form-label">Xếp hạng của bạn:</label>
                                <div class="star-rating">
                                    <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 sao"><i class="bi bi-star-fill"></i></label>
                                    <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 sao"><i class="bi bi-star-fill"></i></label>
                                    <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 sao"><i class="bi bi-star-fill"></i></label>
                                    <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 sao"><i class="bi bi-star-fill"></i></label>
                                    <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 sao"><i class="bi bi-star-fill"></i></label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="review-comment" class="form-label">Bình luận (tùy chọn):</label>
                                <textarea id="review-comment" class="form-control" rows="4" placeholder="Sản phẩm này tuyệt vời..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
                        </form>
                    </div>
                    <div id="review-eligibility-message" class="alert alert-info d-none"></div>

                    <div id="review-list-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts_body">
    <script th:inline="javascript">
        /*<![CDATA[*/
        const productId = /*[[${productId}]]*/ '0';
        const token = localStorage.getItem('jwtToken');
        /*]]>*/

        // === DOM ELEMENTS ===
        const productDetailContainer = document.getElementById('product-detail-container');
        const categoryMenu = document.getElementById('category-menu');
        const reviewFormContainer = document.getElementById('review-form-container');
        const reviewEligibilityMsg = document.getElementById('review-eligibility-message');
        const reviewListContainer = document.getElementById('review-list-container');
        const reviewForm = document.getElementById('review-form');

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            fetchProductDetails();
            fetchAndDisplayCategories();
            fetchAndRenderReviews();
            checkReviewEligibility();
            
            reviewForm.addEventListener('submit', handleReviewSubmit);
        });

        // ===============================================
        // SECTION 1: PRODUCT DETAILS & CORE ACTIONS
        // ===============================================

        async function fetchProductDetails() {
            try {
                const response = await fetch(`/api/products/${productId}`);
                if (!response.ok) throw new Error('Không tìm thấy sản phẩm');
                const product = await response.json();
                renderProductDetails(product);
            } catch (error) {
                productDetailContainer.innerHTML = `<p class="text-danger text-center">${error.message}</p>`;
            }
        }

        function renderProductDetails(product) {
            document.title = product.name; // Cập nhật tiêu đề trang
            let galleryHtml = '<p>Không có hình ảnh.</p>';
            if (product.images && product.images.length > 0) {
                const mainImage = product.images[0].imageUrl;
                const thumbnails = product.images.map((img, index) => `
                    <img src="${img.imageUrl}" class="thumbnail-img ${index === 0 ? 'active' : ''}" onclick="changeMainImage(this, '${img.imageUrl}')">
                `).join('');
                galleryHtml = `
                    <img src="${mainImage}" id="main-product-image" class="product-gallery-main" alt="Ảnh chính">
                    <div class="product-gallery-thumbnails">${thumbnails}</div>
                `;
            }
            productDetailContainer.innerHTML = `
                <div class="row">
                    <div class="col-md-6">${galleryHtml}</div>
                    <div class="col-md-6">
                        <h2>${product.name}</h2>
                        <h3 class="text-danger">${product.price.toLocaleString('vi-VN')} đ</h3>
                        <p class="text-muted">Tình trạng: <strong>Còn hàng</strong></p>
                        <hr>
                        <p>${product.description || 'Chưa có mô tả cho sản phẩm này.'}</p>
                        <hr>
                        <div class="d-flex align-items-center gap-3">
                            <label for="quantity">Số lượng:</label>
                            <input type="number" id="quantity" class="form-control" value="1" min="1" style="width: 80px;">
                            <button class="btn btn-primary" onclick="addToCart()">
                                <i class="bi bi-cart-plus"></i> Thêm vào giỏ hàng
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function changeMainImage(thumbnailElement, newSrc) {
            document.getElementById('main-product-image').src = newSrc;
            document.querySelectorAll('.thumbnail-img').forEach(img => img.classList.remove('active'));
            thumbnailElement.classList.add('active');
        }

        async function addToCart() {
            if (!token) {
                Swal.fire('Vui lòng đăng nhập', 'Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng.', 'info')
                   .then(() => window.location.href = '/login');
                return;
            }
            const quantity = document.getElementById('quantity').value;
            try {
                const response = await fetch('/api/cart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId: productId, quantity: parseInt(quantity) })
                });
                if (response.ok) {
                    Swal.fire('Thành công!', 'Đã thêm sản phẩm vào giỏ hàng.', 'success');
                } else {
                    const error = await response.text();
                    Swal.fire('Lỗi!', `Không thể thêm vào giỏ: ${error}`, 'error');
                }
            } catch (e) {
                Swal.fire('Lỗi', 'Lỗi mạng khi thêm sản phẩm.', 'error');
            }
        }

        // ===============================================
        // SECTION 2: CATEGORY SIDEBAR
        // ===============================================

        async function fetchAndDisplayCategories() {
            try {
                const response = await fetch('/api/categories');
                if (!response.ok) throw new Error('Lỗi khi tải danh mục');
                
                const categories = await response.json();
                categoryMenu.innerHTML = `<li class="nav-item"><a class="nav-link" onclick="filterProductsByCategory(null)">Tất cả sản phẩm</a></li>`;

                categories.forEach(category => {
                    if (category.children && category.children.length > 0) {
                        const childrenHtml = category.children.map(child => `
                            <li><a class="dropdown-item" onclick="filterProductsByCategory(${child.id})">${child.name}</a></li>
                        `).join('');
                        categoryMenu.innerHTML += `
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="filterProductsByCategory(${category.id})">
                                    ${category.name}
                                </a>
                                <ul class="dropdown-menu">${childrenHtml}</ul>
                            </li>`;
                    } else {
                        categoryMenu.innerHTML += `<li class="nav-item"><a class="nav-link" onclick="filterProductsByCategory(${category.id})">${category.name}</a></li>`;
                    }
                });
            } catch (error) {
                categoryMenu.innerHTML = '<p class="text-danger small">Không thể tải danh mục.</p>';
            }
        }

        function filterProductsByCategory(categoryId) {
            let homeUrl = '/home';
            if (categoryId) {
                homeUrl += `?category=${categoryId}`;
            }
            window.location.href = homeUrl;
        }
        
        // ===============================================
        // SECTION 3: REVIEWS
        // ===============================================

        async function fetchAndRenderReviews() {
            reviewListContainer.innerHTML = '<p>Đang tải đánh giá...</p>';
            try {
                const response = await fetch(`/api/reviews/product/${productId}`);
                if (!response.ok) throw new Error('Không thể tải đánh giá');
                const reviews = await response.json();
                
                if (reviews.length === 0) {
                    reviewListContainer.innerHTML = '<p class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>';
                    return;
                }
                
                reviewListContainer.innerHTML = '';
                reviews.forEach(review => {
                    let starsHtml = Array(5).fill(0).map((_, i) => 
                        `<i class="bi ${i < review.rating ? 'bi-star-fill' : 'bi-star'}"></i>`
                    ).join('');

                    reviewListContainer.innerHTML += `
                        <div class="review-item">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong class="text-dark">${review.userFullName}</strong>
                                <small class="text-muted">${review.createdAt}</small>
                            </div>
                            <div class="review-stars mb-2">${starsHtml}</div>
                            <p class="mb-0">${review.comment || ''}</p>
                        </div>
                    `;
                });
            } catch(e) {
                reviewListContainer.innerHTML = '<p class="text-danger">Lỗi khi tải đánh giá.</p>';
            }
        }
        
        async function checkReviewEligibility() {
            if (!token) {
                reviewEligibilityMsg.textContent = 'Bạn cần đăng nhập để có thể đánh giá sản phẩm.';
                reviewEligibilityMsg.classList.remove('d-none');
                return;
            }
            try {
                const response = await fetch(`/api/reviews/eligibility/${productId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.eligible) {
                    reviewFormContainer.classList.remove('d-none');
                    document.getElementById('review-order-detail-id').value = data.orderDetailId;
                } else {
                    reviewEligibilityMsg.textContent = data.message;
                    reviewEligibilityMsg.classList.remove('d-none');
                }
            } catch(e) {
                console.error("Lỗi khi kiểm tra điều kiện đánh giá:", e);
            }
        }

        async function handleReviewSubmit(event) {
            event.preventDefault();
            const ratingValue = document.querySelector('input[name="rating"]:checked');
            if (!ratingValue) {
                Swal.fire('Lỗi', 'Vui lòng chọn số sao để đánh giá.', 'warning');
                return;
            }

            const requestBody = {
                productId: parseInt(productId),
                orderDetailId: parseInt(document.getElementById('review-order-detail-id').value),
                rating: parseInt(ratingValue.value),
                comment: document.getElementById('review-comment').value.trim()
            };

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();

                if (response.ok) {
                    Swal.fire('Thành công', 'Cảm ơn bạn đã gửi đánh giá!', 'success');
                    reviewFormContainer.classList.add('d-none');
                    reviewEligibilityMsg.textContent = 'Bạn đã đánh giá sản phẩm này.';
                    reviewEligibilityMsg.classList.remove('d-none');
                    fetchAndRenderReviews();
                } else {
                    Swal.fire('Lỗi', result.message || 'Không thể gửi đánh giá.', 'error');
                }
            } catch(e) {
                Swal.fire('Lỗi', 'Lỗi mạng, không thể gửi đánh giá.', 'error');
            }
        }
    </script>
</th:block>

</body>
</html>