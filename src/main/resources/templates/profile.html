<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Thông tin cá nhân</title>
    <style>
        .profile-nav .list-group-item {
            cursor: pointer;
        }
        .profile-nav .list-group-item.active {
            font-weight: bold;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <h1 class="mb-4">Tài khoản của tôi</h1>
    <div class="row">
        <div class="col-md-3">
            <div class="list-group profile-nav">
                <a class="list-group-item list-group-item-action active" data-target="profile-info">Thông tin cá nhân</a>
                <a class="list-group-item list-group-item-action" data-target="address-book">Sổ địa chỉ</a>
                <a class="list-group-item list-group-item-action" data-target="change-password">Đổi mật khẩu</a>
            </div>
        </div>

        <div class="col-md-9">
            <div id="profile-info" class="profile-section">
                <h4>Hồ sơ của tôi</h4>
                <p>Quản lý thông tin hồ sơ để bảo mật tài khoản</p>
                <hr>
                <form id="profileForm">
                    <div class="mb-3 row">
                        <label for="email" class="col-sm-3 col-form-label">Email</label>
                        <div class="col-sm-9">
                            <input type="email" readonly class="form-control-plaintext" id="email">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="fullName" class="col-sm-3 col-form-label">Họ và Tên</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="phoneNumberProfile" class="col-sm-3 col-form-label">Số điện thoại</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="phoneNumberProfile">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-9 offset-sm-3">
                            <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                        </div>
                    </div>
                </form>
            </div>

            <div id="address-book" class="profile-section d-none">
                 <h4>Sổ địa chỉ</h4>
                 <hr>
                <div id="address-list-profile"></div>
                <button class="btn btn-secondary mt-3" data-bs-toggle="modal" data-bs-target="#addressModal">Thêm địa chỉ mới</button>
            </div>

            <div id="change-password" class="profile-section d-none">
                <h4>Đổi mật khẩu</h4>
                 <p>Để bảo mật tài khoản, vui lòng không chia sẻ mật khẩu cho người khác</p>
                <hr>
                <form id="changePasswordForm" class="mt-3">
                    <div class="mb-3 row">
                        <label for="currentPassword" class="col-sm-4 col-form-label">Mật khẩu hiện tại</label>
                        <div class="col-sm-8">
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="newPassword" class="col-sm-4 col-form-label">Mật khẩu mới</label>
                        <div class="col-sm-8">
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                    </div>
                     <div class="mb-3 row">
                        <label for="confirmNewPassword" class="col-sm-4 col-form-label">Xác nhận mật khẩu mới</label>
                        <div class="col-sm-8">
                            <input type="password" class="form-control" id="confirmNewPassword" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-8 offset-sm-4">
                            <button type="submit" class="btn btn-primary">Xác nhận</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addressModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm địa chỉ mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addAddressForm">
                        <div class="mb-3">
                            <label for="recipientName" class="form-label">Tên người nhận</label>
                            <input type="text" class="form-control" id="recipientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="phoneNumberAddress" class="form-label">Số điện thoại</label>
                            <input type="text" class="form-control" id="phoneNumberAddress" required>
                        </div>
                        <div class="mb-3">
                            <label for="fullAddress" class="form-label">Địa chỉ chi tiết</label>
                            <input type="text" class="form-control" id="fullAddress" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Lưu địa chỉ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts_body">
<script>
    const token = localStorage.getItem('jwtToken');

    // === QUẢN LÝ HIỂN THỊ CÁC TAB ===
    document.querySelectorAll('.profile-nav .list-group-item').forEach(navLink => {
        navLink.addEventListener('click', function(e) {
            e.preventDefault();
            // Xóa active class khỏi tất cả link
            document.querySelectorAll('.profile-nav .list-group-item').forEach(link => link.classList.remove('active'));
            // Thêm active class cho link được click
            this.classList.add('active');
            
            // Ẩn tất cả các section nội dung
            document.querySelectorAll('.profile-section').forEach(section => section.classList.add('d-none'));
            // Hiển thị section tương ứng
            const targetId = this.getAttribute('data-target');
            document.getElementById(targetId).classList.remove('d-none');
        });
    });

    // === LOGIC LẤY VÀ CẬP NHẬT THÔNG TIN CÁ NHÂN ===
    async function fetchCurrentUser() {
        const response = await fetch('/api/users/me', { headers: { 'Authorization': `Bearer ${token}` } });
        const userInfo = await response.json();
        if (userInfo.authenticated) {
            document.getElementById('email').value = userInfo.email;
            document.getElementById('fullName').value = userInfo.fullName || '';
            document.getElementById('phoneNumberProfile').value = userInfo.phoneNumber || '';
        }
    }

    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const response = await fetch('/api/users/me', {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                fullName: document.getElementById('fullName').value,
                phoneNumber: document.getElementById('phoneNumberProfile').value
            })
        });
        const responseText = await response.text();
        if (response.ok) {
            Swal.fire('Thành công', responseText, 'success');
        } else {
            Swal.fire('Lỗi', responseText, 'error');
        }
    });

    // === LOGIC ĐỔI MẬT KHẨU ===
    document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;

        if (newPassword !== confirmNewPassword) {
            Swal.fire('Lỗi', 'Mật khẩu mới và mật khẩu xác nhận không khớp.', 'warning');
            return;
        }

        const response = await fetch('/api/users/me/change-password', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                currentPassword: document.getElementById('currentPassword').value,
                newPassword: newPassword
            })
        });
        const responseText = await response.text();
         if (response.ok) {
            Swal.fire('Thành công', responseText, 'success');
            this.reset(); // Xóa các trường trong form
        } else {
            Swal.fire('Lỗi', responseText, 'error');
        }
    });

    // === LOGIC SỔ ĐỊA CHỈ (Giữ nguyên) ===
    async function fetchAddressesForProfile() {
        const response = await fetch('/api/addresses', { headers: { 'Authorization': `Bearer ${token}` } });
        const addresses = await response.json();
        const container = document.getElementById('address-list-profile');
        container.innerHTML = '';
        addresses.forEach(addr => {
            container.innerHTML += `
                <div class="card card-body mb-2">
                    <strong>${addr.recipientName}</strong> - ${addr.phoneNumber}<br>
                    ${addr.fullAddress}
                </div>`;
        });
    }
    
    document.getElementById('addAddressForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const response = await fetch('/api/addresses', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                recipientName: document.getElementById('recipientName').value,
                phoneNumber: document.getElementById('phoneNumberAddress').value,
                fullAddress: document.getElementById('fullAddress').value
            })
        });

        if (response.ok) {
            var myModalEl = document.getElementById('addressModal');
            var modal = bootstrap.Modal.getInstance(myModalEl);
            modal.hide();
            this.reset();
            fetchAddressesForProfile(); // Tải lại danh sách địa chỉ
        } else {
            Swal.fire('Lỗi', 'Không thể thêm địa chỉ', 'error');
        }
    });

    // === GỌI CÁC HÀM KHỞI TẠO KHI TRANG TẢI XONG ===
    document.addEventListener('DOMContentLoaded', () => {
        fetchCurrentUser();
        fetchAddressesForProfile();
    });
</script>
</th:block>
</body>
</html>