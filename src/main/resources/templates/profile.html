<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_app_layout}">
<head>
    <title>Thông tin cá nhân</title>
    <style>
        .profile-nav .list-group-item {
            cursor: pointer;
            font-weight: 500;
        }
        .profile-nav .list-group-item.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
            font-weight: bold;
        }
        .profile-nav .list-group-item i {
            margin-right: 10px;
            width: 20px; /* Align icons */
        }
        .card-header h5 {
            margin-bottom: 0;
        }
        .address-card {
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .address-card.is-default {
            border-left: 4px solid #0d6efd;
        }
        .address-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        /* CSS cho tab đăng ký vai trò */
        #applyRoleForm[disabled] {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <h1 class="mb-4">Tài khoản của tôi</h1>
    <div class="row">
        <div class="col-md-3">
            <div class="list-group profile-nav shadow-sm">
                <a class="list-group-item list-group-item-action active" data-target="profile-info">
                    <i class="bi bi-person-fill"></i>Hồ sơ của tôi
                </a>
                <a class="list-group-item list-group-item-action" data-target="address-book">
                    <i class="bi bi-geo-alt-fill"></i>Sổ địa chỉ
                </a>
                <a class="list-group-item list-group-item-action" data-target="change-password">
                    <i class="bi bi-shield-lock-fill"></i>Đổi mật khẩu
                </a>
                <a class="list-group-item list-group-item-action" data-target="apply-role" id="apply-role-tab">
                    <i class="bi bi-briefcase-fill"></i>Đăng ký vai trò
                </a>
                </div>
        </div>

        <div class="col-md-9">
            <div id="profile-info" class="profile-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5><i class="bi bi-person-badge"></i> Hồ sơ của tôi</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted">Quản lý thông tin hồ sơ để bảo mật tài khoản.</p>
                        <hr>
                        <form id="profileForm">
                            <div class="mb-3 row">
                                <label for="email" class="col-sm-3 col-form-label">Email</label>
                                <div class="col-sm-9">
                                    <input type="email" readonly class="form-control-plaintext" id="email">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="fullName" class="col-sm-3 col-form-label">Họ và Tên</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="fullName" required>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="phoneNumberProfile" class="col-sm-3 col-form-label">Số điện thoại</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="phoneNumberProfile">
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-sm-9 offset-sm-3">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Lưu thay đổi</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="address-book" class="profile-section d-none">
                 <div class="card shadow-sm">
                     <div class="card-header bg-light d-flex justify-content-between align-items-center">
                         <h5><i class="bi bi-book-fill"></i> Sổ địa chỉ</h5>
                         <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                             <i class="bi bi-plus-circle"></i> Thêm địa chỉ mới
                         </button>
                     </div>
                     <div class="card-body">
                        <div id="address-list-profile">
                            <p class="text-center p-3">Đang tải danh sách địa chỉ...</p>
                        </div>
                     </div>
                 </div>
            </div>

            <div id="change-password" class="profile-section d-none">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5><i class="bi bi-key-fill"></i> Đổi mật khẩu</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted">Để bảo mật tài khoản, vui lòng không chia sẻ mật khẩu cho người khác.</p>
                        <hr>
                        <form id="changePasswordForm" class="mt-3">
                            <div class="mb-3 row">
                                <label for="currentPassword" class="col-sm-4 col-form-label">Mật khẩu hiện tại</label>
                                <div class="col-sm-8">
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="newPassword" class="col-sm-4 col-form-label">Mật khẩu mới</label>
                                <div class="col-sm-8">
                                    <input type="password" class="form-control" id="newPassword" required>
                                </div>
                            </div>
                             <div class="mb-3 row">
                                <label for="confirmNewPassword" class="col-sm-4 col-form-label">Xác nhận mật khẩu</label>
                                <div class="col-sm-8">
                                    <input type="password" class="form-control" id="confirmNewPassword" required>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-sm-8 offset-sm-4">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle"></i> Xác nhận</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="apply-role" class="profile-section d-none">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5><i class="bi bi-briefcase-fill"></i> Đăng ký vai trò (Vendor/Shipper)</h5>
                    </div>
                    <div class="card-body">
                        <div id="application-status-message" class="alert alert-info d-none"></div>
                        
                        <form id="applyRoleForm">
                            <p class="card-text text-muted">Chọn vai trò bạn muốn đăng ký và gửi yêu cầu để Admin xem xét.</p>
                            <div class="mb-3">
                                <label for="requestedRole" class="form-label">Vai trò mong muốn</label>
                                <select class="form-select" id="requestedRole" required>
                                    <option value="" selected disabled>-- Chọn một vai trò --</option>
                                    <option value="Vendor">Người bán hàng (Vendor)</option>
                                    <option value="Shipper">Người giao hàng (Shipper)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="applicationMessage" class="form-label">Lời nhắn (Lý do đăng ký)</label>
                                <textarea class="form-control" id="applicationMessage" rows="4" placeholder="Ví dụ: Tôi muốn mở cửa hàng bán đồ thủ công..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-send-check"></i> Gửi yêu cầu
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <div class="modal fade" id="addAddressModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm địa chỉ mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addAddressForm">
                        <div class="mb-3">
                            <label for="recipientName" class="form-label">Tên người nhận</label>
                            <input type="text" class="form-control" id="recipientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="phoneNumberAddress" class="form-label">Số điện thoại</label>
                            <input type="text" class="form-control" id="phoneNumberAddress" required>
                        </div>
                        <div class="mb-3">
                            <label for="fullAddress" class="form-label">Địa chỉ chi tiết</label>
                            <input type="text" class="form-control" id="fullAddress" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Lưu địa chỉ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="editAddressModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa địa chỉ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAddressForm">
                        <input type="hidden" id="editAddressId">
                        <div class="mb-3">
                            <label for="editRecipientName" class="form-label">Tên người nhận</label>
                            <input type="text" class="form-control" id="editRecipientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPhoneNumberAddress" class="form-label">Số điện thoại</label>
                            <input type="text" class="form-control" id="editPhoneNumberAddress" required>
                        </div>
                        <div class="mb-3">
                            <label for="editFullAddress" class="form-label">Địa chỉ chi tiết</label>
                            <input type="text" class="form-control" id="editFullAddress" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Lưu thay đổi</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts_body">
<script>
    const token = localStorage.getItem('jwtToken');
    let userAddresses = [];
    let currentUserInfo = null; // Biến lưu thông tin user

    // === QUẢN LÝ HIỂN THỊ CÁC TAB ===
    document.querySelectorAll('.profile-nav .list-group-item').forEach(navLink => {
        navLink.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.profile-nav .list-group-item').forEach(link => link.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.profile-section').forEach(section => section.classList.add('d-none'));
            const targetId = this.getAttribute('data-target');
            document.getElementById(targetId).classList.remove('d-none');
        });
    });

    // === LOGIC LẤY VÀ CẬP NHẬT THÔNG TIN CÁ NHÂN ===
    async function fetchCurrentUser() {
        if (!token) {
            window.location.href = '/login';
            return;
        }
        const response = await fetch('/api/users/me', { headers: { 'Authorization': `Bearer ${token}` } });
        
        if (!response.ok) {
             Swal.fire('Lỗi', 'Phiên đăng nhập hết hạn.', 'error').then(() => window.location.href = '/login');
             return;
        }

        const userInfo = await response.json();
        if (userInfo.authenticated) {
            currentUserInfo = userInfo; // Lưu thông tin user
            document.getElementById('email').value = userInfo.email;
            document.getElementById('fullName').value = userInfo.fullName || '';
            document.getElementById('phoneNumberProfile').value = userInfo.phoneNumber || '';

            // === KIỂM TRA VAI TRÒ (ĐỂ ẨN/HIỆN TAB ĐĂNG KÝ) ===
            checkUserRoleAndApplicationStatus();
            // === KẾT THÚC ===
        }
    }

    // === CẬP NHẬT HỒ SƠ ===
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const response = await fetch('/api/users/me', {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                fullName: document.getElementById('fullName').value,
                phoneNumber: document.getElementById('phoneNumberProfile').value
            })
        });
        const responseText = await response.text();
        if (response.ok) {
            Swal.fire('Thành công', responseText, 'success');
        } else {
            Swal.fire('Lỗi', responseText, 'error');
        }
    });

    // === ĐỔI MẬT KHẨU ===
    document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;

        if (newPassword !== confirmNewPassword) {
            Swal.fire('Lỗi', 'Mật khẩu mới và mật khẩu xác nhận không khớp.', 'warning');
            return;
        }

        const response = await fetch('/api/users/me/change-password', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                currentPassword: document.getElementById('currentPassword').value,
                newPassword: newPassword
            })
        });
        const responseText = await response.text();
         if (response.ok) {
            Swal.fire('Thành công', responseText, 'success');
            this.reset();
        } else {
            Swal.fire('Lỗi', responseText, 'error');
        }
    });

    // === LOGIC SỔ ĐỊA CHỈ (Tải và render) ===
    async function fetchAddressesForProfile() {
        const response = await fetch('/api/addresses', { headers: { 'Authorization': `Bearer ${token}` } });
        userAddresses = await response.json();
        
        userAddresses.sort((a, b) => (b.default ? 1 : 0) - (a.default ? 1 : 0));

        const container = document.getElementById('address-list-profile');
        container.innerHTML = '';
        
        if (userAddresses.length === 0) {
            container.innerHTML = '<p class="text-center text-muted p-3">Bạn chưa có địa chỉ nào.</p>';
            return;
        }

        userAddresses.forEach(addr => {
            const isDefault = addr.default;
            const defaultClass = isDefault ? 'is-default' : '';
            const defaultBadge = isDefault ? '<span class="badge bg-primary me-2">Mặc định</span>' : '';
            
            const deleteButton = isDefault 
                ? `<button class="btn btn-sm btn-outline-danger" disabled title="Không thể xóa địa chỉ mặc định"><i class="bi bi-trash"></i></button>`
                : `<button class="btn btn-sm btn-outline-danger" onclick="deleteAddress(${addr.id})"><i class="bi bi-trash"></i></button>`;

            const setDefaultButton = !isDefault
                ? `<button class="btn btn-sm btn-outline-success" onclick="setDefaultAddress(${addr.id})">Đặt làm mặc định</button>`
                : '';
            
            const editButton = `<button class="btn btn-sm btn-outline-primary" onclick="openEditModal(${addr.id})"><i class="bi bi-pencil-square"></i></button>`;

            container.innerHTML += `
                <div class="address-card ${defaultClass}">
                    <div class="address-actions d-flex gap-2">
                        ${setDefaultButton}
                        ${editButton}
                        ${deleteButton}
                    </div>
                    <div>
                        <strong>${addr.recipientName}</strong>
                        ${defaultBadge}
                    </div>
                    <p class="text-muted mb-1">${addr.phoneNumber}</p>
                    <p class="mb-0">${addr.fullAddress}</p>
                </div>`;
        });
    }
    
    // === SỔ ĐỊA CHỈ (Thêm) ===
    document.getElementById('addAddressForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const response = await fetch('/api/addresses', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                recipientName: document.getElementById('recipientName').value,
                phoneNumber: document.getElementById('phoneNumberAddress').value,
                fullAddress: document.getElementById('fullAddress').value
            })
        });

        if (response.ok) {
            var myModalEl = document.getElementById('addAddressModal');
            var modal = bootstrap.Modal.getInstance(myModalEl);
            modal.hide();
            this.reset();
            fetchAddressesForProfile(); 
        } else {
            Swal.fire('Lỗi', 'Không thể thêm địa chỉ', 'error');
        }
    });

    // === SỔ ĐỊA CHỈ (Xóa) ===
    async function deleteAddress(addressId) {
        Swal.fire({
            title: 'Bạn chắc chắn muốn xóa?',
            text: "Bạn không thể hoàn tác hành động này!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonText: 'Không',
            confirmButtonText: 'Vâng, xóa nó!'
        }).then(async (result) => {
            if (result.isConfirmed) {
                const response = await fetch(`/api/addresses/${addressId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const responseText = await response.text();
                if (response.ok) {
                    Swal.fire('Đã xóa!', responseText, 'success');
                    fetchAddressesForProfile();
                } else {
                    Swal.fire('Lỗi!', responseText, 'error');
                }
            }
        });
    }

    // === SỔ ĐỊA CHỈ (Đặt làm mặc định) ===
    async function setDefaultAddress(addressId) {
        const response = await fetch(`/api/addresses/${addressId}/set-default`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const responseText = await response.text();
        if (response.ok) {
            Swal.fire({
                title: 'Thành công!',
                text: responseText,
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
            fetchAddressesForProfile();
        } else {
            Swal.fire('Lỗi!', responseText, 'error');
        }
    }

    // === SỔ ĐỊA CHỈ (Mở Modal Sửa) ===
    function openEditModal(addressId) {
        const addressToEdit = userAddresses.find(addr => addr.id === addressId);
        if (!addressToEdit) return;

        document.getElementById('editAddressId').value = addressToEdit.id;
        document.getElementById('editRecipientName').value = addressToEdit.recipientName;
        document.getElementById('editPhoneNumberAddress').value = addressToEdit.phoneNumber;
        document.getElementById('editFullAddress').value = addressToEdit.fullAddress;

        var myModal = new bootstrap.Modal(document.getElementById('editAddressModal'));
        myModal.show();
    }

    // === SỔ ĐỊA CHỈ (Submit Sửa) ===
    document.getElementById('editAddressForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const addressId = document.getElementById('editAddressId').value;
        
        const response = await fetch(`/api/addresses/${addressId}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                recipientName: document.getElementById('editRecipientName').value,
                phoneNumber: document.getElementById('editPhoneNumberAddress').value,
                fullAddress: document.getElementById('editFullAddress').value
            })
        });

        const responseText = await response.text();
        if (response.ok) {
            var myModalEl = document.getElementById('editAddressModal');
            var modal = bootstrap.Modal.getInstance(myModalEl);
            modal.hide();
            Swal.fire('Thành công', responseText, 'success');
            fetchAddressesForProfile();
        } else {
            Swal.fire('Lỗi', responseText, 'error');
        }
    });

    // === LOGIC ĐĂNG KÝ VAI TRÒ (MỚI) ===
    
    const applyRoleTab = document.getElementById('apply-role-tab');
    const applyRoleForm = document.getElementById('applyRoleForm');
    const applicationStatusMessage = document.getElementById('application-status-message');

    /**
     * Kiểm tra vai trò của user và trạng thái đơn đăng ký (nếu có)
     */
    async function checkUserRoleAndApplicationStatus() {
        if (!currentUserInfo) return;

        // 1. Nếu user không còn là "Customer" (đã là Vendor/Shipper/Admin)
        if (currentUserInfo.role !== 'Customer') {
            applyRoleTab.classList.add('d-none'); // Ẩn luôn tab đăng ký
            document.getElementById('apply-role').classList.add('d-none'); // Ẩn nội dung
            return;
        }
        
        // 2. Nếu là Customer, kiểm tra xem có đơn đang chờ không
        try {
            const response = await fetch('/api/apply/my-status', { 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            const statusData = await response.json();

            if (statusData.hasPendingApplication) {
                // Vô hiệu hóa form
                applyRoleForm.setAttribute('disabled', 'true');
                // Hiển thị thông báo
                applicationStatusMessage.textContent = `Bạn đã có một đơn đăng ký vai trò "${statusData.requestedRole}" đang ở trạng thái "PENDING". Vui lòng chờ Admin duyệt.`;
                applicationStatusMessage.classList.remove('d-none', 'alert-success');
                applicationStatusMessage.classList.add('alert-info');
            } else {
                // Cho phép nộp đơn
                applyRoleForm.removeAttribute('disabled');
                applicationStatusMessage.classList.add('d-none');
            }
        } catch (error) {
            console.error("Lỗi kiểm tra trạng thái đơn:", error);
            applicationStatusMessage.textContent = "Lỗi khi kiểm tra trạng thái đăng ký.";
            applicationStatusMessage.classList.add('alert-danger');
            applicationStatusMessage.classList.remove('d-none');
        }
    }

    /**
     * Xử lý nộp đơn đăng ký vai trò
     */
    applyRoleForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const requestedRole = document.getElementById('requestedRole').value;
        const message = document.getElementById('applicationMessage').value;

        if (!requestedRole) {
            Swal.fire('Lỗi', 'Vui lòng chọn vai trò bạn muốn đăng ký.', 'warning');
            return;
        }
        
        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang gửi...';

        try {
            const response = await fetch('/api/apply/role', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    requestedRole: requestedRole,
                    message: message
                })
            });

            const result = await response.json();

            if (response.ok) {
                Swal.fire('Thành công!', result.message, 'success');
                checkUserRoleAndApplicationStatus(); // Cập nhật lại trạng thái (vô hiệu hóa form)
            } else {
                Swal.fire('Lỗi!', result.message || 'Không thể gửi đơn.', 'error');
            }

        } catch (error) {
            Swal.fire('Lỗi!', 'Lỗi mạng, không thể gửi đơn đăng ký.', 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="bi bi-send-check"></i> Gửi yêu cầu';
        }
    });
    // === KẾT THÚC LOGIC MỚI ===


    // === GỌI CÁC HÀM KHỞI TẠO KHI TRANG TẢI XONG ===
    document.addEventListener('DOMContentLoaded', () => {
        fetchCurrentUser();
        fetchAddressesForProfile();
        // (checkUserRoleAndApplicationStatus() sẽ được gọi bên trong fetchCurrentUser())
    });
</script>
</th:block>
</body>
</html>