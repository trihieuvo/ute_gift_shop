<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_vendor_layout}">
<head>
    <title>Quản lý Cửa hàng</title>
    <style>
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 1rem;
        }
        .status-indicator i {
            font-size: 1.25rem;
        }
        .shop-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        .shop-info-card h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .shop-info-card p {
            font-size: 1.1rem;
            opacity: 0.95;
            margin-bottom: 0;
        }
        .info-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        .info-section-title {
            color: #667eea;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        .info-section-title i {
            font-size: 1.3rem;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .form-control, .form-select {
            border-radius: 0.5rem;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            transition: all 0.3s;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        }
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        .btn-save-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 0.875rem 2.5rem;
            font-weight: 600;
            font-size: 1rem;
            color: white;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        .btn-save-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        .btn-outline-secondary {
            border: 2px solid #6c757d;
            padding: 0.875rem 2rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        .btn-outline-secondary:hover {
            transform: translateY(-2px);
        }
        .btn-loading {
            position: relative;
            pointer-events: none;
            color: transparent !important;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            height: 1.2rem;
            width: 1.2rem;
            margin-left: -0.6rem;
            margin-top: -0.6rem;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spinner-border .75s linear infinite;
            color: white !important;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        .status-badge-container {
            background: #f8f9fa;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
        }
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 1rem;
        }
        .char-counter {
            font-size: 0.875rem;
            color: #6c757d;
            text-align: right;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <!-- Header -->
    <div class="mb-4">
        <h1 class="h2 mb-2" style="color: #2d3748; font-weight: 700;">
            <i class="bi bi-shop-window me-2"></i>Quản lý Cửa hàng
        </h1>
        <p class="text-muted mb-0">Cập nhật thông tin và mô tả cửa hàng của bạn</p>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center py-5">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted fs-5">Đang tải thông tin cửa hàng...</p>
    </div>
    
    <!-- Error Message -->
    <div id="errorMessage" class="alert alert-danger d-none" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
            <div>
                <strong>Có lỗi xảy ra!</strong>
                <div id="errorMessageText" class="mt-1"></div>
            </div>
        </div>
    </div>

    <!-- Shop Form -->
    <div id="shopForm" class="d-none">
        
        <!-- Shop Info Header Card -->
        <div class="shop-info-card">
            <div class="d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                    <h2 id="shopNameDisplay">Tên cửa hàng</h2>
                    <p class="mb-0"><i class="bi bi-calendar-check me-2"></i>Thành viên từ <span id="shopCreatedDate">2025</span></p>
                </div>
                <div id="shopStatusContainer" class="status-indicator bg-white bg-opacity-25" style="border: 2px solid rgba(255,255,255,0.3);">
                    <i class="bi bi-circle-fill" id="shopStatusIcon"></i>
                    <span id="shopStatus">Đang tải...</span>
                </div>
            </div>
        </div>

        <form id="updateShopForm">
            <div class="row">
                <!-- Left Column -->
                <div class="col-lg-6">
                    <!-- Basic Info Section -->
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="bi bi-info-circle-fill"></i>
                            <span>Thông tin cơ bản</span>
                        </div>
                        
                        <div class="mb-4">
                            <label for="shopName" class="form-label">
                                Tên cửa hàng <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="shopName" required 
                                   maxlength="255" placeholder="VD: Shop Thời Trang Trẻ">
                            <div class="char-counter">
                                <span id="nameCounter">0</span>/255 ký tự
                            </div>
                        </div>
                        
                        <div class="mb-0">
                            <label for="shopDescription" class="form-label">
                                Mô tả cửa hàng
                            </label>
                            <textarea class="form-control" id="shopDescription" rows="6" 
                                      maxlength="1000"
                                      placeholder="Giới thiệu về cửa hàng của bạn: sản phẩm, dịch vụ, điểm mạnh..."></textarea>
                            <div class="char-counter">
                                <span id="descCounter">0</span>/1000 ký tự
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="col-lg-6">
                    <!-- Status Section -->
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="bi bi-shield-check"></i>
                            <span>Trạng thái duyệt</span>
                        </div>
                        
                        <div class="status-badge-container">
                            <div class="mb-3">
                                <i class="bi bi-shield-fill-check" style="font-size: 3rem; color: #667eea;"></i>
                            </div>
                            <div id="statusDescription" class="text-muted">
                                Trạng thái cửa hàng do quản trị viên kiểm duyệt
                            </div>
                        </div>

                        <div class="alert alert-info border-0 mt-3 d-none" id="statusAlert">
                            <i class="bi bi-info-circle me-2"></i>
                            <span id="statusAlertText"></span>
                        </div>
                    </div>

                    <!-- Quick Stats (optional decoration) -->
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="bi bi-graph-up-arrow"></i>
                            <span>Thống kê nhanh</span>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-primary" id="productCount">0</div>
                                    <small class="text-muted">Sản phẩm</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-success" id="orderCount">0</div>
                                    <small class="text-muted">Đơn hàng</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-warning" id="reviewCount">0</div>
                                    <small class="text-muted">Đánh giá</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-3 mt-4 justify-content-center">
                <button type="submit" class="btn btn-save-custom" id="saveShopButton">
                    <i class="bi bi-check-circle me-2"></i>Lưu thay đổi
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="fetchShopDetails()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Làm mới
                </button>
            </div>
        </form>
    </div>
</div>

<th:block layout:fragment="scripts_body">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Get Elements
    const token = localStorage.getItem('jwtToken');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    const errorMessageText = document.getElementById('errorMessageText');
    const shopForm = document.getElementById('shopForm');
    const updateShopForm = document.getElementById('updateShopForm');
    const saveShopButton = document.getElementById('saveShopButton');
    
    const shopNameInput = document.getElementById('shopName');
    const shopDescriptionInput = document.getElementById('shopDescription');
    const shopNameDisplay = document.getElementById('shopNameDisplay');
    const shopCreatedDate = document.getElementById('shopCreatedDate');
    
    const shopStatusBadge = document.getElementById('shopStatus');
    const shopStatusIcon = document.getElementById('shopStatusIcon');
    const shopStatusContainer = document.getElementById('shopStatusContainer');
    const statusAlert = document.getElementById('statusAlert');
    const statusAlertText = document.getElementById('statusAlertText');
    
    const nameCounter = document.getElementById('nameCounter');
    const descCounter = document.getElementById('descCounter');

    // Character counters
    shopNameInput?.addEventListener('input', () => {
        nameCounter.textContent = shopNameInput.value.length;
    });
    
    shopDescriptionInput?.addEventListener('input', () => {
        descCounter.textContent = shopDescriptionInput.value.length;
    });

    // Run when DOM loads
    document.addEventListener('DOMContentLoaded', () => {
        console.log("Shop Management: DOMContentLoaded");
        if (!token) {
            window.location.href = '/login';
            return;
        }
        fetchShopDetails();
        if (updateShopForm) {
            updateShopForm.addEventListener('submit', handleShopUpdate);
        }
    });

    // Fetch shop details from API
    async function fetchShopDetails() {
        console.log("Fetching shop details...");
        showLoading();
        
        try {
            const response = await fetch('/api/vendor/shop', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            console.log("Fetch status:", response.status);
            const responseText = await response.text();
            
            if (!response.ok) {
                let errorMsg = responseText;
                try {
                    errorMsg = JSON.parse(responseText).message || responseText;
                } catch (e) {}
                throw new Error(`(${response.status}) ${errorMsg}`);
            }
            
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Response is not JSON");
            }
            
            const data = JSON.parse(responseText);
            console.log("Shop data received:", data);
            populateForm(data);
            showForm();
        } catch (error) {
            console.error("Fetch error:", error);
            showError(error.message);
        }
    }

    // Populate form with shop data
    function populateForm(shop) {
        if (!shop || !shopForm) return;
        
        console.log("Populating form with data:", shop);
        
        // Basic info
        shopNameInput.value = shop.name || '';
        shopDescriptionInput.value = shop.description || '';
        shopNameDisplay.textContent = shop.name || 'Tên cửa hàng';
        
        // Update counters
        nameCounter.textContent = (shop.name || '').length;
        descCounter.textContent = (shop.description || '').length;
        
        // Created date
        if (shop.created_at || shop.createdAt) {
            const date = new Date(shop.created_at || shop.createdAt);
            shopCreatedDate.textContent = date.toLocaleDateString('vi-VN', { 
                year: 'numeric', 
                month: 'long' 
            });
        }
        
        updateStatusBadge(shop.status);
    }

    // Update status badge
    function updateStatusBadge(status) {
        if (!shopStatusBadge || !shopStatusIcon) return;
        
        const statusConfigs = {
            'ACTIVE': {
                text: 'Đang hoạt động',
                icon: 'text-success',
                alert: 'Cửa hàng của bạn đã được duyệt và đang hoạt động!',
                alertClass: 'alert-success'
            },
            'PENDING': {
                text: 'Chờ duyệt',
                icon: 'text-warning',
                alert: 'Cửa hàng đang chờ quản trị viên xét duyệt. Vui lòng kiên nhẫn!',
                alertClass: 'alert-warning'
            },
            'REJECTED': {
                text: 'Bị từ chối',
                icon: 'text-danger',
                alert: 'Cửa hàng chưa được duyệt. Vui lòng liên hệ admin để biết thêm chi tiết.',
                alertClass: 'alert-danger'
            }
        };
        
        const config = statusConfigs[status?.toUpperCase()] || {
            text: 'Không xác định',
            icon: 'text-secondary',
            alert: '',
            alertClass: 'alert-secondary'
        };
        
        shopStatusBadge.textContent = config.text;
        shopStatusIcon.className = `bi bi-circle-fill ${config.icon}`;
        
        // Update alert
        if (config.alert && statusAlert && statusAlertText) {
            statusAlertText.textContent = config.alert;
            statusAlert.className = `alert border-0 mt-3 ${config.alertClass}`;
            statusAlert.classList.remove('d-none');
        }
    }

    // Handle form submission
    async function handleShopUpdate(event) {
        event.preventDefault();
        console.log("Submitting shop update...");
        
        if (!saveShopButton) return;

        const requestBody = {
            name: shopNameInput.value.trim(),
            description: shopDescriptionInput.value.trim() || null
        };
        
        if (!requestBody.name) {
            Swal.fire({
                icon: 'warning',
                title: 'Thiếu thông tin',
                text: 'Tên cửa hàng là bắt buộc.',
                confirmButtonColor: '#667eea'
            });
            return;
        }

        saveShopButton.disabled = true;
        saveShopButton.classList.add('btn-loading');

        try {
            const response = await fetch('/api/vendor/shop', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            const responseText = await response.text();
            
            if (!response.ok) {
                let errorMsg = responseText;
                try {
                    errorMsg = JSON.parse(responseText).message || responseText;
                } catch (e) {}
                throw new Error(`(${response.status}) ${errorMsg}`);
            }
            
            await Swal.fire({
                icon: 'success',
                title: 'Thành công!',
                text: 'Đã lưu thông tin cửa hàng.',
                timer: 2000,
                showConfirmButton: false
            });
            
            await fetchShopDetails();
            
        } catch (error) {
            console.error("Update error:", error);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: `Không thể cập nhật: ${error.message}`,
                confirmButtonColor: '#667eea'
            });
        } finally {
            saveShopButton.disabled = false;
            saveShopButton.classList.remove('btn-loading');
        }
    }

    // UI Management Functions
    function showLoading() {
        if (loadingIndicator) loadingIndicator.classList.remove('d-none');
        if (errorMessage) errorMessage.classList.add('d-none');
        if (shopForm) shopForm.classList.add('d-none');
    }

    function showError(message) {
        if (loadingIndicator) loadingIndicator.classList.add('d-none');
        if (errorMessageText && errorMessage) {
            errorMessageText.textContent = message || 'Không thể tải thông tin.';
            errorMessage.classList.remove('d-none');
        }
        if (shopForm) shopForm.classList.add('d-none');
    }

    function showForm() {
        if (loadingIndicator) loadingIndicator.classList.add('d-none');
        if (errorMessage) errorMessage.classList.add('d-none');
        if (shopForm) shopForm.classList.remove('d-none');
    }
</script>
</th:block>

</body>
</html>