<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_vendor_layout}">
<head>
    <title>Tổng quan</title>
    <style>
        /* Thêm style để card có hiệu ứng đẹp hơn khi hover */
        .card:hover {
            transform: translateY(-5px);
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15) !important;
        }
    </style>
</head>
<body>

<div layout:fragment="content">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Tổng quan</h1>
    </div>

    <!-- Các thẻ thống kê -->
    <div class="row g-4 mb-5">
        <!-- Đơn hàng mới -->
        <div class="col-md-4">
            <div class="card text-white bg-primary shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <div>
                        <h5 class="card-title">Đơn hàng mới chờ xử lý</h5>
                        <p class="card-text display-4 fw-bold" id="new-orders-count">...</p>
                    </div>
                    <a th:href="@{/vendor/orders}" class="text-white stretched-link text-decoration-none">Xem chi tiết &rarr;</a>
                </div>
            </div>
        </div>
        <!-- Doanh thu hôm nay -->
        <div class="col-md-4">
            <div class="card text-white bg-success shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                     <div>
                        <h5 class="card-title">Tổng doanh thu</h5>
                        <p class="card-text display-4 fw-bold" id="today-revenue">...</p>
                    </div>
                    <a th:href="@{/vendor/stats}" class="text-white stretched-link text-decoration-none">Xem báo cáo &rarr;</a>
                </div>
            </div>
        </div>
        <!-- Sản phẩm sắp hết -->
        <div class="col-md-4">
            <div class="card text-dark bg-warning shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                     <div>
                        <h5 class="card-title">Số lượng sản phẩm tồn kho</h5>
                        <p class="card-text display-4 fw-bold" id="low-stock-count">...</p>
                    </div>
                    <a th:href="@{/vendor/products}" class="text-dark stretched-link text-decoration-none">Quản lý kho &rarr;</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tác vụ nhanh -->
    <h4 class="mb-3">Tác vụ nhanh</h4>
    <div class="list-group">
        <a th:href="@{/vendor/orders}" class="list-group-item list-group-item-action d-flex align-items-center">
            <i class="bi bi-card-list fs-4 text-primary me-3"></i>
            <div>
                <strong>Xem các đơn hàng mới</strong>
                <div class="text-muted small">Quản lý và xử lý các đơn hàng đang chờ.</div>
            </div>
        </a>
        <a th:href="@{/vendor/products/add}" class="list-group-item list-group-item-action d-flex align-items-center">
            <i class="bi bi-plus-circle-fill fs-4 text-success me-3"></i>
             <div>
                <strong>Thêm sản phẩm mới</strong>
                <div class="text-muted small">Tạo sản phẩm mới để bắt đầu bán hàng.</div>
            </div>
        </a>
         <a th:href="@{/vendor/shop}" class="list-group-item list-group-item-action d-flex align-items-center">
            <i class="bi bi-gear-fill fs-4 text-secondary me-3"></i>
             <div>
                <strong>Cấu hình thông tin cửa hàng</strong>
                <div class="text-muted small">Cập nhật tên, mô tả và các thông tin khác.</div>
            </div>
        </a>
    </div>

</div>

<th:block layout:fragment="scripts_body">
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Trang Vendor Dashboard đã tải!");

            // Lấy token để xác thực
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                console.error("Không tìm thấy token. Vui lòng đăng nhập lại.");
                // Có thể chuyển hướng về trang đăng nhập ở đây
                return;
            }
            
            // Lấy các element trên trang để hiển thị dữ liệu
            const newOrdersEl = document.getElementById('new-orders-count');
            const todayRevenueEl = document.getElementById('today-revenue');
            const lowStockEl = document.getElementById('low-stock-count');

            // Định dạng tiền tệ VNĐ
            const formatter = new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            });

            // Hàm gọi API để lấy dữ liệu thống kê
            async function fetchDashboardStats() {
                try {
                    const response = await fetch('/api/vendor/dashboard/stats', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    // Nếu request không thành công (vd: 404, 500), báo lỗi
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Lỗi không xác định' }));
                        throw new Error(`(${response.status}) ${errorData.message}`);
                    }

                    // Parse JSON và cập nhật giao diện
                    const stats = await response.json();
                    console.log("Dữ liệu thống kê nhận được:", stats);
                    
                    newOrdersEl.textContent = stats.newOrdersCount ?? 0;
                    todayRevenueEl.textContent = formatter.format(stats.todayRevenue ?? 0);
                    lowStockEl.textContent = stats.lowStockCount ?? 0;

                } catch (error) {
                    console.error("Lỗi khi tải dữ liệu dashboard:", error);
                    // Hiển thị lỗi trên giao diện
                    newOrdersEl.textContent = "Lỗi";
                    todayRevenueEl.textContent = "Lỗi";
                    lowStockEl.textContent = "Lỗi";
                }
            }

            // Gọi hàm để bắt đầu tải dữ liệu
            fetchDashboardStats();
        });
    </script>
</th:block>

</body>
</html>