<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_vendor_layout}">
<head>
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m</title>
    <style>
        .product-img-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>
        <button class="btn btn-primary" onclick="openAddModal()">
            <i class="bi bi-plus-circle-fill"></i> Th√™m s·∫£n ph·∫©m m·ªõi
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th scope="col" style="width: 80px;">H√¨nh ·∫£nh</th>
                        <th scope="col">T√™n s·∫£n ph·∫©m</th>
                        <th scope="col">Danh m·ª•c</th>
                        <th scope="col">Gi√°</th>
                        <th scope="col">T·ªìn kho</th>
                        <th scope="col">Tr·∫°ng th√°i</th>
                        <th scope="col" style="width: 100px;">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="product-list-body">
                    <tr>
                        <td colspan="7" class="text-center p-5">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">ƒêang t·∫£i s·∫£n ph·∫©m...</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Th√™m/S·ª≠a S·∫£n ph·∫©m -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Th√™m s·∫£n ph·∫©m m·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">

                        <div class="mb-3">
                            <label for="productName" class="form-label">T√™n s·∫£n ph·∫©m <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productCategory" class="form-label">Danh m·ª•c <span class="text-danger">*</span></label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="">ƒêang t·∫£i danh m·ª•c...</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productPrice" class="form-label">Gi√° (VNƒê) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productPrice" min="0" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="productStock" class="form-label">S·ªë l∆∞·ª£ng t·ªìn kho <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="productStock" min="0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">H√¨nh ·∫£nh ƒë·∫°i di·ªán</label>
                            
                            <!-- Tab selector -->
                            <ul class="nav nav-tabs mb-3" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button">
                                        <i class="bi bi-upload"></i> Upload File
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-panel" type="button">
                                        <i class="bi bi-link-45deg"></i> Nh·∫≠p URL
                                    </button>
                                </li>
                            </ul>

                            <!-- Tab content -->
                            <div class="tab-content">
                                <!-- Upload panel -->
                                <div class="tab-pane fade show active" id="upload-panel">
                                    <input type="file" class="form-control" id="productImageFile" accept="image/*">
                                    <small class="text-muted">Ch·ªçn file ·∫£nh (JPG, PNG, GIF, WebP)</small>
                                    <div id="imagePreview" class="mt-2"></div>
                                </div>
                                
                                <!-- URL panel -->
                                <div class="tab-pane fade" id="url-panel">
                                    <input type="text" class="form-control" id="productImageUrl" placeholder="https://example.com/image.png">
                                    <small class="text-muted">Ho·∫∑c d√°n link ·∫£nh t·ª´ internet</small>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="productDescription" class="form-label">M√¥ t·∫£ s·∫£n ph·∫©m</label>
                            <textarea class="form-control" id="productDescription" rows="4"></textarea>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="productIsActive" checked>
                            <label class="form-check-label" for="productIsActive">Hi·ªÉn th·ªã (Active)</label>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy b·ªè</button>
                    <button type="submit" class="btn btn-primary" form="productForm">L∆∞u s·∫£n ph·∫©m</button>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts_body">
<script>
    // ==================== GLOBAL VARIABLES ====================
    let token;
    let productListBody;
    let productModal;
    let productForm;
    let modalTitle;
    let productIdInput;
    let productNameInput;
    let productCategorySelect;
    let productPriceInput;
    let productStockInput;
    let productImageUrlInput;
    let productImageFileInput;
    let productDescriptionInput;
    let productIsActiveInput;
    let formatter;

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded - Initializing...');
        
        // Ki·ªÉm tra token
        token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // Kh·ªüi t·∫°o c√°c DOM elements
        productListBody = document.getElementById('product-list-body');
        const productModalEl = document.getElementById('productModal');
        productForm = document.getElementById('productForm');
        modalTitle = document.getElementById('productModalLabel');
        productIdInput = document.getElementById('productId');
        productNameInput = document.getElementById('productName');
        productCategorySelect = document.getElementById('productCategory');
        productPriceInput = document.getElementById('productPrice');
        productStockInput = document.getElementById('productStock');
        productImageUrlInput = document.getElementById('productImageUrl');
        productImageFileInput = document.getElementById('productImageFile');
        productDescriptionInput = document.getElementById('productDescription');
        productIsActiveInput = document.getElementById('productIsActive');

        // Kh·ªüi t·∫°o Bootstrap Modal
        if (productModalEl) {
            productModal = new bootstrap.Modal(productModalEl);
            console.log('‚úÖ Modal initialized successfully');
        } else {
            console.error('‚ùå Modal element not found!');
            return;
        }

        // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
        formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        });

        // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
        fetchProducts();
        fetchCategories();
        
        // G√°n s·ª± ki·ªán submit cho Form
        if (productForm) {
            productForm.addEventListener('submit', handleFormSubmit);
        }

        // G√°n s·ª± ki·ªán preview ·∫£nh
        if (productImageFileInput) {
            productImageFileInput.addEventListener('change', handleImagePreview);
        }
    });

    // ==================== FETCH PRODUCTS ====================
    async function fetchProducts() {
        try {
            const response = await fetch('/api/vendor/products', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                throw new Error('Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m. B·∫°n c√≥ quy·ªÅn Vendor kh√¥ng?');
            }
            const products = await response.json();
            renderProductTable(products);
        } catch (error) {
            console.error(error);
            productListBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger p-5">L·ªói: ${error.message}</td></tr>`;
        }
    }

    // ==================== RENDER PRODUCT TABLE ====================
    function renderProductTable(products) {
        productListBody.innerHTML = '';
        if (products.length === 0) {
            productListBody.innerHTML = `<tr><td colspan="7" class="text-center p-5">B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.</td></tr>`;
            return;
        }

        products.forEach(product => {
            const defaultImg = 'https://via.placeholder.com/150?text=No+Image';
            const statusBadge = product.isActive 
                ? `<span class="badge bg-success">ƒêang b√°n</span>`
                : `<span class="badge bg-secondary">ƒê√£ ·∫©n</span>`;

            // X·ª≠ l√Ω category an to√†n
            const categoryName = product.categoryName || 
                                (product.category && product.category.name) || 
                                'N/A';

            const row = `
                <tr>
                    <td>
                        <img src="${product.imageUrl || defaultImg}" alt="${product.name}" class="product-img-thumb" onerror="this.src='${defaultImg}'">
                    </td>
                    <td>${product.name}</td>
                    <td>${categoryName}</td>
                    <td>${formatter.format(product.price)}</td>
                    <td>${product.stockQuantity}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm" onclick="openEditModal(${product.id})" title="Ch·ªânh s·ª≠a">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                    </td>
                </tr>
            `;
            productListBody.innerHTML += row;
        });
    }

    // ==================== FETCH CATEGORIES ====================
    async function fetchCategories() {
        try {
            const response = await fetch('/api/vendor/categories', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const categories = await response.json();
            
            productCategorySelect.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
            categories.forEach(cat => {
                productCategorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
        } catch (error) {
            console.error('Error fetching categories:', error);
            productCategorySelect.innerHTML = '<option value="">L·ªói t·∫£i danh m·ª•c</option>';
        }
    }

    // ==================== OPEN ADD MODAL ====================
    window.openAddModal = function() {
        console.log('üÜï openAddModal called');
        
        if (!productModal) {
            console.warn('‚ö†Ô∏è Modal not initialized, trying to initialize now...');
            const productModalEl = document.getElementById('productModal');
            if (productModalEl) {
                productModal = new bootstrap.Modal(productModalEl);
                console.log('‚úÖ Modal initialized on demand');
            } else {
                console.error('‚ùå Modal element not found!');
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y modal. Vui l√≤ng t·∫£i l·∫°i trang.', 'error');
                return;
            }
        }

        productForm.reset();
        productIdInput.value = '';
        productIsActiveInput.checked = true;
        modalTitle.textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
        
        // Clear image preview
        document.getElementById('imagePreview').innerHTML = '';
        
        console.log('üöÄ Showing modal...');
        productModal.show();
    };

    // ==================== OPEN EDIT MODAL ====================
    window.openEditModal = async function(id) {
        console.log('‚úèÔ∏è openEditModal called with id:', id);
        
        if (!productModal) {
            console.warn('‚ö†Ô∏è Modal not initialized, trying to initialize now...');
            const productModalEl = document.getElementById('productModal');
            if (productModalEl) {
                productModal = new bootstrap.Modal(productModalEl);
                console.log('‚úÖ Modal initialized on demand');
            } else {
                console.error('‚ùå Modal element not found!');
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y modal. Vui l√≤ng t·∫£i l·∫°i trang.', 'error');
                return;
            }
        }

        productForm.reset();
        productIdInput.value = id;
        modalTitle.textContent = 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m';
        
        try {
            const response = await fetch(`/api/vendor/products/${id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m');
            
            const product = await response.json();
            console.log('üì¶ Product data:', product);
            
            // ƒêi·ªÅn d·ªØ li·ªáu v√†o form - KI·ªÇM TRA AN TO√ÄN
            productNameInput.value = product.name || '';
            
            // S·ª≠a l·ªói: ki·ªÉm tra category tr∆∞·ªõc khi truy c·∫≠p id
            productCategorySelect.value = product.categoryId || 
                                         (product.category && product.category.id) || 
                                         '';
            
            productPriceInput.value = product.price || 0;
            productStockInput.value = product.stockQuantity || 0;
            productImageUrlInput.value = product.imageUrl || '';
            productDescriptionInput.value = product.description || '';
            productIsActiveInput.checked = product.isActive !== false;
            
            // Show image preview if exists
            if (product.imageUrl) {
                document.getElementById('imagePreview').innerHTML = `
                    <img src="${product.imageUrl}" 
                         alt="Current image" 
                         style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px;"
                         onerror="this.style.display='none'">
                `;
            }
            
            console.log('üöÄ Showing modal...');
            productModal.show();
        } catch (error) {
            console.error('‚ùå Error opening edit modal:', error);
            Swal.fire('L·ªói', error.message, 'error');
        }
    };

    // ==================== HANDLE FORM SUBMIT ====================
    async function handleFormSubmit(event) {
        event.preventDefault();
        
        const productId = productIdInput.value;
        const isUpdating = !!productId;

        console.log(isUpdating ? 'üìù Updating product...' : '‚ûï Creating new product...');

        // X·ª≠ l√Ω h√¨nh ·∫£nh: ∆∞u ti√™n file upload, sau ƒë√≥ l√† URL
        let finalImageUrl = productImageUrlInput.value || null;
        
        // N·∫øu ng∆∞·ªùi d√πng upload file, c·∫ßn upload l√™n server tr∆∞·ªõc
        if (productImageFileInput.files.length > 0) {
            console.log('üì§ Uploading image...');
            const formData = new FormData();
            formData.append('file', productImageFileInput.files[0]);
            
            try {
                const uploadResponse = await fetch('/api/vendor/products/upload-image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (uploadResponse.ok) {
                    const uploadResult = await uploadResponse.json();
                    finalImageUrl = uploadResult.imageUrl;
                    console.log('‚úÖ Image uploaded:', finalImageUrl);
                } else {
                    throw new Error('Upload h√¨nh ·∫£nh th·∫•t b·∫°i');
                }
            } catch (uploadError) {
                console.error('‚ùå Upload error:', uploadError);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ upload h√¨nh ·∫£nh. ' + uploadError.message, 'error');
                return;
            }
        }

        const url = isUpdating ? `/api/vendor/products/${productId}` : '/api/vendor/products';
        const method = isUpdating ? 'PUT' : 'POST';

        const requestBody = {
            name: productNameInput.value,
            categoryId: parseInt(productCategorySelect.value),
            price: parseFloat(productPriceInput.value),
            stockQuantity: parseInt(productStockInput.value),
            imageUrl: finalImageUrl,
            description: productDescriptionInput.value || null,
            isActive: productIsActiveInput.checked
        };
        
        // Validate
        if (!requestBody.name || !requestBody.categoryId || isNaN(requestBody.price) || isNaN(requestBody.stockQuantity)) {
            Swal.fire('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng c√≥ d·∫•u (*)', 'warning');
            return;
        }

        console.log('üì§ Sending request:', requestBody);

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.message || 'L∆∞u th·∫•t b·∫°i');
            }
            
            productModal.hide();
            Swal.fire(
                'Th√†nh c√¥ng!',
                isUpdating ? 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng.' : 'Th√™m s·∫£n ph·∫©m th√†nh c√¥ng.',
                'success'
            );
            fetchProducts();

        } catch (error) {
            console.error('‚ùå Error submitting form:', error);
            Swal.fire('L·ªói', error.message, 'error');
        }
    }

    // ==================== HANDLE IMAGE PREVIEW ====================
    function handleImagePreview(event) {
        const imagePreview = document.getElementById('imagePreview');
        const file = event.target.files[0];
        
        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                Swal.fire('L·ªói', 'Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh', 'error');
                productImageFileInput.value = '';
                imagePreview.innerHTML = '';
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                Swal.fire('L·ªói', 'K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB', 'error');
                productImageFileInput.value = '';
                imagePreview.innerHTML = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.innerHTML = `
                    <div class="mt-2">
                        <img src="${e.target.result}" 
                             alt="Preview" 
                             style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px;">
                        <div class="text-muted small mt-1">
                            <i class="bi bi-info-circle"></i> ${file.name} (${(file.size / 1024).toFixed(2)} KB)
                        </div>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.innerHTML = '';
        }
    }

</script>
</th:block>

</body>
</html>