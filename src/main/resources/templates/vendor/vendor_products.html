<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_vendor_layout}">
<head>
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m</title>
    <style>
        .product-img-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .preview-img-wrapper {
            position: relative;
            display: inline-block;
            width: 100px;
            height: 100px;
            margin-right: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .preview-img-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .remove-image-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            line-height: 18px;
            text-align: center;
            cursor: pointer;
            padding: 0;
            z-index: 10;
        }
        .btn-loading {
            position: relative;
            pointer-events: none;
            color: transparent !important;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            height: 1rem;
            width: 1rem;
            margin-left: -0.5rem;
            margin-top: -0.5rem;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spinner-border .75s linear infinite;
            color: white !important;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div layout:fragment="content">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>
        <button class="btn btn-primary" onclick="openAddModal()">
            <i class="bi bi-plus-circle-fill"></i> Th√™m s·∫£n ph·∫©m m·ªõi
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 80px;">H√¨nh ·∫£nh</th>
                            <th scope="col">T√™n s·∫£n ph·∫©m</th>
                            <th scope="col">Danh m·ª•c</th>
                            <th scope="col" class="text-end">Gi√°</th>
                            <th scope="col" class="text-center">T·ªìn kho</th>
                            <th scope="col" class="text-center">Tr·∫°ng th√°i</th>
                            <th scope="col" class="text-center" style="width: 100px;">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="product-list-body">
                        <tr>
                            <td colspan="7" class="text-center p-5">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2 text-muted">ƒêang t·∫£i s·∫£n ph·∫©m...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Th√™m s·∫£n ph·∫©m m·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        
                        <div class="mb-3">
                            <label for="productName" class="form-label">T√™n s·∫£n ph·∫©m <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productCategory" class="form-label">Danh m·ª•c <span class="text-danger">*</span></label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="" disabled selected>Ch·ªçn danh m·ª•c...</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productPrice" class="form-label">Gi√° (VNƒê) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productPrice" min="0" step="1000" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="productStock" class="form-label">S·ªë l∆∞·ª£ng t·ªìn kho <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="productStock" min="0" step="1" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">H√¨nh ·∫£nh s·∫£n ph·∫©m <span class="text-danger">*</span> <small>(·∫¢nh ƒë·∫ßu ti√™n l√† ·∫£nh ƒë·∫°i di·ªán)</small></label>

                            <ul class="nav nav-tabs mb-3" id="imageTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button" role="tab" aria-controls="upload-panel" aria-selected="true">
                                        <i class="bi bi-upload"></i> Upload File(s)
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-panel" type="button" role="tab" aria-controls="url-panel" aria-selected="false">
                                        <i class="bi bi-link-45deg"></i> Nh·∫≠p URL (Ch·ªâ 1 ·∫£nh)
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="imageTabsContent">
                                <div class="tab-pane fade show active" id="upload-panel" role="tabpanel" aria-labelledby="upload-tab">
                                    <input type="file" class="form-control" id="productImageFile" accept="image/*" multiple>
                                    <small class="text-muted">Ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu file ·∫£nh (JPG, PNG, etc. T·ªëi ƒëa 5MB m·ªói ·∫£nh).</small>
                                    <div id="imagePreview" class="mt-2 d-flex flex-wrap gap-2"></div>
                                </div>

                                <div class="tab-pane fade" id="url-panel" role="tabpanel" aria-labelledby="url-tab">
                                    <input type="text" class="form-control" id="productImageUrl" placeholder="https://example.com/image.png">
                                    <small class="text-muted">D√°n link ·∫£nh t·ª´ internet. N·∫øu nh·∫≠p URL, c√°c file ƒë√£ ch·ªçn/upload s·∫Ω b·ªã b·ªè qua.</small>
                                    <div id="urlImagePreview" class="mt-2"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="productDescription" class="form-label">M√¥ t·∫£ s·∫£n ph·∫©m</label>
                            <textarea class="form-control" id="productDescription" rows="4"></textarea>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="productIsActive" checked>
                            <label class="form-check-label" for="productIsActive">Hi·ªÉn th·ªã s·∫£n ph·∫©m</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy b·ªè</button>
                    <button type="submit" class="btn btn-primary" form="productForm" id="saveProductButton">L∆∞u s·∫£n ph·∫©m</button>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts_body">
<script>
    // ==================== GLOBAL VARIABLES ====================
    let token;
    let productListBody;
    let productModal;
    let productForm;
    let modalTitle;
    let productIdInput;
    let productNameInput;
    let productCategorySelect;
    let productPriceInput;
    let productStockInput;
    let productImageUrlInput;
    let productImageFileInput;
    let productDescriptionInput;
    let productIsActiveInput;
    let formatter;
    let saveProductButton;
    let imagePreviewDiv;
    let urlImagePreviewDiv;
    let imageTabs;
    let uploadTabButton;
    let urlTabButton;

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded - Initializing...');

        token = localStorage.getItem('jwtToken');
        if (!token) { window.location.href = '/login'; return; }

        // Kh·ªüi t·∫°o c√°c DOM elements
        productListBody = document.getElementById('product-list-body');
        const productModalEl = document.getElementById('productModal');
        productForm = document.getElementById('productForm');
        modalTitle = document.getElementById('productModalLabel');
        productIdInput = document.getElementById('productId');
        productNameInput = document.getElementById('productName');
        productCategorySelect = document.getElementById('productCategory');
        productPriceInput = document.getElementById('productPrice');
        productStockInput = document.getElementById('productStock');
        productImageUrlInput = document.getElementById('productImageUrl');
        productImageFileInput = document.getElementById('productImageFile');
        productDescriptionInput = document.getElementById('productDescription');
        productIsActiveInput = document.getElementById('productIsActive');
        saveProductButton = document.getElementById('saveProductButton');
        imagePreviewDiv = document.getElementById('imagePreview');
        urlImagePreviewDiv = document.getElementById('urlImagePreview');
        imageTabs = document.getElementById('imageTabs');
        uploadTabButton = document.getElementById('upload-tab');
        urlTabButton = document.getElementById('url-tab');

        if (!productListBody || !productModalEl || !productForm || !modalTitle || !productIdInput || 
            !productNameInput || !productCategorySelect || !productPriceInput || !productStockInput || 
            !productImageUrlInput || !productImageFileInput || !productDescriptionInput || 
            !productIsActiveInput || !saveProductButton || !imagePreviewDiv || !urlImagePreviewDiv || 
            !imageTabs || !uploadTabButton || !urlTabButton) {
            console.error('‚ùå One or more DOM elements not found!');
            Swal.fire('L·ªói Giao Di·ªán', 'Kh√¥ng th·ªÉ t·∫£i ƒë·∫ßy ƒë·ªß c√°c th√†nh ph·∫ßn trang. Vui l√≤ng t·∫£i l·∫°i.', 'error');
            return;
        }

        if (productModalEl) {
            try {
                productModal = new bootstrap.Modal(productModalEl);
                console.log('‚úÖ Modal initialized successfully');
            } catch (e) {
                console.error('‚ùå Failed to initialize Bootstrap Modal:', e);
                Swal.fire('L·ªói Giao Di·ªán', 'Kh√¥ng th·ªÉ kh·ªüi t·∫°o c·ª≠a s·ªï popup. Vui l√≤ng t·∫£i l·∫°i.', 'error');
                return;
            }
        } else { 
            console.error('‚ùå Modal element not found!'); 
            return; 
        }

        formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

        fetchProducts();
        fetchCategories();

        if (productForm) productForm.addEventListener('submit', handleFormSubmit);
        if (productImageFileInput) productImageFileInput.addEventListener('change', handleImagePreview);
        if (productImageUrlInput) productImageUrlInput.addEventListener('input', handleUrlPreview);

        // X·ª≠ l√Ω khi chuy·ªÉn tab
        if (imageTabs) {
            imageTabs.addEventListener('show.bs.tab', function (event) {
                console.log(`Tab changed. New active tab: ${event.target.id}`);
                if (event.target.id === 'url-tab') {
                    // Chuy·ªÉn sang tab URL: X√≥a file input v√† preview file m·ªõi
                    productImageFileInput.value = null;
                    delete productImageFileInput.filesData;
                    const filePreviews = imagePreviewDiv.querySelectorAll('div[data-file-name]');
                    filePreviews.forEach(p => p.remove());
                    console.log('Switched to URL tab, cleared file input and NEW file previews.');
                } else if (event.target.id === 'upload-tab') {
                    // Chuy·ªÉn sang tab Upload: X√≥a URL input v√† preview
                    productImageUrlInput.value = '';
                    urlImagePreviewDiv.innerHTML = '';
                    console.log('Switched to Upload tab, cleared URL input and preview.');
                }
            });
        }
    });

    // ==================== FETCH PRODUCTS ====================
    async function fetchProducts() {
        console.log('Fetching products from API...');
        productListBody.innerHTML = `<tr><td colspan="7" class="text-center p-5"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div><span class="ms-2 text-muted">ƒêang t·∫£i s·∫£n ph·∫©m...</span></td></tr>`;

        try {
            const response = await fetch('/api/vendor/products', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `Server tr·∫£ v·ªÅ l·ªói ${response.status}` }));
                throw new Error(errorData.message || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m.');
            }

            const products = await response.json();
            console.log('‚úÖ Received products DTO list:', products);
            renderProductTable(products);

        } catch (error) {
            console.error('‚ùå Error fetching products:', error);
            productListBody.innerHTML = `<tr><td colspan="7" class="text-center p-5 text-danger"><strong>L·ªói:</strong> ${error.message}</td></tr>`;
        }
    }

    // ==================== RENDER PRODUCT TABLE ====================
    function renderProductTable(productsDtoList) {
        productListBody.innerHTML = '';

        if (!productsDtoList || !Array.isArray(productsDtoList) || productsDtoList.length === 0) {
            productListBody.innerHTML = `<tr><td colspan="7" class="text-center p-5 text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.</td></tr>`;
            return;
        }

        productsDtoList.forEach(productDto => {
            const defaultImageUrl = '/images/placeholder.png';
            const imageUrl = productDto.imageUrl || defaultImageUrl;
            const productName = productDto.name || 'N/A';
            const categoryName = productDto.categoryName || 'Ch∆∞a ph√¢n lo·∫°i';
            const price = productDto.price != null ? formatter.format(productDto.price) : '0 ‚Ç´';
            const stock = productDto.stockQuantity != null ? productDto.stockQuantity : 0;

            let statusBadge;
            if (productDto.isActive) {
                statusBadge = `<span class="badge bg-success">ƒêang b√°n</span>`;
            } else {
                statusBadge = `<span class="badge bg-secondary">ƒê√£ ·∫©n</span>`;
            }
            
            if (stock === 0) {
                statusBadge += ` <span class="badge bg-danger ms-1">H·∫øt h√†ng</span>`;
            } else if (stock <= 10) {
                statusBadge += ` <span class="badge bg-warning text-dark ms-1">S·∫Øp h·∫øt</span>`;
            }

            const rowHTML = `
                <tr>
                    <td>
                        <img src="${imageUrl}" alt="${productName}" class="product-img-thumb" onerror="this.onerror=null; this.src='${defaultImageUrl}';">
                    </td>
                    <td class="fw-bold">${productName}</td>
                    <td>${categoryName}</td>
                    <td class="text-end">${price}</td>
                    <td class="text-center">${stock}</td>
                    <td class="text-center">${statusBadge}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-sm py-0 px-1" title="Ch·ªânh s·ª≠a" onclick="openEditModal(${productDto.id})">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                    </td>
                </tr>
            `;
            productListBody.insertAdjacentHTML('beforeend', rowHTML);
        });
        console.log(`Rendered ${productsDtoList.length} products.`);
    }

    // ==================== FETCH CATEGORIES ====================
    async function fetchCategories() {
        try {
            const response = await fetch('/api/vendor/categories', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`(${response.status}) ${errorText || 'L·ªói t·∫£i danh m·ª•c'}`);
            }
            const categories = await response.json();

            productCategorySelect.innerHTML = '<option value="" disabled selected>Ch·ªçn danh m·ª•c...</option>';
            categories.forEach(cat => {
                if(cat && cat.id && cat.name) {
                    productCategorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                }
            });
            console.log('‚úÖ Fetched categories.');
        } catch (error) {
            console.error('‚ùå Error fetching categories:', error);
            productCategorySelect.innerHTML = '<option value="">L·ªói t·∫£i danh m·ª•c</option>';
        }
    }

    // ==================== CREATE PREVIEW ELEMENT ====================
    function createPreviewElement(src, identifier, isExisting = false) {
        const wrapper = document.createElement('div');
        wrapper.classList.add('preview-img-wrapper');
        
        if (isExisting) {
            wrapper.dataset.imageUrl = identifier;
        } else {
            wrapper.dataset.fileName = identifier;
        }

        const img = document.createElement('img');
        img.src = src;
        img.alt = isExisting ? 'Existing Image' : 'Preview';
        img.onerror = function() {
            console.warn(`Failed to load image preview: ${src}`);
            wrapper.remove();
        };

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.classList.add('remove-image-btn');
        removeBtn.innerHTML = '&times;';
        removeBtn.title = isExisting ? 'X√≥a ·∫£nh n√†y' : 'B·ªè ch·ªçn file n√†y';
        removeBtn.onclick = function() {
            wrapper.remove();
            
            if (!isExisting) {
                // X√≥a file kh·ªèi filesData
                if (productImageFileInput.filesData) {
                    productImageFileInput.filesData = productImageFileInput.filesData.filter(f => f.name !== identifier);
                    console.log(`Removed file ${identifier}. Remaining:`, productImageFileInput.filesData.map(f=>f.name));

                    const dataTransfer = new DataTransfer();
                    productImageFileInput.filesData.forEach(file => dataTransfer.items.add(file));
                    productImageFileInput.files = dataTransfer.files;
                }
            }
        };

        wrapper.appendChild(img);
        wrapper.appendChild(removeBtn);
        return wrapper;
    }

    // ==================== OPEN ADD MODAL ====================
    window.openAddModal = function() {
        console.log('üÜï openAddModal called');
        if (!productModal) return;

        productForm.reset();
        productIdInput.value = '';
        productIsActiveInput.checked = true;
        modalTitle.textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';

        imagePreviewDiv.innerHTML = '';
        urlImagePreviewDiv.innerHTML = '';
        productImageUrlInput.value = '';
        if (productImageFileInput) {
            productImageFileInput.value = null;
            delete productImageFileInput.filesData;
        }

        if (uploadTabButton) bootstrap.Tab.getOrCreateInstance(uploadTabButton).show();

        console.log('üöÄ Showing add modal...');
        productModal.show();
    };

    // ==================== OPEN EDIT MODAL ====================
    window.openEditModal = async function(id) {
        console.log('‚úèÔ∏è openEditModal called with id:', id);
        if (!productModal) return;

        productForm.reset();
        productIdInput.value = id;
        modalTitle.textContent = 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m';

        imagePreviewDiv.innerHTML = '';
        urlImagePreviewDiv.innerHTML = '';
        productImageUrlInput.value = '';
        if (productImageFileInput) {
            productImageFileInput.value = null;
            delete productImageFileInput.filesData;
        }

        try {
            const response = await fetch(`/api/vendor/products/${id}`, { 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                let errorMsg = `(${response.status}) Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m.`;
                try { errorMsg = JSON.parse(errorText).message || errorMsg; } catch(e){}
                throw new Error(errorMsg);
            }

            const product = await response.json();
            console.log('üì¶ Product data for edit:', product);

            modalTitle.textContent = 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m';

            productNameInput.value = product.name || '';
            productCategorySelect.value = (product.category && product.category.id) || '';
            productPriceInput.value = product.price || 0;
            productStockInput.value = product.stockQuantity || 0;
            productDescriptionInput.value = product.description || '';
            productIsActiveInput.checked = product.active !== false;

            // Hi·ªÉn th·ªã ·∫£nh hi·ªán c√≥
            if (product.images && Array.isArray(product.images) && product.images.length > 0) {
                product.images.forEach(img => {
                    if (!img || !img.imageUrl) return;
                    const previewElement = createPreviewElement(img.imageUrl, img.imageUrl, true);
                    imagePreviewDiv.appendChild(previewElement);
                });
                console.log("Loaded existing images:", product.images.length);
            }

            if (uploadTabButton) bootstrap.Tab.getOrCreateInstance(uploadTabButton).show();

            console.log('üöÄ Showing edit modal...');
            productModal.show();
        } catch (error) {
            console.error('‚ùå Error opening edit modal:', error);
            Swal.fire('L·ªói', `Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${error.message}`, 'error');
            modalTitle.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu';
        }
    };

    // ==================== HANDLE IMAGE PREVIEW (File Upload) ====================
    function handleImagePreview(event) {
        const files = event.target.files;

        // X√≥a c√°c preview file m·ªõi tr∆∞·ªõc ƒë√≥
        const existingFilePreviews = imagePreviewDiv.querySelectorAll('div[data-file-name]');
        existingFilePreviews.forEach(preview => preview.remove());
        delete productImageFileInput.filesData;

        if (files.length > 0) {
            const validFiles = Array.from(files).filter(file => {
                if (!file.type.startsWith('image/')) {
                    console.warn(`Skipping non-image file: ${file.name}`); 
                    return false;
                }
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire('C·∫£nh b√°o', `·∫¢nh "${file.name}" v∆∞·ª£t qu√° 5MB v√† s·∫Ω b·ªã b·ªè qua.`, 'warning'); 
                    return false;
                }
                return true;
            });

            if (validFiles.length === 0) return;

            validFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (!imagePreviewDiv.querySelector(`div[data-file-name="${file.name}"]`)) {
                        const previewElement = createPreviewElement(e.target.result, file.name, false);
                        imagePreviewDiv.appendChild(previewElement);
                    }
                };
                reader.readAsDataURL(file);
            });

            productImageFileInput.filesData = validFiles;
            console.log(`Previewing ${validFiles.length} new file(s).`);

            const dataTransfer = new DataTransfer();
            validFiles.forEach(file => dataTransfer.items.add(file));
            productImageFileInput.files = dataTransfer.files;

            if (!uploadTabButton.classList.contains('active')) {
                bootstrap.Tab.getOrCreateInstance(uploadTabButton).show();
            }
        }
    }

    // ==================== HANDLE URL PREVIEW ====================
    function handleUrlPreview() {
        const url = productImageUrlInput.value.trim();
        urlImagePreviewDiv.innerHTML = '';
        
        if (url) {
            const wrapper = document.createElement('div');
            wrapper.classList.add('preview-img-wrapper');
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'URL Preview';
            img.onerror = function() {
                wrapper.innerHTML = '<small class="text-danger p-2 d-block" style="font-size: 0.8em;">Link ·∫£nh kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng th·ªÉ t·∫£i</small>';
                wrapper.style.border = '1px solid red';
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'center';
                wrapper.style.justifyContent = 'center';
            };
            wrapper.appendChild(img);
            urlImagePreviewDiv.appendChild(wrapper);

            if (!urlTabButton.classList.contains('active')) {
                bootstrap.Tab.getOrCreateInstance(urlTabButton).show();
            }
        }
    }

 // ==================== HANDLE FORM SUBMIT (FIXED) ====================
  async function handleFormSubmit(event) {
    event.preventDefault();

    const productId = productIdInput.value;
    const isUpdating = !!productId;

    console.log(isUpdating ? 'üìù Updating product...' : '‚ûï Creating new product...');
    saveProductButton.disabled = true;
    saveProductButton.classList.add('btn-loading');

    let finalImageUrls = [];
    let uploadErrorOccurred = false;

    try {
        const activeTabId = imageTabs.querySelector('.nav-link.active').id;
        console.log(`Active tab for submit: ${activeTabId}`);

        if (activeTabId === 'url-tab') {
            const imageUrlFromInput = productImageUrlInput.value.trim();
            if (imageUrlFromInput) {
                // Ki·ªÉm tra ƒë·ªãnh d·∫°ng URL c∆° b·∫£n
                if (!imageUrlFromInput.toLowerCase().match(/^https?:\/\/.*\.(jpg|jpeg|png|gif|webp)(\?.*)?$/)) {
                    throw new Error('ƒê·ªãnh d·∫°ng URL h√¨nh ·∫£nh kh√¥ng h·ª£p l·ªá. Ph·∫£i l√† HTTP/HTTPS v√† k·∫øt th√∫c b·∫±ng ƒëu√¥i ·∫£nh (jpg, png, gif, webp).');
                }
                finalImageUrls = [imageUrlFromInput];
                console.log('Using URL from input:', finalImageUrls);
            } else {
                 throw new Error('Vui l√≤ng nh·∫≠p URL h√¨nh ·∫£nh ho·∫∑c ch·ªçn file upload.');
            }
        } else { // activeTabId === 'upload-tab'
            // 1. L·∫•y danh s√°ch c√°c URL c·ªßa ·∫£nh C≈® c√≤n l·∫°i t·ª´ c√°c preview
            const existingPreviews = imagePreviewDiv.querySelectorAll('div[data-image-url]');
            const existingUrls = Array.from(existingPreviews).map(preview => preview.dataset.imageUrl);
            
            // 2. L·∫•y danh s√°ch c√°c file M·ªöI c·∫ßn upload
            const uploadedUrls = [];
            const filesToUpload = productImageFileInput.filesData || [];

            // 3. Th·ª±c hi·ªán upload c√°c file M·ªöI (n·∫øu c√≥)
            if (filesToUpload.length > 0) {
                console.log(`üì§ Uploading ${filesToUpload.length} new image(s)...`);
                const uploadPromises = filesToUpload.map(file => {
                    const formData = new FormData();
                    formData.append('file', file);
                    return fetch('/api/vendor/products/upload-image', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    }).then(async response => {
                        if (!response.ok) {
                            const err = await response.json().catch(() => ({ message: `Status ${response.status}` }));
                            console.error(`Upload failed for ${file.name}:`, err.message);
                            uploadErrorOccurred = true;
                            return null; // Tr·∫£ v·ªÅ null n·∫øu upload l·ªói
                        }
                        return response.json();
                    }).then(result => result ? result.imageUrl : null);
                });

                const results = await Promise.all(uploadPromises);
                uploadedUrls.push(...results.filter(url => url !== null)); // Ch·ªâ l·∫•y c√°c URL upload th√†nh c√¥ng
                console.log('‚úÖ Successfully uploaded URLs:', uploadedUrls);

                if (uploadErrorOccurred) {
                    Swal.fire('C·∫£nh b√°o Upload', 'M·ªôt ho·∫∑c nhi·ªÅu ·∫£nh m·ªõi kh√¥ng th·ªÉ t·∫£i l√™n. Ch·ªâ nh·ªØng ·∫£nh upload th√†nh c√¥ng m·ªõi ƒë∆∞·ª£c l∆∞u.', 'warning');
                }
            }

            // 4. K·∫øt h·ª£p danh s√°ch URL: ·∫£nh m·ªõi upload l√™n tr∆∞·ªõc, ·∫£nh c≈© c√≤n l·∫°i ·ªü sau
            finalImageUrls = [...uploadedUrls, ...existingUrls];
            console.log('Combined final URLs from upload tab:', finalImageUrls);
        }

        // 5. Ki·ªÉm tra cu·ªëi c√πng xem c√≥ ·∫£nh n√†o kh√¥ng
        if (finalImageUrls.length === 0) {
            throw new Error('S·∫£n ph·∫©m ph·∫£i c√≥ √≠t nh·∫•t m·ªôt h√¨nh ·∫£nh.');
        }

        // --- C√°c b∆∞·ªõc c√≤n l·∫°i gi·ªØ nguy√™n ---
        const url = isUpdating ? `/api/vendor/products/${productId}` : '/api/vendor/products';
        const method = isUpdating ? 'PUT' : 'POST';

        const requestBody = {
            name: productNameInput.value,
            categoryId: parseInt(productCategorySelect.value),
            price: parseFloat(productPriceInput.value),
            stockQuantity: parseInt(productStockInput.value),
            imageUrls: finalImageUrls,
            description: productDescriptionInput.value || null,
            isActive: productIsActiveInput.checked
        };

        if (!requestBody.name || !requestBody.categoryId || isNaN(requestBody.price) || isNaN(requestBody.stockQuantity)) {
            throw new Error('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß t√™n, danh m·ª•c, gi√° v√† t·ªìn kho.');
        }

        console.log('üì§ Sending product data to API:', requestBody);

        const response = await fetch(url, {
            method: method,
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const result = await response.json().catch(() => ({ message: `L·ªói ${response.status} khi l∆∞u s·∫£n ph·∫©m.` }));
            throw new Error(result.message || 'L∆∞u s·∫£n ph·∫©m th·∫•t b·∫°i');
        }
        
        productModal.hide();
        
        await new Promise(resolve => setTimeout(resolve, 300)); // ƒê·ª£i modal ƒë√≥ng
        
        Swal.fire('Th√†nh c√¥ng!', isUpdating ? 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng.' : 'Th√™m s·∫£n ph·∫©m th√†nh c√¥ng.', 'success');
        
        fetchProducts(); // T·∫£i l·∫°i danh s√°ch

    } catch (error) {
        console.error('‚ùå Error submitting form:', error);
        Swal.fire('L·ªói', error.message, 'error');
    } finally {
        saveProductButton.disabled = false;
        saveProductButton.classList.remove('btn-loading');
    }
}

    // ==================== DELETE PRODUCT ====================
    async function deleteProduct(id) {
        const row = productListBody.querySelector(`button[onclick="openEditModal(${id})"]`)?.closest('tr');
        const productName = row ? row.cells[1].textContent : `s·∫£n ph·∫©m #${id}`;

        const result = await Swal.fire({
            title: `X√≥a ${productName}?`,
            text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'ƒê·ªìng √Ω x√≥a',
            cancelButtonText: 'H·ªßy b·ªè'
        });

        if (result.isConfirmed) {
            console.log(`Attempting to delete product ${id}...`);
            try {
                const response = await fetch(`/api/vendor/products/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({
                        message: `L·ªói ${response.status}`
                    }));
                    throw new Error(err.message || 'X√≥a th·∫•t b·∫°i.');
                }

                console.log(`Product ${id} deleted successfully.`);
                Swal.fire('ƒê√£ x√≥a!', `S·∫£n ph·∫©m "${productName}" ƒë√£ ƒë∆∞·ª£c x√≥a.`, 'success');
                fetchProducts();

            } catch (error) {
                console.error(`‚ùå Error deleting product ${id}:`, error);
                Swal.fire('L·ªói!', `Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m: ${error.message}`, 'error');
            }
        }
    }

</script>
</th:block>

</body>
</html>