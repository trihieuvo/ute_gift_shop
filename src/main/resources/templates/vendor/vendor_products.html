<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_vendor_layout}">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Sản phẩm</title>
    <style>
        .product-img-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .preview-img-wrapper {
            position: relative;
            display: inline-block;
            width: 100px;
            height: 100px;
            margin-right: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .preview-img-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .remove-image-btn {
             position: absolute;
             top: 2px;
             right: 2px;
             background-color: rgba(255, 0, 0, 0.7);
             color: white;
             border: none;
             border-radius: 50%;
             width: 20px;
             height: 20px;
             font-size: 12px;
             line-height: 18px;
             text-align: center;
             cursor: pointer;
             padding: 0;
             z-index: 10;
        }
        .btn-loading {
            position: relative;
            pointer-events: none;
            color: transparent !important;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            height: 1rem;
            width: 1rem;
            margin-left: -0.5rem;
            margin-top: -0.5rem;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spinner-border .75s linear infinite;
            color: white !important;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div layout:fragment="content">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Quản lý Sản phẩm</h1>
        <button class="btn btn-primary" onclick="openAddModal()">
            <i class="bi bi-plus-circle-fill"></i> Thêm sản phẩm mới
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
             <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 80px;">Hình ảnh</th>
                            <th scope="col">Tên sản phẩm</th>
                            <th scope="col">Danh mục</th>
                            <th scope="col" class="text-end">Giá</th>
                            <th scope="col" class="text-center">Tồn kho</th>
                            <th scope="col" class="text-center">Trạng thái</th>
                            <th scope="col" class="text-center" style="width: 100px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="product-list-body">
                        <tr>
                            <td colspan="7" class="text-center p-5">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2 text-muted">Đang tải sản phẩm...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
             </div>
        </div>
    </div>

    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Thêm sản phẩm mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">

                        <div class="mb-3">
                            <label for="productName" class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="productCategory" class="form-label">Danh mục <span class="text-danger">*</span></label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="" disabled selected>Chọn danh mục...</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="productPrice" class="form-label">Giá (VNĐ) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productPrice" min="0" step="1000" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="productStock" class="form-label">Số lượng tồn kho <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="productStock" min="0" step="1" required>
                        </div>

                        <div class="mb-3">
                             <label class="form-label">Hình ảnh sản phẩm <span class="text-danger">*</span> <small>(Ảnh đầu tiên là ảnh đại diện)</small></label>
                            <input type="file" class="form-control" id="productImageFile" accept="image/*" multiple>
                            <small class="text-muted">Chọn một hoặc nhiều file ảnh (JPG, PNG, etc. Tối đa 5MB mỗi ảnh).</small>
                            <div id="imagePreview" class="mt-2 d-flex flex-wrap gap-2">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Mô tả sản phẩm</label>
                            <textarea class="form-control" id="productDescription" rows="4"></textarea>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="productIsActive" checked>
                            <label class="form-check-label" for="productIsActive">Hiển thị sản phẩm</label>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                    <button type="submit" class="btn btn-primary" form="productForm" id="saveProductButton">Lưu sản phẩm</button>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts_body">
<script>
    // ==================== GLOBAL VARIABLES ====================
    let token;
    let productListBody;
    let productModal;
    let productForm;
    let modalTitle;
    let productIdInput;
    let productNameInput;
    let productCategorySelect;
    let productPriceInput;
    let productStockInput;
    let productImageFileInput;
    let productDescriptionInput;
    let productIsActiveInput;
    let formatter;
    let saveProductButton;
    let imagePreviewDiv;

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
        token = localStorage.getItem('jwtToken');
        if (!token) { window.location.href = '/login'; return; }

        productListBody = document.getElementById('product-list-body');
        const productModalEl = document.getElementById('productModal');
        productForm = document.getElementById('productForm');
        modalTitle = document.getElementById('productModalLabel');
        productIdInput = document.getElementById('productId');
        productNameInput = document.getElementById('productName');
        productCategorySelect = document.getElementById('productCategory');
        productPriceInput = document.getElementById('productPrice');
        productStockInput = document.getElementById('productStock');
        productImageFileInput = document.getElementById('productImageFile');
        productDescriptionInput = document.getElementById('productDescription');
        productIsActiveInput = document.getElementById('productIsActive');
        saveProductButton = document.getElementById('saveProductButton');
        imagePreviewDiv = document.getElementById('imagePreview');

        if (!productListBody || !productModalEl) {
            console.error('❌ Critical DOM elements not found! Check HTML IDs.');
            return;
        }

        productModal = new bootstrap.Modal(productModalEl);
        formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

        fetchProducts();
        fetchCategories();

        productForm.addEventListener('submit', handleFormSubmit);
        productImageFileInput.addEventListener('change', handleImagePreview);
    });

    // ==================== FETCH PRODUCTS ====================
    // SỬA LỖI: Bổ sung lại hàm bị thiếu
    async function fetchProducts() {
        productListBody.innerHTML = `<tr><td colspan="7" class="text-center p-5"><div class="spinner-border spinner-border-sm"></div><span class="ms-2 text-muted">Đang tải...</span></td></tr>`;
        try {
            const response = await fetch('/api/vendor/products', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `Lỗi ${response.status}` }));
                throw new Error(errorData.message || 'Không thể tải dữ liệu.');
            }
            const products = await response.json();
            renderProductTable(products);
        } catch (error) {
            productListBody.innerHTML = `<tr><td colspan="7" class="text-center p-5 text-danger"><strong>Lỗi:</strong> ${error.message}</td></tr>`;
        }
    }

    // ==================== RENDER PRODUCT TABLE ====================
    // SỬA LỖI: Bổ sung lại hàm bị thiếu
    function renderProductTable(productsDtoList) {
        productListBody.innerHTML = '';
        if (!productsDtoList || productsDtoList.length === 0) {
            productListBody.innerHTML = `<tr><td colspan="7" class="text-center p-5 text-muted">Chưa có sản phẩm nào.</td></tr>`;
            return;
        }

        productsDtoList.forEach(productDto => {
            const defaultImageUrl = '/images/placeholder.png';
            const imageUrl = productDto.imageUrl || defaultImageUrl;
            const productName = productDto.name || 'N/A';
            const categoryName = productDto.categoryName || 'Chưa phân loại';
            const price = productDto.price != null ? formatter.format(productDto.price) : '0 ₫';
            const stock = productDto.stockQuantity != null ? productDto.stockQuantity : 0;

            let statusBadge;
            if (productDto.isActive) {
                statusBadge = `<span class="badge bg-success">Đang bán</span>`;
            } else {
                statusBadge = `<span class="badge bg-secondary">Đã ẩn</span>`;
            }
            if (stock === 0) {
                statusBadge += ` <span class="badge bg-danger ms-1">Hết hàng</span>`;
            } else if (stock <= 10) {
                statusBadge += ` <span class="badge bg-warning text-dark ms-1">Sắp hết</span>`;
            }

            const rowHTML = `
                <tr>
                    <td>
                        <img src="${imageUrl}?t=${new Date().getTime()}" alt="${productName}" class="product-img-thumb" onerror="this.onerror=null; this.src='${defaultImageUrl}';">
                    </td>
                    <td class="fw-bold">${productName}</td>
                    <td>${categoryName}</td>
                    <td class="text-end">${price}</td>
                    <td class="text-center">${stock}</td>
                    <td class="text-center">${statusBadge}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-sm py-0 px-1" title="Chỉnh sửa" onclick="openEditModal(${productDto.id})">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm py-0 px-1 ms-1" title="Xóa" onclick="deleteProduct(${productDto.id})">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </td>
                </tr>
            `;
            productListBody.insertAdjacentHTML('beforeend', rowHTML);
        });
    }

    // ==================== FETCH CATEGORIES ====================
    // SỬA LỖI: Bổ sung lại hàm bị thiếu
    async function fetchCategories() {
       try {
            const response = await fetch('/api/vendor/categories', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Lỗi tải danh mục');
            
            const categories = await response.json();
            productCategorySelect.innerHTML = '<option value="" disabled selected>Chọn danh mục...</option>';
            categories.forEach(cat => {
                if(cat && cat.id && cat.name) {
                    productCategorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                }
            });
        } catch (error) {
            console.error('Error fetching categories:', error);
            productCategorySelect.innerHTML = '<option value="">Lỗi tải danh mục</option>';
        }
    }

    // ==================== CREATE PREVIEW ELEMENT ====================
    function createPreviewElement(src, identifier, isExisting = false) {
        const wrapper = document.createElement('div');
        wrapper.classList.add('preview-img-wrapper');
        const originalUrl = identifier;

        wrapper.dataset[isExisting ? 'imageUrl' : 'fileName'] = originalUrl;

        const img = document.createElement('img');
        img.src = src;
        img.alt = isExisting ? 'Existing Image' : 'Preview';
        img.onerror = () => wrapper.remove();

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.classList.add('remove-image-btn');
        removeBtn.innerHTML = '&times;';
        removeBtn.title = isExisting ? 'Xóa ảnh này' : 'Bỏ chọn file này';
        removeBtn.onclick = function() {
            wrapper.remove();
            if (!isExisting && productImageFileInput.filesData) {
                productImageFileInput.filesData = productImageFileInput.filesData.filter(f => f.name !== originalUrl);
                const dataTransfer = new DataTransfer();
                productImageFileInput.filesData.forEach(file => dataTransfer.items.add(file));
                productImageFileInput.files = dataTransfer.files;
            }
        };

        wrapper.appendChild(img);
        wrapper.appendChild(removeBtn);
        return wrapper;
    }

    // ==================== OPEN ADD MODAL ====================
    window.openAddModal = function() {
        productForm.reset();
        productIdInput.value = '';
        productIsActiveInput.checked = true;
        modalTitle.textContent = 'Thêm sản phẩm mới';
        imagePreviewDiv.innerHTML = '';
        if (productImageFileInput) {
             productImageFileInput.value = null;
             delete productImageFileInput.filesData;
        }
        productModal.show();
    };

    // ==================== OPEN EDIT MODAL ====================
    window.openEditModal = async function(id) {
        productForm.reset();
        productIdInput.value = id;
        modalTitle.textContent = 'Đang tải...';
        imagePreviewDiv.innerHTML = '';
        if (productImageFileInput) {
             productImageFileInput.value = null;
             delete productImageFileInput.filesData;
        }
        productModal.show();

        try {
            const response = await fetch(`/api/vendor/products/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!response.ok) {
                throw new Error('Không thể tải dữ liệu sản phẩm.');
            }

            const product = await response.json();
            modalTitle.textContent = 'Cập nhật sản phẩm';

             productNameInput.value = product.name || '';
             productCategorySelect.value = (product.category && product.category.id) || '';
             productPriceInput.value = product.price || 0;
             productStockInput.value = product.stockQuantity || 0;
             productDescriptionInput.value = product.description || '';
             productIsActiveInput.checked = product.active !== false;

            if (product.images && Array.isArray(product.images) && product.images.length > 0) {
                 product.images.forEach(img => {
                    if (img && img.imageUrl) {
                        const previewElement = createPreviewElement(img.imageUrl, img.imageUrl, true);
                        imagePreviewDiv.appendChild(previewElement);
                    }
                });
            }
        } catch (error) {
           console.error('❌ Error opening edit modal:', error);
           Swal.fire('Lỗi', error.message, 'error');
           modalTitle.textContent = 'Lỗi tải dữ liệu';
           productModal.hide();
        }
    };

    // ==================== HANDLE IMAGE PREVIEW (File Upload) ====================
    function handleImagePreview(event) {
        const files = event.target.files;
        const existingFilePreviews = imagePreviewDiv.querySelectorAll('div[data-file-name]');
        existingFilePreviews.forEach(preview => preview.remove());
        delete productImageFileInput.filesData;

        if (files.length > 0) {
            const validFiles = Array.from(files).filter(file => {
                 if (!file.type.startsWith('image/')) return false;
                 if (file.size > 5 * 1024 * 1024) {
                    Swal.fire('Cảnh báo', `Ảnh "${file.name}" vượt quá 5MB và sẽ bị bỏ qua.`, 'warning');
                    return false;
                 }
                 return true;
             });

             if (validFiles.length === 0) return;

             validFiles.forEach(file => {
                 const reader = new FileReader();
                 reader.onload = function(e) {
                    const previewElement = createPreviewElement(e.target.result, file.name, false);
                    imagePreviewDiv.appendChild(previewElement);
                 };
                 reader.readAsDataURL(file);
             });

             productImageFileInput.filesData = validFiles;
             const dataTransfer = new DataTransfer();
             validFiles.forEach(file => dataTransfer.items.add(file));
             productImageFileInput.files = dataTransfer.files;
        }
    }

    // ==================== HANDLE FORM SUBMIT ====================
    async function handleFormSubmit(event) {
        event.preventDefault();
        const productId = productIdInput.value;
        const isUpdating = !!productId;

        saveProductButton.disabled = true;
        saveProductButton.classList.add('btn-loading');

        let uploadErrorOccurred = false;

        try {
            const existingPreviews = imagePreviewDiv.querySelectorAll('div[data-image-url]');
            const existingUrls = Array.from(existingPreviews).map(preview => preview.dataset.imageUrl);
            const filesToUpload = productImageFileInput.filesData || [];
            let uploadedUrls = [];

            if (filesToUpload.length > 0) {
                const uploadPromises = filesToUpload.map(file => {
                    const formData = new FormData();
                    formData.append('file', file);
                    return fetch('/api/vendor/products/upload-image', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    }).then(async response => {
                        if (!response.ok) {
                            uploadErrorOccurred = true;
                            return null;
                        }
                        const result = await response.json();
                        return result ? result.imageUrl : null;
                    });
                });
                const results = await Promise.all(uploadPromises);
                uploadedUrls = results.filter(url => url !== null);
            }

            const finalImageUrls = [...uploadedUrls, ...existingUrls];
            if (finalImageUrls.length === 0) {
                 throw new Error('Sản phẩm phải có ít nhất một hình ảnh.');
            }
            if (uploadErrorOccurred) {
                Swal.fire('Cảnh báo', 'Một hoặc nhiều ảnh mới không thể tải lên.', 'warning');
            }

            const url = isUpdating ? `/api/vendor/products/${productId}` : '/api/vendor/products';
            const method = isUpdating ? 'PUT' : 'POST';
            const requestBody = {
                name: productNameInput.value,
                categoryId: parseInt(productCategorySelect.value),
                price: parseFloat(productPriceInput.value),
                stockQuantity: parseInt(productStockInput.value),
                imageUrls: finalImageUrls,
                description: productDescriptionInput.value || null,
                isActive: productIsActiveInput.checked
            };

            if (!requestBody.name || !requestBody.categoryId || isNaN(requestBody.price) || isNaN(requestBody.stockQuantity)) {
                throw new Error('Vui lòng điền đầy đủ các trường bắt buộc.');
            }

            const response = await fetch(url, {
                method: method,
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const result = await response.json().catch(()=> ({message: `Lỗi ${response.status}`}));
                throw new Error(result.message || 'Lưu sản phẩm thất bại');
            }

            productModal.hide();
            Swal.fire('Thành công!', isUpdating ? 'Cập nhật thành công.' : 'Thêm mới thành công.', 'success');
            fetchProducts();
        } catch (error) {
            Swal.fire('Lỗi', error.message, 'error');
        } finally {
            saveProductButton.disabled = false;
            saveProductButton.classList.remove('btn-loading');
        }
    }

    // ==================== DELETE PRODUCT ====================
    // SỬA LỖI: Bổ sung lại hàm bị thiếu
    async function deleteProduct(id) {
       const result = await Swal.fire({
            title: `Bạn chắc chắn muốn xóa?`,
            text: "Hành động này không thể hoàn tác!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonText: 'Hủy bỏ',
            confirmButtonText: 'Đồng ý xóa'
        });

        if (result.isConfirmed) {
            try {
                const response = await fetch(`/api/vendor/products/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({ message: `Lỗi ${response.status}` }));
                    throw new Error(err.message || 'Xóa thất bại.');
                }
                Swal.fire('Đã xóa!', 'Sản phẩm đã được xóa.', 'success');
                fetchProducts();
            } catch (error) {
                Swal.fire('Lỗi!', `Không thể xóa: ${error.message}`, 'error');
            }
        }
    }

</script>
</th:block>

</body>
</html>