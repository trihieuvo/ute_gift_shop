<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_vendor_layout}">
<head>
    <title>Qu·∫£n l√Ω ƒê∆°n h√†ng</title>
    <style>
        .order-status-badge {
            font-size: 0.85rem;
            padding: 0.35rem 0.75rem;
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .product-img-small {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }
        .filter-buttons .btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    
    <h1 class="h2 mb-4">Qu·∫£n l√Ω ƒê∆°n h√†ng</h1>

    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="row mb-4" id="statistics-row">
        <div class="col-md-3">
            <div class="card stats-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">T·ªïng ƒë∆°n h√†ng</p>
                            <h3 class="mb-0" id="stat-total">0</h3>
                        </div>
                        <div class="text-primary">
                            <i class="bi bi-cart3 fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Ch·ªù x·ª≠ l√Ω</p>
                            <h3 class="mb-0 text-warning" id="stat-new">0</h3>
                        </div>
                        <div class="text-warning">
                            <i class="bi bi-clock-history fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Ho√†n th√†nh</p>
                            <h3 class="mb-0 text-success" id="stat-delivered">0</h3>
                        </div>
                        <div class="text-success">
                            <i class="bi bi-check-circle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Doanh thu</p>
                            <h3 class="mb-0 text-info" id="stat-revenue">0 ƒë</h3>
                        </div>
                        <div class="text-info">
                            <i class="bi bi-currency-dollar fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- B·ªô l·ªçc tr·∫°ng th√°i -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="filter-buttons">
                <button class="btn btn-outline-primary active" data-filter="ALL" onclick="filterOrders('ALL')">
                    <i class="bi bi-grid-3x3-gap"></i> T·∫•t c·∫£
                </button>
                <button class="btn btn-outline-secondary" data-filter="NEW" onclick="filterOrders('NEW')">
                    <i class="bi bi-clock"></i> M·ªõi
                </button>
                <button class="btn btn-outline-info" data-filter="CONFIRMED" onclick="filterOrders('CONFIRMED')">
                    <i class="bi bi-check2-square"></i> ƒê√£ x√°c nh·∫≠n
                </button>
                <button class="btn btn-outline-warning" data-filter="PREPARING" onclick="filterOrders('PREPARING')">
                    <i class="bi bi-box-seam"></i> ƒêang chu·∫©n b·ªã
                </button>
                <button class="btn btn-outline-primary" data-filter="READY_FOR_SHIPMENT" onclick="filterOrders('READY_FOR_SHIPMENT')">
                    <i class="bi bi-box-arrow-right"></i> S·∫µn s√†ng giao
                </button>
                <button class="btn btn-outline-info" data-filter="DELIVERING" onclick="filterOrders('DELIVERING')">
                    <i class="bi bi-truck"></i> ƒêang giao
                </button>
                <button class="btn btn-outline-success" data-filter="DELIVERED" onclick="filterOrders('DELIVERED')">
                    <i class="bi bi-check-circle"></i> Ho√†n th√†nh
                </button>
                <button class="btn btn-outline-danger" data-filter="CANCELLED" onclick="filterOrders('CANCELLED')">
                    <i class="bi bi-x-circle"></i> ƒê√£ h·ªßy
                </button>
            </div>
        </div>
    </div>

    <!-- B·∫£ng ƒë∆°n h√†ng -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>M√£ ƒë∆°n</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>Ng√†y ƒë·∫∑t</th>
                            <th>S·∫£n ph·∫©m</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <tr>
                            <td colspan="7" class="text-center p-5">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2">ƒêang t·∫£i ƒë∆°n h√†ng...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Chi ti·∫øt ƒë∆°n h√†ng -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Chi ti·∫øt ƒë∆°n h√†ng <span class="badge bg-primary" id="modal-order-id"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="order-detail-content">
                    <div class="text-center p-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <div id="status-action-buttons"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts_body">
<script>
    // ==================== GLOBAL VARIABLES ====================
    let token;
    let ordersTableBody;
    let orderDetailModal;
    let allOrders = [];
    let currentFilter = 'ALL';
    let formatter;
    let currentOrderDetail = null;

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üì¶ Initializing Vendor Orders Management...');
        
        token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        ordersTableBody = document.getElementById('orders-table-body');
        const orderDetailModalEl = document.getElementById('orderDetailModal');
        if (orderDetailModalEl) {
            orderDetailModal = new bootstrap.Modal(orderDetailModalEl);
        }

        formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        });

        fetchOrders();
        fetchStatistics();
    });

    // ==================== FETCH ORDERS ====================
    async function fetchOrders() {
        try {
            const response = await fetch('/api/vendor/orders', {
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Error response:', errorText);
                throw new Error('Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng: ' + response.status);
            }

            allOrders = await response.json();
            console.log('‚úÖ Loaded orders:', allOrders.length, allOrders);
            renderOrdersTable();

        } catch (error) {
            console.error('‚ùå Error fetching orders:', error);
            ordersTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger p-5">
                        <i class="bi bi-exclamation-triangle fs-3"></i>
                        <div class="mt-2">L·ªói: ${error.message}</div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-primary" onclick="fetchOrders()">
                                <i class="bi bi-arrow-clockwise"></i> Th·ª≠ l·∫°i
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    // ==================== FETCH STATISTICS ====================
    async function fetchStatistics() {
        try {
            const response = await fetch('/api/vendor/orders/statistics', {
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) return;

            const stats = await response.json();
            console.log('üìä Statistics:', stats);
            
            document.getElementById('stat-total').textContent = stats.totalOrders || 0;
            document.getElementById('stat-new').textContent = stats.newOrders || 0;
            document.getElementById('stat-delivered').textContent = stats.deliveredOrders || 0;
            document.getElementById('stat-revenue').textContent = formatter.format(stats.totalRevenue || 0);

        } catch (error) {
            console.error('‚ùå Error fetching statistics:', error);
        }
    }

    // ==================== RENDER ORDERS TABLE ====================
    function renderOrdersTable() {
        const filteredOrders = currentFilter === 'ALL' 
            ? allOrders 
            : allOrders.filter(order => order.status === currentFilter);

        ordersTableBody.innerHTML = '';

        if (filteredOrders.length === 0) {
            ordersTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center p-5">
                        <i class="bi bi-inbox fs-1 text-muted"></i>
                        <div class="mt-2">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ${currentFilter !== 'ALL' ? '·ªü tr·∫°ng th√°i n√†y' : ''}.</div>
                    </td>
                </tr>
            `;
            return;
        }

        filteredOrders.forEach(order => {
            const statusBadge = getStatusBadge(order.status);
            const orderDate = formatDate(order.orderDate);
            
            const row = `
                <tr>
                    <td><strong>#${order.orderId}</strong></td>
                    <td>
                        <div><strong>${order.customerName || 'N/A'}</strong></div>
                        <small class="text-muted">${order.customerEmail || 'N/A'}</small>
                    </td>
                    <td>${orderDate}</td>
                    <td><span class="badge bg-secondary">${order.vendorItemCount || 0} SP</span></td>
                    <td><strong class="text-success">${formatter.format(order.vendorTotalAmount || 0)}</strong></td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetail(${order.orderId})" title="Xem chi ti·∫øt">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
            ordersTableBody.innerHTML += row;
        });
    }

    // ==================== FORMAT DATE ====================
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return dateString;
        }
    }

    // ==================== GET STATUS BADGE ====================
    function getStatusBadge(status) {
        const badges = {
            'NEW': '<span class="badge bg-secondary order-status-badge">M·ªõi</span>',
            'CONFIRMED': '<span class="badge bg-info order-status-badge">ƒê√£ x√°c nh·∫≠n</span>',
            'PREPARING': '<span class="badge bg-warning order-status-badge">ƒêang chu·∫©n b·ªã</span>',
            'READY_FOR_SHIPMENT': '<span class="badge bg-primary order-status-badge">S·∫µn s√†ng giao</span>',
            'DELIVERING': '<span class="badge bg-info order-status-badge">ƒêang giao</span>',
            'DELIVERED': '<span class="badge bg-success order-status-badge">Ho√†n th√†nh</span>',
            'FAILED_DELIVERY': '<span class="badge bg-danger order-status-badge">Giao th·∫•t b·∫°i</span>',
            'CANCELLED': '<span class="badge bg-dark order-status-badge">ƒê√£ h·ªßy</span>'
        };
        return badges[status] || `<span class="badge bg-secondary order-status-badge">${status}</span>`;
    }

    // ==================== FILTER ORDERS ====================
    window.filterOrders = function(status) {
        currentFilter = status;
        
        // Update button states
        document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeBtn = document.querySelector(`[data-filter="${status}"]`);
        if (activeBtn) activeBtn.classList.add('active');
        
        renderOrdersTable();
    };

    // ==================== VIEW ORDER DETAIL ====================
    window.viewOrderDetail = async function(orderId) {
        console.log('üëÅÔ∏è Viewing order detail:', orderId);
        
        const orderDetailContent = document.getElementById('order-detail-content');
        orderDetailContent.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        orderDetailModal.show();

        try {
            const response = await fetch(`/api/vendor/orders/${orderId}`, {
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
            }

            currentOrderDetail = await response.json();
            console.log('üì¶ Order detail:', currentOrderDetail);
            
            document.getElementById('modal-order-id').textContent = '#' + currentOrderDetail.orderId;
            renderOrderDetail(currentOrderDetail);
            renderStatusActionButtons(currentOrderDetail.status, currentOrderDetail.orderId);

        } catch (error) {
            console.error('‚ùå Error loading order detail:', error);
            orderDetailContent.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    ${error.message}
                </div>
            `;
        }
    };

    // ==================== RENDER ORDER DETAIL ====================
    function renderOrderDetail(orderDetail) {
        const orderDetailContent = document.getElementById('order-detail-content');
        
        let productsHtml = '';
        if (orderDetail.vendorItems && orderDetail.vendorItems.length > 0) {
            orderDetail.vendorItems.forEach(product => {
                const defaultImg = 'https://via.placeholder.com/50?text=No+Image';
                productsHtml += `
                    <tr>
                        <td>
                            <img src="${product.productImageUrl || defaultImg}" 
                                 alt="${product.productName}" 
                                 class="product-img-small"
                                 onerror="this.src='${defaultImg}'">
                        </td>
                        <td>${product.productName || 'N/A'}</td>
                        <td class="text-center">${product.quantity || 0}</td>
                        <td class="text-end">${formatter.format(product.price || 0)}</td>
                        <td class="text-end"><strong>${formatter.format(product.totalItemPrice || 0)}</strong></td>
                    </tr>
                `;
            });
        } else {
            productsHtml = '<tr><td colspan="5" class="text-center p-3">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>';
        }

        orderDetailContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="mb-3"><i class="bi bi-person-circle"></i> Th√¥ng tin kh√°ch h√†ng</h6>
                    <table class="table table-sm table-bordered">
                        <tr>
                            <td width="40%"><strong>H·ªç t√™n:</strong></td>
                            <td>${orderDetail.customer?.name || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>Email:</strong></td>
                            <td>${orderDetail.customer?.email || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td><strong>SƒêT:</strong></td>
                            <td>${orderDetail.customer?.phone || 'N/A'}</td>
                        </tr>
                    </table>

                    <h6 class="mb-3 mt-4"><i class="bi bi-geo-alt"></i> ƒê·ªãa ch·ªâ giao h√†ng</h6>
                    <div class="alert alert-light">
                        ${orderDetail.shippingAddress || 'Kh√¥ng c√≥ th√¥ng tin ƒë·ªãa ch·ªâ'}
                    </div>
                    
                    ${orderDetail.deliveryNote ? `
                        <h6 class="mb-3 mt-4"><i class="bi bi-chat-square-text"></i> Ghi ch√∫</h6>
                        <div class="alert alert-info">
                            ${orderDetail.deliveryNote}
                        </div>
                    ` : ''}
                </div>

                <div class="col-md-6">
                    <h6 class="mb-3"><i class="bi bi-info-circle"></i> Th√¥ng tin ƒë∆°n h√†ng</h6>
                    <table class="table table-sm table-bordered">
                        <tr>
                            <td width="40%"><strong>Ng√†y ƒë·∫∑t:</strong></td>
                            <td>${formatDate(orderDetail.orderDate)}</td>
                        </tr>
                        <tr>
                            <td><strong>Tr·∫°ng th√°i:</strong></td>
                            <td>${getStatusBadge(orderDetail.status)}</td>
                        </tr>
                        <tr>
                            <td><strong>Thanh to√°n:</strong></td>
                            <td>${orderDetail.paymentMethod || 'N/A'}</td>
                        </tr>
                    </table>

                    <h6 class="mb-3 mt-4"><i class="bi bi-box-seam"></i> S·∫£n ph·∫©m c·ªßa b·∫°n</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>H√¨nh</th>
                                    <th>T√™n s·∫£n ph·∫©m</th>
                                    <th class="text-center">SL</th>
                                    <th class="text-end">ƒê∆°n gi√°</th>
                                    <th class="text-end">Th√†nh ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productsHtml}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="4" class="text-end"><strong>T·ªïng c·ªông:</strong></td>
                                    <td class="text-end">
                                        <strong class="text-success">${formatter.format(orderDetail.vendorTotalAmount || 0)}</strong>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== RENDER STATUS ACTION BUTTONS ====================
    function renderStatusActionButtons(currentStatus, orderId) {
        const statusActionButtons = document.getElementById('status-action-buttons');
        let buttons = '';

        const statusFlow = {
            'NEW': { next: 'CONFIRMED', label: 'X√°c nh·∫≠n ƒë∆°n', icon: 'check2-square', color: 'info' },
            'CONFIRMED': { next: 'PREPARING', label: 'B·∫Øt ƒë·∫ßu chu·∫©n b·ªã', icon: 'box-seam', color: 'warning' },
            'PREPARING': { next: 'READY_FOR_SHIPMENT', label: 'S·∫µn s√†ng giao h√†ng', icon: 'box-arrow-right', color: 'primary' }
        };

        if (statusFlow[currentStatus]) {
            const action = statusFlow[currentStatus];
            buttons = `
                <button class="btn btn-${action.color}" onclick="updateOrderStatus(${orderId}, '${action.next}')">
                    <i class="bi bi-${action.icon}"></i> ${action.label}
                </button>
            `;
        }

        statusActionButtons.innerHTML = buttons;
    }

    // ==================== UPDATE ORDER STATUS ====================
    window.updateOrderStatus = async function(orderId, newStatus) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën chuy·ªÉn ƒë∆°n h√†ng sang tr·∫°ng th√°i "${newStatus}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/vendor/orders/${orderId}/status`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ newStatus: newStatus })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i');
            }

            await Swal.fire('Th√†nh c√¥ng!', 'ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng', 'success');
            
            // Refresh data
            orderDetailModal.hide();
            await fetchOrders();
            await fetchStatistics();

        } catch (error) {
            console.error('‚ùå Error updating status:', error);
            Swal.fire('L·ªói', error.message, 'error');
        }
    };

</script>
</th:block>

</body>
</html>