<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_vendor_layout}">
<head>
    <title>Th·ªëng k√™ Doanh thu</title>
    <style>
        /* CSS Styles (gi·ªØ nguy√™n kh√¥ng thay ƒë·ªïi) */
        .stats-card {
            border-radius: 1rem;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100%;
        }
        
        .stats-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 1rem 3rem rgba(0,0,0,.175);
        }
        
        .stats-card.card-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stats-card.card-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stats-card.card-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stats-card .card-body {
            padding: 2rem;
        }
        
        .stats-card h4 {
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .stats-card .revenue-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stats-card .icon-wrapper {
            font-size: 3rem;
            opacity: 0.3;
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
        }
        
        .loading-placeholder {
            height: 40px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .info-cards {
            margin-top: 2rem;
        }
        
        .info-card {
            border-radius: 0.75rem;
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }
        
        .info-card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        }
        
        .info-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }
        
        .info-card .card-body {
            padding: 1.5rem;
        }
        
        .quick-stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .quick-stat-item {
            flex: 1;
            min-width: 200px;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            text-align: center;
        }
        
        .quick-stat-item .label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        
        .quick-stat-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #495057;
        }
        
        .chart-placeholder {
            height: 300px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            padding: 1rem;
        }
        
        .chart-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .chart-tab {
            padding: 0.5rem 1.5rem;
            border: none;
            background: #e9ecef;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .chart-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .chart-tab:hover:not(.active) {
            background: #dee2e6;
        }
        
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        }
        
        .page-header h1 {
            margin: 0;
            font-weight: 700;
        }
        
        .page-header .subtitle {
            opacity: 0.9;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2"><i class="bi bi-graph-up-arrow me-2"></i>Th·ªëng k√™ Doanh thu</h1>
                <p class="subtitle mb-0">T·ªïng quan hi·ªáu qu·∫£ kinh doanh c·ªßa b·∫°n</p>
            </div>
            <div>
                <button class="btn btn-success" id="export-excel-btn">
                    <i class="bi bi-file-earmark-excel"></i> Xu·∫•t Excel
                </button>
                <button class="btn btn-light ms-2" onclick="fetchRevenueStats()">
                    <i class="bi bi-arrow-clockwise"></i> T·∫£i l·∫°i
                </button>
            </div>
        </div>
        </div>

    <div id="loadingIndicator" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu doanh thu...</p>
    </div>

    <div id="errorMessage" class="alert alert-danger d-none" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span id="errorMessageText"></span>
    </div>

    <div class="d-none" id="revenueCards">
        <div class="row">
            <div class="col-lg-4 col-md-6">
                <div class="card stats-card card-success shadow">
                    <div class="card-body position-relative">
                        <div class="icon-wrapper">
                            <i class="bi bi-calendar-day"></i>
                        </div>
                        <h4><i class="bi bi-calendar-day me-2"></i>Doanh thu H√¥m nay</h4>
                        <div class="revenue-value" id="daily-revenue">
                            <div class="loading-placeholder">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            </div>
                        </div>
                        <small style="opacity: 0.8;">C·∫≠p nh·∫≠t: <span id="update-time-daily">--</span></small>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card stats-card card-warning shadow">
                    <div class="card-body position-relative">
                        <div class="icon-wrapper">
                            <i class="bi bi-calendar-month"></i>
                        </div>
                        <h4><i class="bi bi-calendar-month me-2"></i>Doanh thu Th√°ng n√†y</h4>
                        <div class="revenue-value" id="monthly-revenue">
                            <div class="loading-placeholder">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            </div>
                        </div>
                        <small style="opacity: 0.8;">C·∫≠p nh·∫≠t: <span id="update-time-monthly">--</span></small>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card stats-card card-info shadow">
                    <div class="card-body position-relative">
                        <div class="icon-wrapper">
                            <i class="bi bi-calendar-year"></i>
                        </div>
                        <h4><i class="bi bi-calendar-year me-2"></i>Doanh thu NƒÉm nay</h4>
                        <div class="revenue-value" id="yearly-revenue">
                            <div class="loading-placeholder">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            </div>
                        </div>
                        <small style="opacity: 0.8;">C·∫≠p nh·∫≠t: <span id="update-time-yearly">--</span></small>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-cards">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card info-card">
                        <div class="card-header">
                            <i class="bi bi-bar-chart-line-fill me-2"></i>Th·ªëng k√™ nhanh
                        </div>
                        <div class="card-body">
                            <div class="quick-stats">
                                <div class="quick-stat-item">
                                    <div class="label">Trung b√¨nh/Ng√†y</div>
                                    <div class="value" id="avg-daily">--</div>
                                </div>
                                <div class="quick-stat-item">
                                    <div class="label">Trung b√¨nh/Th√°ng</div>
                                    <div class="value" id="avg-monthly">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="card info-card">
                        <div class="card-header">
                            <i class="bi bi-trophy-fill me-2"></i>Hi·ªáu su·∫•t
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <strong>M·∫πo:</strong> Doanh thu th√°ng n√†y ƒëang cao h∆°n trung b√¨nh! Ti·∫øp t·ª•c ph√°t huy nh√©! üöÄ
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card info-card">
                <div class="card-header">
                    <i class="bi bi-graph-up me-2"></i>Bi·ªÉu ƒë·ªì Doanh thu
                </div>
                <div class="card-body">
                    <div class="chart-tabs">
                        <button class="chart-tab active" onclick="switchChart('daily')">
                            <i class="bi bi-calendar-day me-1"></i>7 Ng√†y
                        </button>
                        <button class="chart-tab" onclick="switchChart('monthly')">
                            <i class="bi bi-calendar-month me-1"></i>12 Th√°ng
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts_body">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // === (Existing code...) ===
        const token = localStorage.getItem('jwtToken');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const errorMessageText = document.getElementById('errorMessageText');
        const revenueCards = document.getElementById('revenueCards');
        const dailyRevenueEl = document.getElementById('daily-revenue');
        const monthlyRevenueEl = document.getElementById('monthly-revenue');
        const yearlyRevenueEl = document.getElementById('yearly-revenue');

        let revenueChart = null;
        let currentChartType = 'daily';

        const formatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        });

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        }
        
        // ... (existing functions: fetchDailyChartData, fetchMonthlyChartData, generateFallbackDailyData, generateFallbackMonthlyData, initChart, switchChart, fetchRevenueStats) ...
        // (Keeping existing functions as they are)

        async function fetchDailyChartData(days = 7) {
            try {
                const response = await fetch(`/api/vendor/stats/revenue/daily?days=${days}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu bi·ªÉu ƒë·ªì ng√†y');
                
                const data = await response.json();
                const labels = data.map(item => item.formattedDate || item.date);
                const revenues = data.map(item => item.revenue);
                
                return { labels, data: revenues };
            } catch (error) {
                console.error('Error fetching daily chart data:', error);
                return generateFallbackDailyData();
            }
        }
        async function fetchMonthlyChartData(months = 12) {
            try {
                const response = await fetch(`/api/vendor/stats/revenue/monthly?months=${months}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu bi·ªÉu ƒë·ªì th√°ng');
                
                const data = await response.json();
                const labels = data.map(item => item.formattedMonth || `${item.month}/${item.year}`);
                const revenues = data.map(item => item.revenue);
                
                return { labels, data: revenues };
            } catch (error) {
                console.error('Error fetching monthly chart data:', error);
                return generateFallbackMonthlyData();
            }
        }
        function generateFallbackDailyData() {
            const labels = [];
            const data = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
                data.push(0);
            }
            return { labels, data };
        }
        function generateFallbackMonthlyData() {
            const labels = [];
            const data = [];
            const today = new Date();
            for (let i = 11; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                labels.push(date.toLocaleDateString('vi-VN', { month: '2-digit', year: 'numeric' }));
                data.push(0);
            }
            return { labels, data };
        }
        function initChart(labels, data, label) {
            const ctx = document.getElementById('revenueChart');
            if (revenueChart) {
                revenueChart.destroy();
            }
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(102, 126, 234)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) { return formatter.format(context.parsed.y); }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('vi-VN', {
                                        notation: 'compact',
                                        compactDisplay: 'short'
                                    }).format(value) + ' ‚Ç´';
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
        window.switchChart = async function(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.chart-tab').classList.add('active');
            let chartData;
            if (type === 'daily') {
                chartData = await fetchDailyChartData(7);
                initChart(chartData.labels, chartData.data, 'Doanh thu (‚Ç´)');
            } else {
                chartData = await fetchMonthlyChartData(12);
                initChart(chartData.labels, chartData.data, 'Doanh thu (‚Ç´)');
            }
        };
        async function fetchRevenueStats() {
            if (!token) {
                window.location.href = '/login';
                return;
            }
            loadingIndicator.classList.remove('d-none');
            errorMessage.classList.add('d-none');
            revenueCards.classList.add('d-none');
            dailyRevenueEl.innerHTML = '<div class="loading-placeholder"><span class="spinner-border spinner-border-sm" role="status"></span></div>';
            monthlyRevenueEl.innerHTML = '<div class="loading-placeholder"><span class="spinner-border spinner-border-sm" role="status"></span></div>';
            yearlyRevenueEl.innerHTML = '<div class="loading-placeholder"><span class="spinner-border spinner-border-sm" role="status"></span></div>';
            const apiUrl = '/api/vendor/stats/revenue';
            console.log(`Fetching revenue stats from: ${apiUrl}`);
            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                if (!response.ok) {
                    let errorMsg = `L·ªói ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = `(${response.status}) ${errorData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`;
                    } catch (e) {
                        errorMsg = `L·ªói ${response.status}: ${await response.text()}`;
                    }
                    throw new Error(errorMsg);
                }
                const revenueData = await response.json();
                console.log("Revenue data received:", revenueData);
                const daily = revenueData.daily ?? 0;
                const monthly = revenueData.monthly ?? 0;
                const yearly = revenueData.yearly ?? 0;
                dailyRevenueEl.textContent = formatter.format(daily);
                monthlyRevenueEl.textContent = formatter.format(monthly);
                yearlyRevenueEl.textContent = formatter.format(yearly);
                const currentTime = getCurrentTime();
                document.getElementById('update-time-daily').textContent = currentTime;
                document.getElementById('update-time-monthly').textContent = currentTime;
                document.getElementById('update-time-yearly').textContent = currentTime;
                const avgDaily = monthly / 30;
                const avgMonthly = yearly / 12;
                document.getElementById('avg-daily').textContent = formatter.format(avgDaily);
                document.getElementById('avg-monthly').textContent = formatter.format(avgMonthly);
                loadingIndicator.classList.add('d-none');
                revenueCards.classList.remove('d-none');
                const chartData = await fetchDailyChartData(7);
                initChart(chartData.labels, chartData.data, 'Doanh thu (‚Ç´)');
            } catch (error) {
                console.error("Error fetching revenue stats:", error);
                loadingIndicator.classList.add('d-none');
                errorMessageText.textContent = `L·ªói: ${error.message}`;
                errorMessage.classList.remove('d-none');
                dailyRevenueEl.textContent = 'L·ªói';
                monthlyRevenueEl.textContent = 'L·ªói';
                yearlyRevenueEl.textContent = 'L·ªói';
            }
        }
        
        // === ADDED: Excel Export Functions ===

        // Helper function to fetch API data for Excel
        async function fetchApiData(url) {
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) return []; // Return empty array on error
                return await response.json();
            } catch (err) {
                console.error(`L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ ${url}:`, err);
                return [];
            }
        }

        // G·∫Øn s·ª± ki·ªán click cho n√∫t
        document.getElementById('export-excel-btn').addEventListener('click', () => {
            const btn = document.getElementById('export-excel-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang xu·∫•t...';

            exportVendorStatsToExcel().finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-file-earmark-excel"></i> Xu·∫•t Excel';
            });
        });

        // Main Excel Export Function
        async function exportVendorStatsToExcel() {
            console.log("ƒêang chu·∫©n b·ªã d·ªØ li·ªáu Excel cho Vendor...");

            // 1. Fetch all data concurrently
            const [overviewData, dailyData, monthlyData] = await Promise.all([
                fetchApiData('/api/vendor/stats/revenue'),
                fetchApiData('/api/vendor/stats/revenue/daily?days=30'), // L·∫•y 30 ng√†y cho chi ti·∫øt
                fetchApiData('/api/vendor/stats/revenue/monthly?months=12') // L·∫•y 12 th√°ng
            ]);

            // 2. Prepare data for sheets
            // Sheet 1: T·ªïng quan
            const overviewSheetData = [
                {"Ch·ªâ s·ªë": "Doanh thu H√¥m nay", "Gi√° tr·ªã": overviewData.daily ? formatter.format(overviewData.daily) : '0 ƒë'},
                {"Ch·ªâ s·ªë": "Doanh thu Th√°ng n√†y", "Gi√° tr·ªã": overviewData.monthly ? formatter.format(overviewData.monthly) : '0 ƒë'},
                {"Ch·ªâ s·ªë": "Doanh thu NƒÉm nay", "Gi√° tr·ªã": overviewData.yearly ? formatter.format(overviewData.yearly) : '0 ƒë'}
            ];

            // Sheet 2: Doanh thu h√†ng ng√†y (30 ng√†y)
            const dailySheetData = dailyData.map(item => ({
                "Ng√†y": item.formattedDate || item.date,
                "Doanh thu (VNƒê)": item.revenue
            }));

            // Sheet 3: Doanh thu h√†ng th√°ng (12 th√°ng)
            const monthlySheetData = monthlyData.map(item => ({
                "Th√°ng": item.formattedMonth || `${item.month}/${item.year}`,
                "Doanh thu (VNƒê)": item.revenue
            }));

            // 3. Create worksheets
            const ws_overview = XLSX.utils.json_to_sheet(overviewSheetData);
            const ws_daily = XLSX.utils.json_to_sheet(dailySheetData);
            const ws_monthly = XLSX.utils.json_to_sheet(monthlySheetData);

            // 4. Set column widths
            ws_overview['!cols'] = [{ wch: 25 }, { wch: 20 }];
            ws_daily['!cols'] = [{ wch: 15 }, { wch: 20 }];
            ws_monthly['!cols'] = [{ wch: 15 }, { wch: 20 }];

            // 5. Create workbook and append sheets
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws_overview, "T·ªïng quan Doanh thu");
            XLSX.utils.book_append_sheet(wb, ws_daily, "Doanh thu 30 ng√†y");
            XLSX.utils.book_append_sheet(wb, ws_monthly, "Doanh thu 12 th√°ng");

            // 6. Write and download file
            const filename = `DoanhThu_Shop_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            console.log("Xu·∫•t file Excel th√†nh c√¥ng!");
        }
        // === END ADDED ===

        document.addEventListener('DOMContentLoaded', fetchRevenueStats);
    </script>
</th:block>

</body>
</html>