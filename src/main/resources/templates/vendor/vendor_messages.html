<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_vendor_layout}">
<head>
    <title>Tương tác Khách hàng (Mô phỏng)</title>
    <style>
        /* CSS giữ nguyên như phiên bản trước đó bạn đã có */
        .chat-container {
            display: flex;
            height: 70vh; /* Điều chỉnh chiều cao nếu cần */
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: #fff; /* Nền trắng cho toàn bộ container */
        }
        .conversations-list {
            width: 30%; /* Tăng chiều rộng một chút */
            border-right: 1px solid #ddd;
            overflow-y: auto;
            background-color: #f8f9fa; /* Nền xám nhạt cho danh sách */
        }
        .chat-window {
            width: 70%;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1.5rem; /* Tăng padding */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Tăng khoảng cách giữa tin nhắn */
            background-color: #fff; /* Nền trắng cho khu vực tin nhắn */
        }
        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 0.75rem; /* Tăng khoảng cách */
            background-color: #f8f9fa; /* Nền xám nhạt */
            align-items: center; /* Căn giữa các item */
        }
        .chat-input-area input {
            flex-grow: 1; /* Input chiếm phần lớn không gian */
            border-radius: 20px; /* Bo tròn ô input */
            border: 1px solid #ced4da;
            padding: 0.5rem 1rem;
        }
        .chat-input-area button {
            flex-shrink: 0; /* Nút không bị co lại */
            border-radius: 50%; /* Nút tròn */
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message {
            padding: 0.6rem 1.1rem; /* Điều chỉnh padding */
            border-radius: 1.25rem;
            max-width: 75%; /* Tăng độ rộng tối đa */
            word-wrap: break-word;
            line-height: 1.5; /* Tăng khoảng cách dòng */
        }
        .message.sent {
            background-color: #0d6efd; /* Màu xanh dương đậm hơn */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem; /* Bo góc dưới bên phải */
        }
        .message.received {
            background-color: #e9ecef; /* Màu xám nhạt */
            color: #212529;
            align-self: flex-start;
            border-bottom-left-radius: 0.5rem; /* Bo góc dưới bên trái */
        }
        /* Style cho tin nhắn hệ thống */
        .message.system {
            background-color: #fff3cd;
            color: #664d03;
            align-self: center;
            font-size: 0.8rem;
            font-style: italic;
            border: 1px dashed #ffeeba;
            max-width: 90%;
            text-align: center;
        }
        .conversation-item {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0; /* Border nhạt hơn */
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative; /* Cho badge */
        }
        .conversation-item:hover {
            background-color: #e9ecef;
        }
        .conversation-item.active {
            background-color: #cfe2ff; /* Màu xanh nhạt khi active */
            font-weight: bold; /* In đậm tên khi active */
        }
        .conversation-item .name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #333; /* Màu chữ đậm hơn */
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
             display: block; /* Đảm bảo ellipsis hoạt động */
             max-width: calc(100% - 30px); /* Chừa chỗ cho badge (nếu có) */
        }
        .conversation-item .last-message {
            font-size: 0.85rem;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; /* Đảm bảo ellipsis hoạt động */
            max-width: 100%;
        }
        /* Bỏ badge unread vì đây là mô phỏng */
        /*.conversation-item .unread-badge { ... } */

        /* Bỏ phần status indicator vì không kết nối WebSocket */
        /* .status-indicator { ... } */
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2"><i class="bi bi-chat-dots-fill me-2"></i>Tương tác Khách hàng (Mô phỏng)</h1>
        <span class="badge bg-info fs-6">Chế độ Mô phỏng</span> </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="chat-container">
                <div class="conversations-list">
                    <div class="p-3 border-bottom fw-bold d-flex justify-content-between align-items-center bg-light">
                        <span>Chọn Kịch bản</span>
                        </div>
                    <div id="conversationsList">
                        <div class="p-3 text-muted small text-center">
                            Đang tải kịch bản...
                        </div>
                    </div>
                </div>

                <div class="chat-window">
                    <div class="p-3 border-bottom fw-bold bg-light" id="chat-partner-name">
                        <i class="bi bi-person-circle me-1"></i> (Chọn một kịch bản)
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="message system">Vui lòng chọn một kịch bản từ danh sách bên trái.</div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="messageInput" class="form-control" placeholder="Nhập câu trả lời của bạn..." disabled>
                        <button id="sendButton" class="btn btn-primary" disabled title="Gửi trả lời">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts_body">
    <script>
        // === DOM Elements ===
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const conversationsList = document.getElementById('conversationsList');
        const chatPartnerName = document.getElementById('chat-partner-name');

        // === Kịch bản Hội thoại ===
        const conversationScripts = {
            'hoi_hang': {
                name: 'Khách hỏi hàng', // Tên hiển thị
                messages: [
                    { sender: 'customer', text: 'Chào shop, tôi muốn hỏi về sản phẩm Áo Thun ABC.' },
                    { sender: 'customer', text: 'Mẫu này còn màu xanh size L không ạ?' },
                    { sender: 'customer', text: 'Ok shop, tôi đặt 1 cái nhé. Giao về địa chỉ XYZ.' },
                    { sender: 'customer', text: 'Cảm ơn shop nhiều!' }
                ]
            },
            'hoi_don_hang': {
                 name: 'Khách hỏi đơn hàng',
                 messages: [
                    { sender: 'customer', text: 'Shop ơi, đơn hàng #567 của tôi đặt hôm qua đã gửi chưa?' },
                    { sender: 'customer', text: 'Dự kiến khi nào tôi nhận được hàng vậy?' },
                    { sender: 'customer', text: 'Vâng, tôi cảm ơn.' }
                 ]
            },
            'khieu_nai': {
                 name: 'Khách khiếu nại',
                 messages: [
                    { sender: 'customer', text: 'Shop ơi, tôi mới nhận được hàng nhưng sản phẩm bị lỗi.' },
                    { sender: 'customer', text: 'Cái áo khoác tôi mua bị rách ở tay áo.' },
                    { sender: 'customer', text: 'Shop xem xử lý đổi hàng cho tôi được không?' }
                 ]
            }
        };

        // === State Variables ===
        let currentScript = null; // Kịch bản đang chạy { name: '...', messages: [...] }
        let currentMessageIndex = 0; // Index của tin nhắn customer tiếp theo

        // === Helper Functions ===

        // Thêm tin nhắn vào cửa sổ chat (Giữ nguyên)
        function addMessage(type, content) {
            if (!chatMessages) return;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`; // type là 'sent', 'received', hoặc 'system'
            let formattedContent = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            messageDiv.innerHTML = formattedContent;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Tải danh sách các kịch bản mô phỏng
        function loadSimulatedConversations() {
            if (!conversationsList) return;
            conversationsList.innerHTML = ''; // Xóa nội dung cũ

            if (!conversationScripts || Object.keys(conversationScripts).length === 0) {
                conversationsList.innerHTML = '<div class="p-3 text-muted small text-center">Không có kịch bản nào được định nghĩa.</div>';
                return;
            }

            console.log("Loading conversation scripts...");
            for (const scriptKey in conversationScripts) {
                const scriptData = conversationScripts[scriptKey];
                const firstMessage = scriptData.messages[0]?.text || '...';
                const displayName = scriptData.name || `Kịch bản ${scriptKey}`; // Lấy tên hiển thị

                conversationsList.innerHTML += `
                    <div class="conversation-item"
                         onclick="startScriptedConversation('${scriptKey}', '${displayName}')">
                        <div class="name">${displayName}</div>
                        <div class="last-message">${firstMessage}</div>
                    </div>
                `;
            }
        }

        // Bắt đầu một kịch bản hội thoại
        window.startScriptedConversation = function(scriptKey, partnerName) {
            console.log(`Starting script: ${scriptKey}`);
            currentScript = conversationScripts[scriptKey];
            if (!currentScript) {
                console.error("Kịch bản không tồn tại:", scriptKey);
                addMessage('system', 'Lỗi: Không tìm thấy kịch bản hội thoại.');
                chatPartnerName.innerHTML = `<i class="bi bi-person-circle me-1"></i> (Lỗi kịch bản)`;
                messageInput.disabled = true;
                sendButton.disabled = true;
                return;
            }

            currentMessageIndex = 0; // Reset index
            chatMessages.innerHTML = ''; // Xóa tin nhắn cũ
            chatPartnerName.innerHTML = `<i class="bi bi-person-circle me-1"></i> ${partnerName} (Mô phỏng)`; // Cập nhật tên partner

            // Hiển thị tin nhắn customer đầu tiên
            displayNextCustomerMessage();

            // Kích hoạt ô nhập liệu và nút gửi
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = `Trả lời ${partnerName}...`;
            messageInput.focus();

            // Highlight kịch bản đang chọn
            document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
            const scriptItem = document.querySelector(`.conversation-item[onclick*="'${scriptKey}'"]`);
            if (scriptItem) scriptItem.classList.add('active');
        }

        // Hiển thị tin nhắn tiếp theo của Customer từ kịch bản
        function displayNextCustomerMessage() {
            if (currentScript && currentMessageIndex < currentScript.messages.length) {
                const message = currentScript.messages[currentMessageIndex];
                if (message.sender === 'customer') {
                    // Giả lập độ trễ nhỏ để giống thật hơn
                    messageInput.disabled = true; // Vô hiệu hóa input trong khi customer "gõ"
                    sendButton.disabled = true;
                     addMessage('system', 'Khách hàng đang trả lời...'); // Thông báo nhỏ
                    setTimeout(() => {
                        // Xóa thông báo "đang trả lời"
                        const systemMsgs = chatMessages.querySelectorAll('.message.system');
                        if(systemMsgs.length > 0) systemMsgs[systemMsgs.length - 1].remove();

                        addMessage('received', message.text); // Hiển thị tin nhắn customer
                        messageInput.disabled = false; // Bật lại input
                        sendButton.disabled = false;
                        messageInput.focus();
                    }, Math.random() * 1500 + 500); // Chờ ngẫu nhiên 0.5 - 2 giây
                    currentMessageIndex++;
                } else {
                    // Nếu kịch bản có cả tin nhắn vendor (ít dùng) thì bỏ qua
                    console.warn("Kịch bản chứa tin nhắn Vendor, bỏ qua:", message);
                    currentMessageIndex++;
                    displayNextCustomerMessage(); // Gọi lại để lấy tin nhắn customer tiếp theo
                }
            } else {
                 console.log("Kết thúc kịch bản.");
                 setTimeout(() => {
                    addMessage('system', 'Kết thúc kịch bản mô phỏng.');
                 }, 700);
                 messageInput.disabled = true; // Vô hiệu hóa input khi hết kịch bản
                 sendButton.disabled = true;
                 messageInput.placeholder = 'Kịch bản đã kết thúc.';
            }
        }

        // Xử lý khi Vendor gửi câu trả lời
        function handleVendorResponse() {
            if (!messageInput || messageInput.disabled || !currentScript) return; // Kiểm tra nếu đang trong kịch bản

            const vendorText = messageInput.value.trim();
            if (vendorText === '') return; // Không gửi tin nhắn rỗng

            // 1. Hiển thị tin nhắn của Vendor
            addMessage('sent', vendorText);
            messageInput.value = ''; // Xóa ô nhập
            messageInput.focus(); // Focus lại ô nhập

            // 2. Kích hoạt hiển thị tin nhắn tiếp theo của Customer
            displayNextCustomerMessage();

            // 3. (Tùy chọn) Lưu tin nhắn Vendor vào đâu đó nếu cần (ví dụ: LocalStorage, hoặc gọi API)
            // console.log("Vendor response:", vendorText);
        }

        // === Event Listeners ===
        sendButton.addEventListener('click', handleVendorResponse);
        messageInput.addEventListener('keypress', function(e) {
            // Gửi khi nhấn Enter (không gửi khi nhấn Shift+Enter)
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Ngăn hành vi mặc định (xuống dòng)
                handleVendorResponse();
            }
        });

        // === Initial Load ===
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Initializing Simulated Chat...");
            // Không cần lấy token hay User ID vì đây là mô phỏng
            loadSimulatedConversations(); // Tải danh sách kịch bản

            // Thiết lập trạng thái ban đầu
            messageInput.disabled = true;
            sendButton.disabled = true;
            messageInput.placeholder = 'Chọn kịch bản để bắt đầu...';
        });

        // === Cleanup (Không cần thiết vì không có kết nối WebSocket) ===
        // window.addEventListener('beforeunload', () => { ... });

    </script>
</th:block>

</body>
</html>